# Changelog

All notable changes to the Leadgen Pipeline project.

## [Unreleased]

### Changed
- **Entity Detail Cleanup** (BL-046): Restructure CompanyDetail and ContactDetail views per enrichment field audit
  - Company: Rename "Pipeline" section to "CRM", remove deprecated status/crm_status/cohort fields
  - Company: Replace "Scores" with "Key Metrics" (triage_score, verified_revenue, verified_employees)
  - Company: Surface growth_indicators, job_posting_count, media_sentiment, press_releases, thought_leadership, insolvency_details from L2 enrichment modules
  - Company: Move L1 triage metadata (confidence, quality_score, qc_flags) to History tab
  - Contact: Move scores to Enrichment tab with source attribution, add Career & Social section
  - Contact: Add employment_status/employment_verified_at to Contact Info
  - Contact: Remove deprecated status flags (processed_enrich, email_lookup, duplicity_*) from History tab
  - Both: Add stage_completions to API responses for DAG-based enrichment timeline
  - Both: Add Costs & Quality section and last_enriched_at to History tab
  - EnrichmentTimeline: Color-coded dots (green=completed, red=failed, gray=skipped) with error display

### Added
- **Entity Selection & Bulk Actions**: Multi-select contacts/companies with bulk operations
  - DataTable: checkbox column, shift-click range selection, select-all-loaded, select-all-matching-filters
  - SelectionActionBar: floating bottom toolbar showing count + action buttons (slide-up animation)
  - Bulk Add Tags: tag multiple entities at once via TagPicker modal (with inline tag creation)
  - Bulk Assign Campaign: assign selected contacts to a campaign via CampaignPicker modal
  - Bulk Remove Tags: remove tag assignments from selected entities
  - Multi-tag data model: junction tables (contact_tag_assignments, company_tag_assignments) replacing single FK
  - Matching count endpoints: server-side count for "select all matching filters" mode
  - Tags API: GET returns IDs for frontend reference, POST creates new tags inline
  - Tag display: columns show comma-separated tag names (multi-tag aware)
  - Keyboard: Escape clears selection
  - Migration 025 (multi_tag): junction tables with data migration from legacy FK
  - 14 new unit tests for bulk endpoints
- **Vanilla JS Migration** (BL-045/TD-008): Eliminate all vanilla JS from the dashboard
  - Port Import page to React: 3-step wizard (Upload → Map Columns → Preview), CSV + Google OAuth dual-source, AI column mapping, dedup preview, past imports with resume
  - Port Admin page to React: namespace CRUD (super_admin), user management per namespace, inline editing, temp password display
  - New reusable UI components: Modal, WizardSteps, ProgressBar
  - `apiUpload` function for FormData file uploads (multipart)
  - Enhanced placeholder pages (Playbook, Echo, LLM Costs) with page-specific descriptions
  - All navigation is SPA (React Router) — no more full-page reloads

### Removed
- 14 vanilla HTML/JS/CSS files (12,012 lines): admin.html, import.html, contacts.html, companies.html, messages.html, enrich.html, index.html, llm-costs.html, echo.html, playbook.html, pipeline-archive.html, auth.js, nav.js, nav.css
- `isExternal` hack from AppNav.tsx — all nav links now use React Router `<Link>`
- Vanilla page loop from deploy-dashboard.sh — simplified to React-only + roadmap.html
- **Enrichment Field Audit** (BL-045): Restructure enrichment data model for modularity and extensibility
  - Rename `batches` → `tags` across entire codebase (models, API, frontend, tests — 41 files)
  - New `company_enrichment_l1` table: triage_notes, pre_score, research_query, raw_response, confidence, quality_score, qc_flags
  - Split `company_enrichment_l2` into 4 module tables: profile, signals, market, opportunity
  - Expand `contact_enrichment` with scoring fields (ai_champion, authority_score) and gap fields (career_trajectory, publications, social handles)
  - L1 enricher dual-writes to both companies table and company_enrichment_l1
  - Company/contact detail API endpoints JOIN new enrichment tables with backward-compat fallback
  - Stage registry STAGE_FIELDS updated to reference new tables
  - 5 new company fields (website_url, linkedin_url, logo_url, last_enriched_at, data_quality_score)
  - 3 new contact fields (last_enriched_at, employment_verified_at, employment_status)
  - Migrations 019-024 (Phase D migration 024 deferred — requires 1-week verification period)
- **Campaign System Phase 1** (BL-031 through BL-036, ADR-006): Full outreach engine — create campaigns, assign contacts, configure templates, generate AI messages, review on Messages page
  - **BL-031**: Migration 018 (campaigns extended, campaign_contacts, campaign_templates with 3 system presets), SQLAlchemy models, campaign CRUD API, CampaignsPage under Reach pillar. 19 tests.
  - **BL-032**: Campaign contacts API — add by contact IDs or company IDs, remove, list with enrichment data. Duplicate detection, total_contacts auto-update. ContactPicker overlay with search + multi-select. CampaignDetail with entity stack navigation. 12 tests.
  - **BL-033**: Template presets (LinkedIn + Email, Email 3-Step, LinkedIn Only). Step toggle, tone selector (professional/casual/bold/empathetic), custom instructions. TemplateSelector + StepConfigurator in CampaignDetail.
  - **BL-034**: Enrichment readiness check — queries entity_stage_completions per campaign contact. Returns per-contact readiness (ready/needs_l1/needs_l2/needs_person), summary counts, cost estimate. 5 tests.
  - **BL-035**: Message generation engine — background thread generates messages via Claude Haiku API per contact × enabled step. Channel-specific prompts (LinkedIn 300 chars, email with subject). Cost estimation, LLM logging, progress tracking. Campaign status transitions (ready → generating → review). 7 tests.
  - **BL-036**: Campaign filter on Messages page — campaign_id query param on GET /api/messages, Campaign dropdown in FilterBar, useMessages hook updated. 2 tests.
  - Total: 47 new unit tests, all passing
- **Enrichment DAG Model** (BL-015, BL-016, ADR-005): Replace linear `company.status` routing with DAG-based stage completion tracking
  - `entity_stage_completions` table: per-entity, per-stage completion records with cost and error tracking (migration 016)
  - Stage registry (`stage_registry.py`): 11 configurable stages with hard/soft dependencies, country gates, execution modes
  - DAG executor (`dag_executor.py`): eligibility builder replacing hardcoded `ELIGIBILITY_QUERIES`, cross-entity-type dependency resolution, country-gate auto-skip, reactive polling threads
  - QC checker (`qc_checker.py`): end-of-pipeline quality checks — registry name mismatch, HQ country conflict, active insolvency, dissolved status, data completeness, low registry confidence
  - Interactive DAG dashboard (`enrich.html`): 2-step wizard with column-based DAG visualization, SVG bezier edges, 6 node states, soft dependency toggles, 5s polling
  - API endpoints: `POST /pipeline/dag-run`, `GET /pipeline/dag-status`, `POST /pipeline/dag-stop`
  - Backward compatible: old `/pipeline/start` and `/enrich/start` endpoints still work
  - 88 new unit tests (stage registry, completions model, DAG executor, QC checker)
- **Unified Registry Module** (ADR-005): Merged 5 separate registry stages (ares, brreg, prh, recherche, isir) into single `registry` stage
  - `RegistryOrchestrator`: Auto-detects applicable registers from hq_country/domain, runs adapters in dependency order
  - `IsirAdapter`: Wraps standalone ISIR functions as supplementary adapter (depends on CZ/ARES for ICO)
  - Adapter capability metadata: `provides_fields`, `requires_inputs`, `depends_on`, `is_supplementary`
  - Credibility scorer (0-100): 6 weighted components (registration, status, insolvency, history, completeness, directors)
  - `company_legal_profile` table: Unified storage for all registry + insolvency + credibility data (migration 016)
  - Promoted columns on `companies`: official_name, tax_id, legal_form, registration_status, date_established, has_insolvency, credibility_score
  - Legacy aliases: old stage names (`ares`, `brreg`, etc.) transparently resolve to `registry`
  - Dashboard: Single "Legal & Registry" card replaces 5 package cards, credibility badge on company detail
  - Data migration script: `scripts/migrate_registry_to_legal_profile.py` (idempotent backfill)
  - 47 new tests (credibility scorer, orchestrator, route updates)
- **Native L1 Enrichment** (ADR-003): Company enrichment via Perplexity sonar API, replacing n8n webhook
  - `l1_enricher.py`: Domain resolution, Perplexity API call, JSON parsing, field mapping, QC validation
  - 8 QC checks: name mismatch, incomplete research, revenue/employee sanity, low confidence, B2B unclear, short summary, source warning
  - Contact LinkedIn URLs passed to Perplexity for better company identification
  - Companies routed to `triage_passed` (clean) or `needs_review` (flagged) or `enrichment_failed` (error)
  - Research data stored in `research_assets` table with confidence/quality scores
  - Cost tracked in `llm_usage_log` with Perplexity pricing ($1/1M tokens)
  - Pipeline engine hybrid dispatch: L1 runs native Python, L2/Person/Generate still via n8n
  - Review API: `GET /api/enrich/review` (list flagged companies), `POST /api/enrich/resolve` (approve/retry/skip)
  - Dashboard: L2/person/generate disabled with "Coming soon" badges, progress counters, ETA, inline review list
  - 105 unit tests (enricher) + 32 tests (enrich routes), spec, ADR-003
- **EU Registry Adapters** (BL-017 partial): Company registry enrichment from 4 EU government APIs, all free ($0.00/lookup)
  - **Registry adapter pattern** (`api/services/registries/`): `BaseRegistryAdapter` ABC with shared name matching (bigram Dice + legal suffix stripping), result storage, and pipeline dispatch. ADR-004.
  - **Czech ARES** (`ares` stage): ICO/DIC, legal form, directors, capital, NACE codes, insolvency via ares.gov.cz
  - **Norway BRREG** (`brreg` stage): organisasjonsnummer, legal form, NACE codes, capital, bankruptcy via data.brreg.no
  - **Finland PRH** (`prh` stage): Y-tunnus, company form, TOL codes, trade register status via avoindata.prh.fi
  - **France recherche** (`recherche` stage): SIREN, nature juridique, NAF codes, directors via api.gouv.fr
  - `company_registry_data` table with `registry_country` discriminator (migration 013)
  - Generic on-demand endpoint: `POST /api/companies/<id>/enrich-registry/<country>`
  - Dashboard: 4 registry modules in enrichment wizard
  - Backward-compatible import shim for existing `api/services/ares.py` references
  - 62 new tests (adapters + parsers + routes)
- **ISIR Insolvency Check** (BL-017 partial): Czech Insolvency Register via SOAP/XML CUZK web service
  - `api/services/registries/isir.py`: SOAP client for isir.justice.cz:8443, XML parsing, proceeding status mapping
  - `company_insolvency_data` table (migration 014): stores proceedings, active/historical status, case numbers, court info
  - Pipeline integration: `isir` stage in enrichment wizard, runs on Czech companies with ICO
  - 11 proceeding statuses mapped: pending, moratorium, insolvency_declared, bankruptcy, reorganization, debt_relief, etc.
  - Zero cost ($0.00/lookup), no authentication required
  - 27 unit tests covering SOAP parsing, query, enrichment, and storage
- **Gmail Contact Extraction** (BL-025 + BL-026): Google OAuth integration, Google Contacts import, and Gmail email scan
  - Google OAuth 2.0 flow with Fernet-encrypted token storage (`oauth_connections` table, migration 011)
  - Google Contacts import via People API — structured field mapping, flows into existing dedup engine
  - Gmail email scan — background thread parses message headers (From/To/CC), extracts signatures via batched Claude Haiku calls
  - OAuth routes: connect/disconnect Google accounts (`/api/oauth/*`)
  - Gmail routes: contacts fetch, scan start/status, dedup preview, execute import (`/api/gmail/*`)
  - Google import integrated as source tab on Import page (CSV / Google Account)
  - 82 new unit tests (google_oauth, google_contacts, gmail_routes, gmail_scanner)
- **LLM Cost Logging**: Per-call cost tracking for all LLM API usage with super admin dashboard
  - `llm_usage_log` table with tenant/user attribution, token counts, cost (NUMERIC 10,6), duration, metadata
  - Logger service with model-specific pricing (Sonnet, Haiku, Opus) and Decimal arithmetic
  - CSV column mapping (Claude API) instrumented with timing and usage extraction
  - Super admin API: `GET /api/llm-usage/summary` (aggregated totals, by_tenant, by_operation, time_series), `GET /api/llm-usage/logs` (paginated, filterable)
  - LLM Costs dashboard page with Chart.js charts (daily cost, cost by operation), breakdown table, recent calls
  - Migration 009, 21 new tests
- **Contact List Import** (BL-006): CSV upload with AI-powered column mapping, dedup preview, and batch import
  - AI column mapping via Claude API (Sonnet) with confidence scores and manual override (ADR-002)
  - Contact dedup: LinkedIn URL → email → name+company hierarchy, 3 strategies (skip/update/create_new)
  - Company dedup: domain → name matching, always links to existing
  - Import wizard page with 3-step flow: Upload → Map Columns → Preview & Import
  - `import_jobs` table tracking full import lifecycle (migration 007)
  - 5 API endpoints: upload, preview, execute, status, list
  - Import nav link added to all dashboard pages (editor+ role)
  - 80 new unit tests (csv_mapper, dedup, import routes)
- Companies & Contacts dashboard pages with infinite scroll and virtual DOM windowing (ADR-001)
- Virtual scroll: only ~60-80 DOM rows rendered at any time, constant performance regardless of dataset size
- Companies API routes: list (paginated, filterable), detail, PATCH update
- Contacts API routes: list (paginated, filterable), detail, PATCH update
- Pipeline API routes: start, stop, status, run-all, stop-all
- Architecture Decision Records (ADR) framework in `docs/adr/`
- Mandatory quality gates in CLAUDE.md: tests, code review, security audit, documentation, backlog, commit+push
- Project structure: CLAUDE.md rules, ARCHITECTURE.md, test infrastructure
- Git repository initialized with GitHub remote (`michallicko/leadgen`)
- Flask API: auth (login/refresh/me), tenants CRUD, users CRUD, messages CRUD, batches/stats
- Dashboard: Pipeline control, Messages review, Admin panel
- JWT authentication with bcrypt password hashing
- Namespace-based multi-tenancy with URL routing via Caddy
- Namespace switcher dropdown in nav (superadmin + multi-namespace users)
- PostgreSQL schema v1.0: 16 entity tables + 3 junction tables, ~30 enums, multi-tenant
- Identity tables: `users`, `user_tenant_roles` with role hierarchy (admin/editor/viewer)
- Seed migration for VisionVolve tenant and initial data
- Airtable record ID indexes for upsert operations during data migration
- Airtable-to-PostgreSQL migration script (`scripts/migrate_airtable_to_pg.py`)
- 37 unit tests covering auth, tenants, and users API routes
- SQLite test compatibility layer (PG types → SQLite for local testing)
- Deploy scripts for API (`deploy-api.sh`) and dashboard (`deploy-dashboard.sh`)

### Fixed
- Ambiguous SQLAlchemy joins on UserTenantRole (two FKs to users table)
- Missing `tenant_routes.py` in API deployments (file not copied by initial deploy)
- Password mismatch for seeded users (reset to known credentials)

### Infrastructure
- PostgreSQL `leadgen` database created on existing RDS instance
- Migrations 001-004 applied (schema, identity, seed, indexes)
- `leadgen-api` Docker container running on VPS (Gunicorn, port 5000)
- Caddy configured: `/api/*` → Flask, `/{namespace}/*` → static dashboard
- Dashboard deployed at `leadgen.visionvolve.com`
