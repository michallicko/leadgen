<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLM Costs â€” Leadgen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="nav.css">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0D0F14;
  --surface: #14171E;
  --surface-alt: #1A1E28;
  --border: rgba(110,44,139,0.15);
  --border-solid: #231D30;
  --text: #E8EAF0;
  --text-muted: #8B92A0;
  --text-dim: #5A6170;
  --accent: #6E2C8B;
  --accent-hover: #8B47A8;
  --accent-cyan: #00B8CF;
  --success: #34D399;
  --error: #F87171;
  --warning: #FBBF24;
  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
  --font-title: 'Lexend Deca', -apple-system, sans-serif;
  --font-body: 'Work Sans', -apple-system, sans-serif;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, #4A1D5E, #6E2C8B 40%, #00B8CF);
  z-index: 100;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(110,44,139,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(110,44,139,.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: -1;
}

.container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

h1 { font-family: var(--font-title); font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; letter-spacing: -0.01em; }

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.card:hover {
  border-color: rgba(110,44,139,0.25);
  box-shadow: 0 0 30px -10px rgba(110,44,139,0.12);
}

.card-title {
  font-family: var(--font-title); font-size: 0.85rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 16px;
}

/* Filter bar */
.filter-bar {
  display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  margin-bottom: 20px;
}
.filter-bar label { font-size: 0.82rem; color: var(--text-muted); }
.filter-bar input[type="date"] {
  background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius);
  color: var(--text); font-size: 0.82rem; padding: 6px 10px;
}
.filter-bar input[type="date"]:focus { outline: none; border-color: var(--accent); }

.btn {
  display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px;
  border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--surface-alt); color: var(--text); font-size: 0.82rem;
  cursor: pointer; transition: border-color var(--transition), background var(--transition);
}
.btn:hover { border-color: var(--accent); background: rgba(110,44,139,0.08); }
.btn-primary {
  background: linear-gradient(135deg, #6E2C8B, #4A1D5E); border-color: #6E2C8B;
  color: #fff; box-shadow: 0 2px 10px -2px rgba(110,44,139,0.3);
}
.btn-primary:hover { background: linear-gradient(135deg, #8B47A8, #6E2C8B); }
.btn-sm { padding: 4px 10px; font-size: 0.78rem; }
.btn.active { border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(0,184,207,0.08); }

/* Summary cards */
.summary-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.summary-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg);
  padding: 16px; text-align: center;
}
.summary-card .value {
  font-family: var(--font-title); font-size: 1.6rem; font-weight: 700;
  color: var(--accent-cyan); margin-bottom: 2px;
}
.summary-card .label { font-size: 0.78rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }

/* Charts row */
.charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
.chart-wrap { position: relative; height: 280px; }

/* Tables */
.data-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.data-table th {
  text-align: left; padding: 8px 10px; color: var(--text-muted); font-weight: 500;
  font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.04em;
  border-bottom: 1px solid var(--border);
}
.data-table td { padding: 8px 10px; border-bottom: 1px solid rgba(35,29,48,0.4); }
.data-table tr:hover td { background: rgba(110,44,139,0.04); }
.data-table .num { text-align: right; font-variant-numeric: tabular-nums; }

/* Expandable rows */
.expand-btn {
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  font-size: 0.82rem; padding: 2px 6px; border-radius: 4px;
}
.expand-btn:hover { color: var(--text); background: rgba(110,44,139,0.08); }
.child-row td { padding-left: 32px; }
.child-row td:first-child { padding-left: 40px; }

/* Pagination */
.pagination { display: flex; align-items: center; gap: 8px; margin-top: 12px; justify-content: center; }
.pagination .btn:disabled { opacity: 0.4; cursor: default; }
.pagination .page-info { font-size: 0.82rem; color: var(--text-muted); }

/* Mono values */
.mono { font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.82rem; }

/* Auth user */
.auth-user { margin-left: auto; display: flex; align-items: center; gap: 10px; font-size: 0.82rem; color: var(--text-muted); }
.auth-logout { background: none; border: none; color: var(--error); cursor: pointer; font-size: 0.78rem; }
.auth-logout:hover { text-decoration: underline; }

/* Loading */
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty { text-align: center; padding: 32px; color: var(--text-muted); font-size: 0.85rem; }

@media (max-width: 768px) {
  .summary-row { grid-template-columns: repeat(2, 1fr); }
  .charts-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body data-pillar="admin" data-page="llm-costs">

<div class="container">
  <div id="app-nav"></div>

  <h1>LLM Cost Tracking</h1>

  <!-- Date range filter -->
  <div class="filter-bar">
    <label>From</label>
    <input type="date" id="start_date">
    <label>To</label>
    <input type="date" id="end_date">
    <button class="btn btn-primary btn-sm" onclick="loadData()">Apply</button>
    <button class="btn btn-sm" onclick="setPreset(7)">7d</button>
    <button class="btn btn-sm" onclick="setPreset(30)">30d</button>
    <button class="btn btn-sm" onclick="setPreset(90)">90d</button>
  </div>

  <!-- Summary cards -->
  <div class="summary-row">
    <div class="summary-card">
      <div class="value" id="total_cost">$0.00</div>
      <div class="label">Total Cost</div>
    </div>
    <div class="summary-card">
      <div class="value" id="total_calls">0</div>
      <div class="label">Total Calls</div>
    </div>
    <div class="summary-card">
      <div class="value" id="avg_cost">$0.00</div>
      <div class="label">Avg Cost / Call</div>
    </div>
    <div class="summary-card">
      <div class="value" id="top_operation">-</div>
      <div class="label">Top Operation</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-row">
    <div class="card">
      <div class="card-title">Cost Over Time</div>
      <div class="chart-wrap"><canvas id="cost_chart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Cost by Operation</div>
      <div class="chart-wrap"><canvas id="op_chart"></canvas></div>
    </div>
  </div>

  <!-- Drill-down table -->
  <div class="card">
    <div class="card-title">Breakdown by Tenant</div>
    <table class="data-table" id="breakdown_table">
      <thead>
        <tr>
          <th></th>
          <th>Tenant</th>
          <th class="num">Calls</th>
          <th class="num">Input Tokens</th>
          <th class="num">Output Tokens</th>
          <th class="num">Cost</th>
        </tr>
      </thead>
      <tbody id="breakdown_body"></tbody>
    </table>
    <div class="empty" id="breakdown_empty" style="display:none;">No data for selected period.</div>
  </div>

  <!-- Recent calls -->
  <div class="card">
    <div class="card-title">Recent Calls</div>
    <table class="data-table" id="logs_table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Tenant</th>
          <th>Operation</th>
          <th>Model</th>
          <th class="num">In</th>
          <th class="num">Out</th>
          <th class="num">Cost</th>
          <th class="num">Duration</th>
        </tr>
      </thead>
      <tbody id="logs_body"></tbody>
    </table>
    <div class="empty" id="logs_empty" style="display:none;">No calls recorded yet.</div>
    <div class="pagination" id="logs_pagination" style="display:none;">
      <button class="btn btn-sm" id="prev_btn" onclick="changePage(-1)">Prev</button>
      <span class="page-info" id="page_info"></span>
      <button class="btn btn-sm" id="next_btn" onclick="changePage(1)">Next</button>
    </div>
  </div>
</div>

<script src="nav.js"></script>
<script src="auth.js"></script>
<script>
(function () {
  'use strict';

  var API = 'https://leadgen.visionvolve.com/api';
  var costChart = null;
  var opChart = null;
  var currentPage = 1;
  var perPage = 50;

  // ---- Helpers ----

  function authHeaders() {
    return { 'Authorization': 'Bearer ' + LeadgenAuth.getToken(), 'Content-Type': 'application/json' };
  }

  function apiFetch(path) {
    return fetch(API + path, { headers: authHeaders() }).then(function (r) {
      if (!r.ok) return r.json().then(function (d) { throw new Error(d.error || 'Request failed'); });
      return r.json();
    });
  }

  function fmtCost(v) {
    if (v >= 1) return '$' + v.toFixed(2);
    if (v >= 0.01) return '$' + v.toFixed(4);
    return '$' + v.toFixed(6);
  }

  function fmtNum(n) {
    if (n === null || n === undefined) return '-';
    return n.toLocaleString('en-US');
  }

  function fmtDate(iso) {
    if (!iso) return '-';
    var d = new Date(iso);
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ' ' +
           d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  }

  function shortModel(m) {
    if (!m) return '-';
    // "claude-sonnet-4-5-20250929" -> "sonnet-4.5"
    var parts = m.replace('claude-', '').split('-');
    if (parts.length >= 3) return parts[0] + '-' + parts[1] + '.' + parts[2];
    return m;
  }

  function clearChildren(node) {
    while (node.firstChild) node.removeChild(node.firstChild);
  }

  function el(tag, attrs, children) {
    var e = document.createElement(tag);
    if (attrs) {
      Object.keys(attrs).forEach(function (k) {
        if (k === 'textContent') e.textContent = attrs[k];
        else if (k === 'className') e.className = attrs[k];
        else if (k === 'onclick') e.onclick = attrs[k];
        else e.setAttribute(k, attrs[k]);
      });
    }
    if (children) children.forEach(function (c) { if (c) e.appendChild(c); });
    return e;
  }

  // ---- Date presets ----

  function toISODate(d) {
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  window.setPreset = function (days) {
    var end = new Date();
    var start = new Date();
    start.setDate(start.getDate() - days);
    document.getElementById('start_date').value = toISODate(start);
    document.getElementById('end_date').value = toISODate(end);
    loadData();
  };

  // ---- Data loading ----

  function getDateParams() {
    var s = document.getElementById('start_date').value;
    var e = document.getElementById('end_date').value;
    var params = [];
    if (s) params.push('start_date=' + s);
    if (e) params.push('end_date=' + e);
    return params;
  }

  window.loadData = function () {
    loadSummary();
    currentPage = 1;
    loadLogs();
  };

  function loadSummary() {
    var params = getDateParams();
    var qs = params.length ? '?' + params.join('&') : '';
    apiFetch('/llm-usage/summary' + qs).then(function (data) {
      renderSummary(data);
      renderCharts(data);
      renderBreakdown(data);
    }).catch(function (e) {
      console.error('Summary error:', e);
    });
  }

  function loadLogs() {
    var params = getDateParams();
    params.push('page=' + currentPage);
    params.push('per_page=' + perPage);
    var qs = '?' + params.join('&');
    apiFetch('/llm-usage/logs' + qs).then(function (data) {
      renderLogs(data);
    }).catch(function (e) {
      console.error('Logs error:', e);
    });
  }

  // ---- Rendering ----

  function renderSummary(data) {
    document.getElementById('total_cost').textContent = fmtCost(data.total_cost_usd);
    document.getElementById('total_calls').textContent = fmtNum(data.total_calls);

    var avg = data.total_calls > 0 ? data.total_cost_usd / data.total_calls : 0;
    document.getElementById('avg_cost').textContent = fmtCost(avg);

    var topOp = data.by_operation && data.by_operation.length > 0 ? data.by_operation[0].operation : '-';
    document.getElementById('top_operation').textContent = topOp.replace(/_/g, ' ');
  }

  function renderCharts(data) {
    // Cost over time
    var canvas1 = document.getElementById('cost_chart');
    if (costChart) costChart.destroy();

    var ts = data.time_series || [];
    var labels = ts.map(function (p) {
      var d = new Date(p.period);
      return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    });
    var costs = ts.map(function (p) { return p.cost; });

    costChart = new Chart(canvas1, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Cost ($)',
          data: costs,
          borderColor: '#00B8CF',
          backgroundColor: 'rgba(0,184,207,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointBackgroundColor: '#00B8CF'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#8B92A0', font: { size: 11 } }, grid: { color: 'rgba(110,44,139,0.1)' } },
          y: { ticks: { color: '#8B92A0', font: { size: 11 }, callback: function (v) { return '$' + v.toFixed(4); } }, grid: { color: 'rgba(110,44,139,0.1)' } }
        }
      }
    });

    // Cost by operation (bar)
    var canvas2 = document.getElementById('op_chart');
    if (opChart) opChart.destroy();

    var ops = data.by_operation || [];
    var opLabels = ops.map(function (o) { return o.operation.replace(/_/g, ' '); });
    var opCosts = ops.map(function (o) { return o.cost; });
    var barColors = ['#6E2C8B', '#00B8CF', '#34D399', '#FBBF24', '#F87171', '#8B47A8'];

    opChart = new Chart(canvas2, {
      type: 'bar',
      data: {
        labels: opLabels,
        datasets: [{
          label: 'Cost ($)',
          data: opCosts,
          backgroundColor: opLabels.map(function (_, i) { return barColors[i % barColors.length]; }),
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#8B92A0', font: { size: 11 } }, grid: { display: false } },
          y: { ticks: { color: '#8B92A0', font: { size: 11 }, callback: function (v) { return '$' + v.toFixed(4); } }, grid: { color: 'rgba(110,44,139,0.1)' } }
        }
      }
    });
  }

  function renderBreakdown(data) {
    var body = document.getElementById('breakdown_body');
    var empty = document.getElementById('breakdown_empty');
    clearChildren(body);

    var tenants = data.by_tenant || [];
    if (tenants.length === 0) {
      empty.style.display = '';
      return;
    }
    empty.style.display = 'none';

    // Group by_operation and by_model per tenant (we only have global breakdowns, so show tenant-level rows)
    tenants.forEach(function (t) {
      var tr = el('tr');
      tr.appendChild(el('td', {}, [el('span', { textContent: '', className: 'expand-btn' })]));
      tr.appendChild(el('td', { textContent: t.tenant_name + ' (' + t.tenant_slug + ')' }));
      tr.appendChild(el('td', { textContent: fmtNum(t.calls), className: 'num' }));
      tr.appendChild(el('td', { textContent: fmtNum(t.input_tokens), className: 'num' }));
      tr.appendChild(el('td', { textContent: fmtNum(t.output_tokens), className: 'num' }));
      tr.appendChild(el('td', { textContent: fmtCost(t.cost), className: 'num mono' }));
      body.appendChild(tr);
    });

    // Totals row
    var totalTr = el('tr', { style: 'font-weight:600;border-top:1px solid var(--border);' });
    totalTr.appendChild(el('td'));
    totalTr.appendChild(el('td', { textContent: 'Total' }));
    totalTr.appendChild(el('td', { textContent: fmtNum(data.total_calls), className: 'num' }));
    totalTr.appendChild(el('td', { textContent: fmtNum(data.total_input_tokens), className: 'num' }));
    totalTr.appendChild(el('td', { textContent: fmtNum(data.total_output_tokens), className: 'num' }));
    totalTr.appendChild(el('td', { textContent: fmtCost(data.total_cost_usd), className: 'num mono' }));
    body.appendChild(totalTr);
  }

  function renderLogs(data) {
    var body = document.getElementById('logs_body');
    var empty = document.getElementById('logs_empty');
    var pagination = document.getElementById('logs_pagination');
    clearChildren(body);

    var logs = data.logs || [];
    if (logs.length === 0 && data.total === 0) {
      empty.style.display = '';
      pagination.style.display = 'none';
      return;
    }
    empty.style.display = 'none';

    logs.forEach(function (log) {
      var tr = el('tr');
      tr.appendChild(el('td', { textContent: fmtDate(log.created_at), style: 'font-size:0.78rem;white-space:nowrap;' }));
      tr.appendChild(el('td', { textContent: log.tenant_slug || '-' }));
      tr.appendChild(el('td', { textContent: (log.operation || '').replace(/_/g, ' ') }));
      tr.appendChild(el('td', { textContent: shortModel(log.model), style: 'font-size:0.78rem;' }));
      tr.appendChild(el('td', { textContent: fmtNum(log.input_tokens), className: 'num' }));
      tr.appendChild(el('td', { textContent: fmtNum(log.output_tokens), className: 'num' }));
      tr.appendChild(el('td', { textContent: fmtCost(log.cost_usd), className: 'num mono' }));
      tr.appendChild(el('td', { textContent: log.duration_ms ? log.duration_ms + 'ms' : '-', className: 'num' }));
      body.appendChild(tr);
    });

    // Pagination
    var totalPages = Math.ceil(data.total / perPage);
    if (totalPages > 1) {
      pagination.style.display = '';
      document.getElementById('page_info').textContent = 'Page ' + currentPage + ' of ' + totalPages + ' (' + data.total + ' calls)';
      document.getElementById('prev_btn').disabled = currentPage <= 1;
      document.getElementById('next_btn').disabled = currentPage >= totalPages;
    } else {
      pagination.style.display = 'none';
    }
  }

  window.changePage = function (delta) {
    currentPage += delta;
    if (currentPage < 1) currentPage = 1;
    loadLogs();
  };

  // ---- Init ----

  function initPage() {
    var user = LeadgenAuth.getUser();
    if (!user || !user.is_super_admin) {
      var container = document.querySelector('.container');
      clearChildren(container);
      container.appendChild(el('div', { className: 'empty', textContent: 'Super admin access required.', style: 'margin-top:80px;' }));
      return;
    }

    // Default to last 30 days
    setPreset(30);
  }

  LeadgenAuth.init(initPage);
})();
</script>
</body>
</html>
