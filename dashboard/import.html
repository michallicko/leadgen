<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Import Contacts — Leadgen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0D0F14;
  --surface: #14171E;
  --surface-alt: #1A1E28;
  --border: rgba(110,44,139,0.15);
  --border-solid: #231D30;
  --text: #E8EAF0;
  --text-muted: #8B92A0;
  --text-dim: #5A6170;
  --accent: #6E2C8B;
  --accent-hover: #8B47A8;
  --accent-cyan: #00B8CF;
  --success: #34D399;
  --error: #F87171;
  --warning: #FBBF24;
  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
  --font-title: 'Lexend Deca', -apple-system, sans-serif;
  --font-body: 'Work Sans', -apple-system, sans-serif;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, #4A1D5E, #6E2C8B 40%, #00B8CF);
  z-index: 100;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(110,44,139,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(110,44,139,.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: -1;
}

.container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

h1 { font-family: var(--font-title); font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; letter-spacing: -0.01em; }

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
}

.card-title {
  font-family: var(--font-title);
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 16px;
}

select, input[type="text"] {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 12px;
  color: var(--text);
  font-size: 0.9rem;
  width: 100%;
  font-family: inherit;
  transition: border-color var(--transition);
}
select:focus, input[type="text"]:focus { outline: none; border-color: var(--accent); }
select option { background: var(--bg); color: var(--text); }

.form-row { margin-bottom: 14px; }
.form-row > label:first-child { display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 20px; border: none; border-radius: 6px;
  font-size: 0.9rem; font-weight: 600; cursor: pointer;
  transition: background var(--transition), opacity var(--transition);
}
.btn-primary { background: linear-gradient(135deg, #6E2C8B, #4A1D5E); color: #fff; }
.btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #8B47A8, #6E2C8B); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-sm { padding: 6px 14px; font-size: 0.8rem; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover:not(:disabled) { background: #3aa372; }
.btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
.btn-ghost:hover:not(:disabled) { background: var(--surface-alt); color: var(--text); }

/* Google sign-in button */
.btn-google {
  background: #fff; color: #3c4043; font-weight: 600;
  border: 1px solid #dadce0; border-radius: 6px; padding: 10px 20px;
  display: inline-flex; align-items: center; gap: 10px;
  cursor: pointer; transition: box-shadow 0.2s;
}
.btn-google:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
.btn-google svg { flex-shrink: 0; }

/* Top nav */
.top-nav {
  display: flex; align-items: center; gap: 8px;
  padding: 14px 0; margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
}
.top-nav__brand { display: flex; align-items: center; gap: 10px; }
.top-nav__title { font-family: var(--font-title); font-size: 1.05rem; font-weight: 700; color: var(--text); letter-spacing: -0.01em; }
.top-nav__links { display: flex; gap: 2px; margin-left: 24px; }
.top-nav__link {
  color: var(--text-muted); text-decoration: none;
  font-family: var(--font-body); font-size: 0.85rem; font-weight: 500;
  padding: 6px 14px; border-radius: 6px;
  transition: color 0.2s, background 0.2s;
}
.top-nav__link:hover { color: var(--text); background: rgba(110,44,139,0.08); }
.top-nav__link.active { color: var(--accent-cyan); font-weight: 600; background: rgba(0,184,207,0.08); }

/* Toast */
.toast-container { position: fixed; top: 16px; right: 16px; z-index: 300; display: flex; flex-direction: column; gap: 8px; }
.toast { padding: 12px 18px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; color: #fff; opacity: 0; transform: translateX(40px); transition: opacity 0.3s, transform 0.3s; max-width: 360px; }
.toast.show { opacity: 1; transform: translateX(0); }
.toast.success { background: var(--success); }
.toast.error { background: var(--error); }
.toast.info { background: var(--accent-cyan); }

.loading-sm { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ---- Import-specific styles ---- */

/* Wizard step indicator */
.wizard-steps {
  display: flex; gap: 0; margin-bottom: 24px; position: relative;
}
.wizard-step {
  flex: 1; display: flex; align-items: center; gap: 10px;
  padding: 14px 18px; position: relative;
  background: var(--surface); border: 1px solid var(--border);
  font-size: 0.82rem; color: var(--text-dim);
  transition: all 0.3s ease;
}
.wizard-step:first-child { border-radius: var(--radius-lg) 0 0 var(--radius-lg); }
.wizard-step:last-child { border-radius: 0 var(--radius-lg) var(--radius-lg) 0; }
.wizard-step:not(:first-child) { border-left: none; }
.wizard-step .step-num {
  width: 26px; height: 26px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-title); font-size: 0.75rem; font-weight: 700;
  background: var(--surface-alt); color: var(--text-dim);
  transition: all 0.3s ease;
  flex-shrink: 0;
}
.wizard-step .step-label { font-weight: 500; }
.wizard-step.active { color: var(--text); background: var(--surface-alt); }
.wizard-step.active .step-num { background: var(--accent); color: #fff; }
.wizard-step.done { color: var(--success); }
.wizard-step.done .step-num { background: rgba(52,211,153,0.15); color: var(--success); }

/* Source tabs */
.source-tabs {
  display: flex; gap: 0; margin-bottom: 16px;
}
.source-tab {
  flex: 1; padding: 12px 18px; text-align: center;
  font-size: 0.85rem; font-weight: 600; cursor: pointer;
  border: 1px solid var(--border-solid);
  color: var(--text-muted); background: var(--surface);
  transition: all 0.2s;
}
.source-tab:first-child { border-radius: var(--radius) 0 0 var(--radius); }
.source-tab:last-child { border-radius: 0 var(--radius) var(--radius) 0; border-left: none; }
.source-tab:hover { color: var(--text); background: var(--surface-alt); }
.source-tab.active { color: var(--accent-cyan); border-color: var(--accent-cyan); background: rgba(0,184,207,0.06); }

/* Drop zone */
.drop-zone {
  border: 2px dashed var(--border-solid);
  border-radius: var(--radius-lg);
  padding: 48px 24px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.3s, background 0.3s;
  position: relative;
}
.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--accent);
  background: rgba(110,44,139,0.04);
}
.drop-zone .drop-icon { font-size: 2.4rem; margin-bottom: 12px; opacity: 0.5; }
.drop-zone .drop-text { font-size: 0.95rem; color: var(--text-muted); margin-bottom: 6px; }
.drop-zone .drop-hint { font-size: 0.78rem; color: var(--text-dim); }
.drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

/* Upload config row */
.upload-config {
  display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
  margin-top: 16px;
}
@media (max-width: 600px) { .upload-config { grid-template-columns: 1fr; } }

/* Connected account */
.connected-account {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 18px; border-radius: var(--radius);
  background: var(--surface-alt); margin-bottom: 16px;
}
.connected-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--success); flex-shrink: 0;
}
.connected-email { font-weight: 500; flex: 1; }
.connected-actions { display: flex; gap: 8px; }

/* Google source checkboxes */
.google-sources {
  display: flex; gap: 16px; margin-bottom: 16px;
}
.google-sources label {
  display: flex; align-items: center; gap: 8px;
  font-size: 0.88rem; cursor: pointer; color: var(--text-muted);
  padding: 10px 16px; border: 1px solid var(--border-solid); border-radius: 6px;
  transition: all 0.2s;
}
.google-sources label:hover { border-color: var(--accent); color: var(--text); }
.google-sources label.checked { border-color: var(--accent-cyan); color: var(--text); background: rgba(0,184,207,0.06); }
.google-sources input[type="checkbox"] { accent-color: var(--accent-cyan); width: 16px; height: 16px; }

/* Scan config */
.scan-config { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 16px; }
@media (max-width: 600px) { .scan-config { grid-template-columns: 1fr; } }

/* Progress bar */
.progress-wrap { margin: 20px 0; }
.progress-bar-bg {
  height: 8px; border-radius: 4px; background: var(--surface-alt);
  overflow: hidden;
}
.progress-bar-fill {
  height: 100%; border-radius: 4px;
  background: linear-gradient(90deg, var(--accent), var(--accent-cyan));
  transition: width 0.5s ease;
  width: 0%;
}
.progress-text {
  font-size: 0.78rem; color: var(--text-muted); margin-top: 6px;
  display: flex; justify-content: space-between;
}

/* Mapping table */
.mapping-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.mapping-table th {
  text-align: left; padding: 10px 12px;
  font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}
.mapping-table td { padding: 8px 12px; border-bottom: 1px solid rgba(35,29,48,0.3); vertical-align: middle; }
.mapping-table select { font-size: 0.82rem; padding: 6px 10px; }

/* Confidence dots */
.confidence-dot {
  display: inline-block; width: 8px; height: 8px;
  border-radius: 50%; margin-right: 6px; vertical-align: middle;
}
.confidence-dot.high { background: var(--success); }
.confidence-dot.medium { background: var(--warning); }
.confidence-dot.low { background: var(--error); }

/* Sample value */
.sample-val {
  font-size: 0.78rem; color: var(--text-dim);
  max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  display: inline-block;
}

/* Preview table */
.preview-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.preview-table th {
  text-align: left; padding: 8px 10px;
  font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--text-muted);
  border-bottom: 1px solid var(--border); white-space: nowrap;
}
.preview-table td {
  padding: 8px 10px; border-bottom: 1px solid rgba(35,29,48,0.3);
  max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* Dedup badges */
.dedup-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 0.68rem; font-weight: 600; text-transform: uppercase;
}
.dedup-badge.new { background: rgba(52,211,153,0.15); color: var(--success); }
.dedup-badge.duplicate { background: rgba(248,113,113,0.15); color: var(--error); }
.dedup-badge.existing { background: rgba(251,191,36,0.15); color: var(--warning); }

/* Summary bar */
.summary-bar {
  display: flex; gap: 24px; flex-wrap: wrap;
  padding: 14px 18px; border-radius: var(--radius);
  background: var(--surface-alt); margin-bottom: 16px;
}
.summary-stat { text-align: center; }
.summary-stat .num {
  font-family: var(--font-title); font-size: 1.4rem; font-weight: 700;
  display: block; line-height: 1;
}
.summary-stat .num.green { color: var(--success); }
.summary-stat .num.yellow { color: var(--warning); }
.summary-stat .num.red { color: var(--error); }
.summary-stat .label {
  font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 0.04em; margin-top: 4px;
}

/* Dedup strategy radio group */
.radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
.radio-option {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: 6px;
  border: 1px solid var(--border); cursor: pointer;
  font-size: 0.82rem; color: var(--text-muted);
  transition: all 0.2s;
}
.radio-option:hover { border-color: var(--accent); color: var(--text); }
.radio-option.selected { border-color: var(--accent); color: var(--text); background: rgba(110,44,139,0.08); }
.radio-option input { display: none; }

/* Warnings banner */
.warnings-banner {
  background: rgba(251,191,36,0.08);
  border: 1px solid rgba(251,191,36,0.2);
  border-radius: var(--radius);
  padding: 12px 16px; margin-bottom: 16px;
  font-size: 0.82rem; color: var(--warning);
}

/* Custom field badge */
.cf-badge {
  display: inline-block; padding: 1px 6px; border-radius: 3px;
  font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.04em; vertical-align: middle; margin-left: 6px;
}
.cf-badge.new { background: rgba(0,184,207,0.15); color: var(--accent-cyan); }
.cf-badge.custom { background: rgba(110,44,139,0.15); color: var(--accent-hover); }

/* Pencil edit button for new custom fields */
.cf-edit-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 22px; height: 22px; margin-left: 4px;
  background: transparent; border: 1px solid var(--border-solid);
  border-radius: 4px; cursor: pointer; vertical-align: middle;
  color: var(--text-muted); font-size: 12px; line-height: 1;
  transition: background var(--transition), color var(--transition);
}
.cf-edit-btn:hover { background: var(--surface-alt); color: var(--accent-cyan); }

/* Label popover */
.cf-popover-wrap { position: relative; display: inline-block; vertical-align: middle; }
.cf-popover {
  display: none; position: absolute; top: calc(100% + 6px); left: 0; z-index: 50;
  background: var(--surface); border: 1px solid var(--border-solid);
  border-radius: var(--radius); padding: 10px 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4); min-width: 220px;
}
.cf-popover.open { display: block; }
.cf-popover label {
  display: block; font-size: 0.68rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.04em;
  color: var(--text-muted); margin-bottom: 4px;
}
.cf-popover input {
  width: 100%; padding: 5px 8px; font-size: 0.82rem;
  font-family: var(--font-body); background: var(--surface-alt);
  border: 1px solid var(--border-solid); border-radius: 4px;
  color: var(--text);
}
.cf-popover input:focus { outline: none; border-color: var(--accent-cyan); }

/* Section transitions */
.wizard-section { display: none; animation: fadeSlideIn 0.3s ease; }
.wizard-section.visible { display: block; }
@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Spinner overlay */
.spinner-overlay {
  display: flex; align-items: center; justify-content: center; gap: 12px;
  padding: 32px; color: var(--text-muted); font-size: 0.9rem;
}
.spinner-lg {
  width: 24px; height: 24px;
  border: 3px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.7s linear infinite;
}

/* Success panel */
.success-panel { text-align: center; padding: 32px; }
.success-panel .check-icon {
  width: 56px; height: 56px; border-radius: 50%;
  background: rgba(52,211,153,0.12); color: var(--success);
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 1.6rem; margin-bottom: 16px;
}
.success-panel h2 {
  font-family: var(--font-title); font-size: 1.15rem; font-weight: 600;
  margin-bottom: 8px;
}
.success-panel p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; }
.success-counts { display: flex; gap: 24px; justify-content: center; margin-bottom: 24px; }

/* Table scroll for preview */
.preview-scroll { max-height: 400px; overflow: auto; }
.preview-scroll thead { position: sticky; top: 0; background: var(--surface); z-index: 1; }

/* Import detail tabs */
.detail-tabs { display: flex; gap: 0; margin-bottom: 0; }
.detail-tab {
  padding: 8px 18px; cursor: pointer; font-size: 0.78rem; font-weight: 600;
  color: var(--text-muted); border-bottom: 2px solid transparent;
  transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.04em;
}
.detail-tab:hover { color: var(--text); }
.detail-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
.detail-tab .tab-count {
  display: inline-block; padding: 1px 7px; border-radius: 10px;
  font-size: 0.65rem; margin-left: 6px; background: rgba(110,44,139,0.12);
  color: var(--text-muted); font-weight: 700; vertical-align: middle;
}
.detail-tab.active .tab-count { background: rgba(0,184,207,0.15); color: var(--accent-cyan); }
.detail-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.detail-table th {
  text-align: left; padding: 8px 10px; font-size: 0.72rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}
.detail-table td {
  padding: 7px 10px; border-bottom: 1px solid rgba(35,29,48,0.3);
  max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.conflict-row { display: flex; gap: 8px; align-items: center; font-size: 0.78rem; margin-bottom: 4px; }
.conflict-field { font-weight: 600; color: var(--text); min-width: 80px; }
.conflict-old { color: var(--error); text-decoration: line-through; }
.conflict-new { color: var(--success); }
.detail-scroll { max-height: 300px; overflow: auto; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px; }
.detail-scroll thead { position: sticky; top: 0; background: var(--surface); z-index: 1; }

/* Past imports */
.imports-list { margin-top: 8px; }
.import-row {
  display: flex; align-items: center; gap: 16px;
  padding: 12px 0; border-bottom: 1px solid rgba(35,29,48,0.3);
  font-size: 0.84rem;
}
.import-row .filename { font-weight: 500; flex: 1; }
.import-row .status-pill {
  display: inline-block; padding: 2px 10px; border-radius: 4px;
  font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
}
.import-row .status-pill.completed { background: rgba(52,211,153,0.15); color: var(--success); }
.import-row .status-pill.error { background: rgba(248,113,113,0.15); color: var(--error); }
.import-row .status-pill.mapped { background: rgba(0,184,207,0.15); color: var(--accent-cyan); }
.import-row .status-pill.uploaded { background: rgba(139,146,160,0.15); color: var(--text-muted); }
.import-row .meta { color: var(--text-dim); font-size: 0.78rem; }
.import-row .btn-resume {
  padding: 3px 10px; border-radius: 4px; border: 1px solid var(--accent);
  background: transparent; color: var(--accent); font-size: 0.72rem;
  font-weight: 600; cursor: pointer; transition: all 0.2s;
}
.import-row .btn-resume:hover { background: var(--accent); color: #fff; }
</style>
</head>
<body>

<div class="container">
  <nav class="top-nav">
    <div class="top-nav__brand">
      <img src="visionvolve-icon-color.svg" alt="VisionVolve" class="top-nav__logo" style="height:26px;width:auto;">
      <span class="top-nav__title">Leadgen</span>
    </div>
    <div class="top-nav__links">
      <a href="index.html" class="top-nav__link">Pipeline</a>
      <a href="companies.html" class="top-nav__link">Companies</a>
      <a href="contacts.html" class="top-nav__link">Contacts</a>
      <a href="messages.html" class="top-nav__link">Messages</a>
      <a href="import.html" class="top-nav__link active" data-min-role="editor">Import</a>
      <a href="enrich.html" class="top-nav__link" data-min-role="editor">Enrich</a>
      <a href="llm-costs.html" class="top-nav__link" data-min-role="admin">LLM Costs</a>
      <a href="admin.html" class="top-nav__link" data-min-role="admin">Admin</a>
    </div>
    <span class="auth-user">
      <span id="auth_user_name"></span>
      <button class="auth-logout" onclick="LeadgenAuth.logout()">Logout</button>
    </span>
  </nav>

  <h1>Import Contacts</h1>

  <!-- Wizard Steps -->
  <div class="wizard-steps">
    <div class="wizard-step active" data-step="1">
      <span class="step-num">1</span>
      <span class="step-label">Upload</span>
    </div>
    <div class="wizard-step" data-step="2">
      <span class="step-num">2</span>
      <span class="step-label">Map Columns</span>
    </div>
    <div class="wizard-step" data-step="3">
      <span class="step-num">3</span>
      <span class="step-label">Preview &amp; Import</span>
    </div>
  </div>

  <!-- Section 1: Upload / Source -->
  <div id="section_upload" class="wizard-section visible">
    <div class="card">
      <div class="card-title">Import Source</div>

      <!-- Source tabs -->
      <div class="source-tabs">
        <div class="source-tab active" data-source="csv" onclick="setImportSource('csv')">CSV / Excel File</div>
        <div class="source-tab" data-source="google" onclick="setImportSource('google')">Google Account</div>
      </div>

      <!-- CSV panel -->
      <div id="csv_panel">
        <div class="drop-zone" id="drop_zone">
          <input type="file" id="file_input" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
          <div class="drop-icon">&#128196;</div>
          <div class="drop-text">Drop your file here or click to browse</div>
          <div class="drop-hint">Max 10 MB. CSV (UTF-8/Latin-1) or Excel (.xlsx).</div>
        </div>
      </div>

      <!-- Google panel -->
      <div id="google_panel" style="display:none;">
        <!-- OAuth connect -->
        <div id="google_no_connection" style="text-align:center; padding: 24px 0;">
          <p style="color:var(--text-muted); margin-bottom:16px; font-size:0.9rem;">
            Connect your Google account to import contacts from Gmail or Google Contacts.
          </p>
          <button class="btn-google" onclick="connectGoogle()">
            <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Sign in with Google
          </button>
        </div>

        <div id="google_connected" style="display:none;">
          <div id="google_connection_row" class="connected-account"></div>

          <!-- Source checkboxes -->
          <div class="google-sources" id="google_sources">
            <label id="lbl_contacts" class="checked">
              <input type="checkbox" id="chk_contacts" checked onchange="updateGoogleSources()">
              Google Contacts
            </label>
            <label id="lbl_gmail">
              <input type="checkbox" id="chk_gmail" onchange="updateGoogleSources()">
              Gmail Emails
            </label>
          </div>

          <!-- Gmail scan config (only when Gmail checked) -->
          <div id="gmail_scan_config" style="display:none;">
            <div class="scan-config">
              <div class="form-row">
                <label>Date Range</label>
                <select id="scan_date_range">
                  <option value="30">Last 30 days</option>
                  <option value="90" selected>Last 90 days</option>
                  <option value="180">Last 180 days</option>
                  <option value="0">All time</option>
                </select>
              </div>
              <div class="form-row">
                <label>Exclude Domains (comma-separated)</label>
                <input type="text" id="scan_exclude_domains" placeholder="gmail.com, yahoo.com">
              </div>
            </div>
          </div>

          <div style="margin-top:16px;">
            <button class="btn btn-primary" id="btn_google_fetch" onclick="fetchGoogleData()">Fetch &amp; Preview</button>
          </div>
        </div>

        <div id="google_spinner" class="spinner-overlay" style="display:none;">
          <div class="spinner-lg"></div>
          <span id="google_spinner_text">Connecting...</span>
        </div>
      </div>

      <!-- Shared: batch name + owner -->
      <div class="upload-config">
        <div class="form-row">
          <label>Batch Name</label>
          <input type="text" id="batch_name" placeholder="auto-generated from filename">
        </div>
        <div class="form-row">
          <label>Owner</label>
          <select id="owner_select"><option value="">None</option></select>
        </div>
      </div>

      <div id="upload_spinner" class="spinner-overlay" style="display:none;">
        <div class="spinner-lg"></div>
        <span>Uploading &amp; analyzing columns with AI...</span>
      </div>
    </div>

    <!-- Past imports -->
    <div class="card">
      <div class="card-title">Recent Imports</div>
      <div id="past_imports" class="imports-list">
        <div style="color:var(--text-dim); font-size:0.85rem;">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Section 2: Column Mapping (CSV only) -->
  <div id="section_mapping" class="wizard-section">
    <div class="card">
      <div class="card-title">Column Mapping</div>

      <div id="mapping_warnings" class="warnings-banner" style="display:none;"></div>

      <div style="overflow-x:auto;">
        <table class="mapping-table">
          <thead>
            <tr>
              <th>CSV Column</th>
              <th>Sample Value</th>
              <th>Maps To</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="mapping_body"></tbody>
        </table>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; align-items:center;">
        <button class="btn btn-ghost" onclick="goToStep(1)">Back</button>
        <button class="btn btn-primary" id="btn_preview" onclick="submitPreview()">Preview Import</button>
        <button class="btn btn-ghost" id="btn_remap" onclick="remapWithAI()" style="margin-left:auto;">Re-analyze with AI</button>
      </div>
    </div>
  </div>

  <!-- Section 3: Preview & Import -->
  <div id="section_preview" class="wizard-section">
    <div class="card">
      <div class="card-title">Preview</div>

      <div id="preview_summary" class="summary-bar" style="display:none;"></div>

      <div id="preview_spinner" class="spinner-overlay" style="display:none;">
        <div class="spinner-lg"></div>
        <span>Running dedup analysis...</span>
      </div>

      <!-- Gmail scan progress (shown during async scan) -->
      <div id="scan_progress" style="display:none;">
        <div class="progress-wrap">
          <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="scan_progress_bar"></div>
          </div>
          <div class="progress-text">
            <span id="scan_progress_phase">Scanning...</span>
            <span id="scan_progress_count"></span>
          </div>
        </div>
      </div>

      <div class="preview-scroll">
        <table class="preview-table">
          <thead id="preview_thead"></thead>
          <tbody id="preview_body"></tbody>
        </table>
      </div>

      <div style="margin-top:16px;">
        <div class="form-row">
          <label>Duplicate Strategy</label>
          <div class="radio-group" id="dedup_strategy">
            <label class="radio-option selected" data-val="skip">
              <input type="radio" name="dedup" value="skip" checked>
              Skip duplicates
            </label>
            <label class="radio-option" data-val="update">
              <input type="radio" name="dedup" value="update">
              Update empty fields
            </label>
            <label class="radio-option" data-val="create_new">
              <input type="radio" name="dedup" value="create_new">
              Create new anyway
            </label>
          </div>
        </div>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px;">
        <button class="btn btn-ghost" id="btn_preview_back" onclick="goToStep(importSource === 'google' ? 1 : 2)">Back</button>
        <button class="btn btn-success" id="btn_import" onclick="executeImport()">Import Contacts</button>
      </div>
    </div>

    <!-- Success panel (hidden until import completes) -->
    <div id="success_panel" class="card" style="display:none;"></div>
  </div>
</div>

<div class="toast-container" id="toast_container"></div>

<script src="auth.js"></script>
<script>
var importSource = 'csv';
(function() {
  'use strict';

  var API_BASE = 'https://leadgen.visionvolve.com/api';
  var currentJobId = null;
  var currentMapping = null;
  var owners = [];
  var customFieldDefs = [];

  // Google-specific state
  var activeConnectionId = null;
  var scanPollTimer = null;
  var scanJobId = null;

  // ---- Helpers ----

  function esc(s) {
    var d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  function authHeaders() {
    return {
      'Authorization': 'Bearer ' + (LeadgenAuth.getToken ? LeadgenAuth.getToken() : (localStorage.getItem('lg_access_token') || '')),
      'X-Namespace': (LeadgenAuth.getNamespace ? LeadgenAuth.getNamespace() : '') || 'visionvolve'
    };
  }

  function apiFetch(url, opts) {
    var options = Object.assign({ headers: authHeaders() }, opts || {});
    return fetch(url, options).then(function(resp) {
      if (resp.status === 401) throw new Error('Authentication failed');
      if (!resp.ok) return resp.text().then(function(t) { throw new Error('HTTP ' + resp.status + ': ' + t); });
      return resp.json();
    });
  }

  function toast(msg, type) {
    var container = document.getElementById('toast_container');
    var t = document.createElement('div');
    t.className = 'toast ' + (type || 'info');
    t.textContent = msg;
    container.appendChild(t);
    setTimeout(function() { t.classList.add('show'); }, 10);
    setTimeout(function() {
      t.classList.remove('show');
      setTimeout(function() { if (t.parentNode) t.parentNode.removeChild(t); }, 300);
    }, 4000);
  }

  function clearChildren(el) {
    while (el.firstChild) el.removeChild(el.firstChild);
  }

  function mkEl(tag, attrs, textContent) {
    var el = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(function(k) {
      if (k === 'className') el.className = attrs[k];
      else el.setAttribute(k, attrs[k]);
    });
    if (textContent !== undefined) el.textContent = textContent;
    return el;
  }

  // ---- Source tab switching ----

  window.setImportSource = function(source) {
    importSource = source;
    document.querySelectorAll('.source-tab').forEach(function(tab) {
      tab.classList.toggle('active', tab.getAttribute('data-source') === source);
    });
    document.getElementById('csv_panel').style.display = source === 'csv' ? '' : 'none';
    document.getElementById('google_panel').style.display = source === 'google' ? '' : 'none';
    if (source === 'google') {
      loadConnections();
    }
  };

  // ---- Wizard navigation ----

  window.goToStep = function(step) {
    var sections = ['section_upload', 'section_mapping', 'section_preview'];
    sections.forEach(function(id, i) {
      var el = document.getElementById(id);
      el.classList.toggle('visible', i === step - 1);
    });
    document.querySelectorAll('.wizard-step').forEach(function(el) {
      var s = parseInt(el.getAttribute('data-step'));
      if (importSource === 'google') {
        // Google: step 1 → step 3 (skip mapping)
        el.classList.toggle('active', s === step);
        el.classList.toggle('done', s < step);
      } else {
        el.classList.toggle('active', s === step);
        el.classList.toggle('done', s < step);
      }
    });
  };

  window.resetWizard = function() {
    currentJobId = null;
    currentMapping = null;
    document.getElementById('file_input').value = '';
    document.getElementById('batch_name').value = '';
    clearChildren(document.getElementById('mapping_body'));
    clearChildren(document.getElementById('preview_body'));
    clearChildren(document.getElementById('preview_thead'));
    document.getElementById('preview_summary').style.display = 'none';
    document.getElementById('success_panel').style.display = 'none';
    document.getElementById('scan_progress').style.display = 'none';
    if (scanPollTimer) { clearInterval(scanPollTimer); scanPollTimer = null; }
    scanJobId = null;
    goToStep(1);
    loadPastImports();
  };

  // ---- Target field options ----

  var TARGET_OPTIONS = [
    { value: '', label: '-- Unmapped --', group: '' },
    { value: 'contact.first_name', label: 'First Name', group: 'Contact' },
    { value: 'contact.last_name', label: 'Last Name', group: 'Contact' },
    { value: 'contact.job_title', label: 'Job Title', group: 'Contact' },
    { value: 'contact.email_address', label: 'Email', group: 'Contact' },
    { value: 'contact.linkedin_url', label: 'LinkedIn URL', group: 'Contact' },
    { value: 'contact.phone_number', label: 'Phone', group: 'Contact' },
    { value: 'contact.location_city', label: 'City', group: 'Contact' },
    { value: 'contact.location_country', label: 'Country', group: 'Contact' },
    { value: 'contact.seniority_level', label: 'Seniority', group: 'Contact' },
    { value: 'contact.department', label: 'Department', group: 'Contact' },
    { value: 'contact.contact_source', label: 'Source', group: 'Contact' },
    { value: 'contact.language', label: 'Language', group: 'Contact' },
    { value: 'company.name', label: 'Company Name', group: 'Company' },
    { value: 'company.domain', label: 'Company Domain', group: 'Company' },
    { value: 'company.industry', label: 'Industry', group: 'Company' },
    { value: 'company.hq_city', label: 'HQ City', group: 'Company' },
    { value: 'company.hq_country', label: 'HQ Country', group: 'Company' },
    { value: 'company.company_size', label: 'Company Size', group: 'Company' },
    { value: 'company.business_model', label: 'Business Model', group: 'Company' },
  ];

  function buildTargetSelect(selectedValue, suggestedCustomField) {
    var sel = document.createElement('select');
    sel.className = 'mapping-select';
    var currentGroup = '';
    var optgroup = null;

    TARGET_OPTIONS.forEach(function(opt) {
      if (opt.group && opt.group !== currentGroup) {
        optgroup = document.createElement('optgroup');
        optgroup.label = opt.group;
        sel.appendChild(optgroup);
        currentGroup = opt.group;
      }
      var o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      if (opt.value === selectedValue) o.selected = true;
      (optgroup || sel).appendChild(o);
    });

    var contactCustom = customFieldDefs.filter(function(d) { return d.entity_type === 'contact'; });
    var companyCustom = customFieldDefs.filter(function(d) { return d.entity_type === 'company'; });

    if (contactCustom.length) {
      optgroup = document.createElement('optgroup');
      optgroup.label = 'Custom \u2014 Contact';
      contactCustom.forEach(function(d) {
        var o = document.createElement('option');
        o.value = 'contact.custom.' + d.field_key;
        o.textContent = d.field_label;
        if (o.value === selectedValue) o.selected = true;
        optgroup.appendChild(o);
      });
      sel.appendChild(optgroup);
    }

    if (companyCustom.length) {
      optgroup = document.createElement('optgroup');
      optgroup.label = 'Custom \u2014 Company';
      companyCustom.forEach(function(d) {
        var o = document.createElement('option');
        o.value = 'company.custom.' + d.field_key;
        o.textContent = d.field_label;
        if (o.value === selectedValue) o.selected = true;
        optgroup.appendChild(o);
      });
      sel.appendChild(optgroup);
    }

    if (suggestedCustomField && selectedValue && selectedValue.indexOf('.custom.') !== -1) {
      var alreadyExists = false;
      for (var i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value === selectedValue) { alreadyExists = true; break; }
      }
      if (!alreadyExists) {
        var entity = suggestedCustomField.entity_type || selectedValue.split('.')[0];
        var grpLabel = 'Custom \u2014 ' + (entity === 'contact' ? 'Contact' : 'Company') + ' (New)';
        optgroup = document.createElement('optgroup');
        optgroup.label = grpLabel;
        var newOpt = document.createElement('option');
        newOpt.value = selectedValue;
        newOpt.textContent = suggestedCustomField.field_label || selectedValue.split('.').pop();
        newOpt.selected = true;
        optgroup.appendChild(newOpt);
        sel.appendChild(optgroup);
      }
    }

    return sel;
  }

  // ---- CSV Upload ----

  function setupDropZone() {
    var zone = document.getElementById('drop_zone');
    var input = document.getElementById('file_input');

    zone.addEventListener('dragover', function(e) {
      e.preventDefault();
      zone.classList.add('dragover');
    });
    zone.addEventListener('dragleave', function() {
      zone.classList.remove('dragover');
    });
    zone.addEventListener('drop', function(e) {
      e.preventDefault();
      zone.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        handleFile(e.dataTransfer.files[0]);
      }
    });
    input.addEventListener('change', function() {
      if (input.files.length) handleFile(input.files[0]);
    });
  }

  function handleFile(file) {
    if (!/\.(csv|xlsx)$/i.test(file.name)) {
      toast('Only CSV and XLSX files are supported', 'error');
      return;
    }
    if (file.size > 10 * 1024 * 1024) {
      toast('File too large (max 10 MB)', 'error');
      return;
    }

    var nameInput = document.getElementById('batch_name');
    if (!nameInput.value) {
      var baseName = file.name.replace(/\.(csv|xlsx)$/i, '').replace(/[^a-zA-Z0-9_-]/g, '-').toLowerCase();
      nameInput.value = 'import-' + baseName;
    }

    uploadFile(file);
  }

  function uploadFile(file) {
    var spinner = document.getElementById('upload_spinner');
    spinner.style.display = 'flex';

    var formData = new FormData();
    formData.append('file', file);

    var hdrs = authHeaders();
    fetch(API_BASE + '/imports/upload', {
      method: 'POST',
      headers: hdrs,
      body: formData,
    }).then(function(resp) {
      if (!resp.ok) return resp.text().then(function(t) { throw new Error(t); });
      return resp.json();
    }).then(function(data) {
      spinner.style.display = 'none';
      currentJobId = data.job_id;
      currentMapping = data.mapping;
      renderMapping(data);
      goToStep(2);
      toast('AI mapping complete \u2014 ' + data.total_rows + ' rows detected', 'success');
    }).catch(function(err) {
      spinner.style.display = 'none';
      toast('Upload failed: ' + err.message, 'error');
    });
  }

  // ---- Column Mapping ----

  function renderMapping(data) {
    var body = document.getElementById('mapping_body');
    clearChildren(body);
    var mappings = data.mapping.mappings || [];
    var samples = data.sample_rows || [];
    var warnings = data.mapping.warnings || [];

    var banner = document.getElementById('mapping_warnings');
    if (warnings.length) {
      banner.style.display = 'block';
      clearChildren(banner);
      var strong = mkEl('strong', {}, 'Warnings:');
      banner.appendChild(strong);
      var ul = document.createElement('ul');
      warnings.forEach(function(w) {
        var li = document.createElement('li');
        li.textContent = w;
        ul.appendChild(li);
      });
      banner.appendChild(ul);
    } else {
      banner.style.display = 'none';
    }

    mappings.forEach(function(m) {
      var sampleVal = '';
      if (samples.length && samples[0][m.csv_header] !== undefined) {
        sampleVal = String(samples[0][m.csv_header]);
      }

      var target = m.target || '';
      var suggestedCF = m.suggested_custom_field || null;

      if (!target && suggestedCF) {
        target = (suggestedCF.entity_type || 'contact') + '.custom.' + suggestedCF.field_key;
      }

      var conf = target ? (m.confidence || 0) : 0;
      var confClass = conf >= 0.8 ? 'high' : conf >= 0.5 ? 'medium' : 'low';

      var tr = document.createElement('tr');

      var td1 = document.createElement('td');
      var b = mkEl('strong', {}, m.csv_header);
      td1.appendChild(b);
      tr.appendChild(td1);

      var td2 = document.createElement('td');
      var span = mkEl('span', { className: 'sample-val' }, sampleVal);
      td2.appendChild(span);
      tr.appendChild(td2);

      var td3 = document.createElement('td');
      var sel = buildTargetSelect(target, suggestedCF);
      sel.setAttribute('data-header', m.csv_header);
      td3.appendChild(sel);

      var badge = mkEl('span', { className: 'cf-badge' });
      var popWrap = document.createElement('span');
      popWrap.className = 'cf-popover-wrap';
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'cf-edit-btn';
      editBtn.textContent = '\u270E';
      editBtn.title = 'Edit field name';
      var popover = document.createElement('div');
      popover.className = 'cf-popover';
      var popLabel = document.createElement('label');
      popLabel.textContent = 'Field name';
      var popInput = document.createElement('input');
      popInput.type = 'text';
      popInput.className = 'cf-label-input';
      popInput.placeholder = 'Field label';
      popover.appendChild(popLabel);
      popover.appendChild(popInput);
      popWrap.appendChild(editBtn);
      popWrap.appendChild(popover);

      editBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        document.querySelectorAll('.cf-popover.open').forEach(function(p) {
          if (p !== popover) p.classList.remove('open');
        });
        popover.classList.toggle('open');
        if (popover.classList.contains('open')) popInput.focus();
      });

      document.addEventListener('click', function(e) {
        if (!popWrap.contains(e.target)) popover.classList.remove('open');
      });

      popInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') popover.classList.remove('open');
      });

      function updateBadge(val, scf) {
        var isC = val.indexOf('.custom.') !== -1;
        var isNew = isC && scf;
        if (isNew) {
          badge.className = 'cf-badge new';
          badge.textContent = 'New';
          badge.style.display = '';
          popWrap.style.display = '';
          popInput.value = scf.field_label || val.split('.').pop().replace(/_/g, ' ');
        } else if (isC) {
          badge.className = 'cf-badge custom';
          badge.textContent = 'Custom';
          badge.style.display = '';
          popWrap.style.display = 'none';
          popover.classList.remove('open');
        } else {
          badge.style.display = 'none';
          popWrap.style.display = 'none';
          popover.classList.remove('open');
        }
      }
      updateBadge(target, suggestedCF);
      td3.appendChild(badge);
      td3.appendChild(popWrap);

      sel.addEventListener('change', function() {
        var v = sel.value || '';
        var hdr = sel.getAttribute('data-header');
        var origSCF = null;
        for (var i = 0; i < (currentMapping && currentMapping.mappings || []).length; i++) {
          if (currentMapping.mappings[i].csv_header === hdr) {
            origSCF = currentMapping.mappings[i].suggested_custom_field || null;
            break;
          }
        }
        var matchesSuggestion = origSCF && v === ((origSCF.entity_type || 'contact') + '.custom.' + origSCF.field_key);
        updateBadge(v, matchesSuggestion ? origSCF : null);
      });

      tr.appendChild(td3);

      var td4 = document.createElement('td');
      var dot = mkEl('span', { className: 'confidence-dot ' + confClass });
      td4.appendChild(dot);
      td4.appendChild(document.createTextNode(' ' + Math.round(conf * 100) + '%'));
      tr.appendChild(td4);

      body.appendChild(tr);
    });
  }

  // ---- Preview (CSV path) ----

  window.submitPreview = function() {
    if (!currentJobId) return;

    var btnPreview = document.getElementById('btn_preview');
    btnPreview.disabled = true;

    var originalMappings = (currentMapping && currentMapping.mappings) || [];
    var adjustedMappings = [];
    document.querySelectorAll('.mapping-select').forEach(function(sel) {
      var header = sel.getAttribute('data-header');
      var target = sel.value || null;
      var original = null;
      for (var i = 0; i < originalMappings.length; i++) {
        if (originalMappings[i].csv_header === header) { original = originalMappings[i]; break; }
      }
      var entry = {
        csv_header: header,
        target: target,
        confidence: original ? (original.confidence || 0) : 0,
        transform: (original && original.target === target) ? (original.transform || null) : null,
      };
      if (target && target.indexOf('.custom.') !== -1 && original && original.suggested_custom_field) {
        entry.suggested_custom_field = Object.assign({}, original.suggested_custom_field);
        var popWrapEl = sel.parentNode.querySelector('.cf-popover-wrap');
        if (popWrapEl && popWrapEl.style.display !== 'none') {
          var labelEl = popWrapEl.querySelector('.cf-label-input');
          if (labelEl && labelEl.value.trim()) {
            entry.suggested_custom_field.field_label = labelEl.value.trim();
          }
        }
      }
      adjustedMappings.push(entry);
    });

    var adjustedMapping = Object.assign({}, currentMapping, { mappings: adjustedMappings });

    var previewSpinner = document.getElementById('preview_spinner');
    previewSpinner.style.display = 'flex';
    goToStep(3);

    apiFetch(API_BASE + '/imports/' + currentJobId + '/preview', {
      method: 'POST',
      headers: Object.assign(authHeaders(), { 'Content-Type': 'application/json' }),
      body: JSON.stringify({ mapping: adjustedMapping }),
    }).then(function(data) {
      previewSpinner.style.display = 'none';
      btnPreview.disabled = false;
      currentMapping = adjustedMapping;
      renderPreview(data);
    }).catch(function(err) {
      previewSpinner.style.display = 'none';
      btnPreview.disabled = false;
      toast('Preview failed: ' + err.message, 'error');
    });
  };

  function renderPreview(data) {
    var rows = data.preview_rows || [];
    var summary = data.summary || {};

    var summaryBar = document.getElementById('preview_summary');
    summaryBar.style.display = 'flex';
    clearChildren(summaryBar);

    function addStat(num, label, colorClass) {
      var div = mkEl('div', { className: 'summary-stat' });
      var numSpan = mkEl('span', { className: 'num' + (colorClass ? ' ' + colorClass : '') }, String(num));
      var labelSpan = mkEl('span', { className: 'label' }, label);
      div.appendChild(numSpan);
      div.appendChild(labelSpan);
      summaryBar.appendChild(div);
    }
    addStat(data.total_rows, 'Total Rows', '');
    addStat(summary.new_contacts, 'New Contacts', 'green');
    addStat(summary.duplicate_contacts, 'Duplicates', 'yellow');
    addStat(summary.new_companies, 'New Companies', 'green');
    addStat(summary.existing_companies, 'Existing Companies', 'yellow');

    var thead = document.getElementById('preview_thead');
    clearChildren(thead);
    var headTr = document.createElement('tr');
    ['Status', 'Name', 'Title', 'Email', 'Company', 'Domain', 'Co. Status'].forEach(function(h) {
      var th = document.createElement('th');
      th.textContent = h;
      headTr.appendChild(th);
    });
    thead.appendChild(headTr);

    var tbody = document.getElementById('preview_body');
    clearChildren(tbody);

    rows.forEach(function(r) {
      var ct = r.contact || {};
      var co = r.company || {};
      var tr = document.createElement('tr');

      var td0 = document.createElement('td');
      var badge = document.createElement('span');
      if (r.contact_status === 'new') {
        badge.className = 'dedup-badge new';
        badge.textContent = 'New';
      } else {
        badge.className = 'dedup-badge duplicate';
        badge.textContent = 'Dup: ' + (r.contact_match_type || '');
      }
      td0.appendChild(badge);
      tr.appendChild(td0);

      var ctName = ((ct.first_name || '') + ' ' + (ct.last_name || '')).trim();
      [ctName, ct.job_title, ct.email_address, co.name, co.domain].forEach(function(val) {
        var td = document.createElement('td');
        td.textContent = val || '';
        tr.appendChild(td);
      });

      var tdCo = document.createElement('td');
      var coBadge = document.createElement('span');
      if (r.company_status === 'new') {
        coBadge.className = 'dedup-badge new';
        coBadge.textContent = 'New';
      } else {
        coBadge.className = 'dedup-badge existing';
        coBadge.textContent = 'Existing';
      }
      tdCo.appendChild(coBadge);
      tr.appendChild(tdCo);

      tbody.appendChild(tr);
    });
  }

  // ---- Dedup strategy radio ----

  function setupDedupRadio() {
    document.querySelectorAll('.radio-option').forEach(function(opt) {
      opt.addEventListener('click', function() {
        document.querySelectorAll('.radio-option').forEach(function(o) { o.classList.remove('selected'); });
        opt.classList.add('selected');
        opt.querySelector('input').checked = true;
      });
    });
  }

  // ---- Execute import ----

  window.executeImport = function() {
    if (!currentJobId) return;

    var btn = document.getElementById('btn_import');
    btn.disabled = true;
    btn.textContent = 'Importing...';

    var strategy = document.querySelector('input[name="dedup"]:checked').value;
    var batchName = document.getElementById('batch_name').value || ('import-' + currentJobId.substring(0, 8));
    var ownerId = document.getElementById('owner_select').value || null;

    var url, body;
    if (importSource === 'google') {
      url = API_BASE + '/gmail/contacts/' + currentJobId + '/execute';
      body = { batch_name: batchName, dedup_strategy: strategy };
      if (ownerId) body.owner_id = ownerId;
    } else {
      url = API_BASE + '/imports/' + currentJobId + '/execute';
      body = { batch_name: batchName, owner_id: ownerId, dedup_strategy: strategy };
    }

    apiFetch(url, {
      method: 'POST',
      headers: Object.assign(authHeaders(), { 'Content-Type': 'application/json' }),
      body: JSON.stringify(body),
    }).then(function(data) {
      btn.disabled = false;
      btn.textContent = 'Import Contacts';
      showSuccess(data);
    }).catch(function(err) {
      btn.disabled = false;
      btn.textContent = 'Import Contacts';
      toast('Import failed: ' + err.message, 'error');
    });
  };

  function showSuccess(data) {
    var counts = data.counts || {};
    var panel = document.getElementById('success_panel');
    panel.style.display = 'block';
    clearChildren(panel);

    var inner = mkEl('div', { className: 'success-panel' });

    var checkIcon = mkEl('div', { className: 'check-icon' }, '\u2713');
    inner.appendChild(checkIcon);

    var h2 = mkEl('h2', {}, 'Import Complete');
    inner.appendChild(h2);

    var p = mkEl('p', {}, 'Successfully imported ' +
      ((counts.contacts_created || 0) + (counts.contacts_updated || 0)) +
      ' contacts into batch "' + (data.batch_name || '') + '"');
    inner.appendChild(p);

    var countsDiv = mkEl('div', { className: 'success-counts' });
    function addCount(num, label, colorClass) {
      var stat = mkEl('div', { className: 'summary-stat' });
      stat.appendChild(mkEl('span', { className: 'num' + (colorClass ? ' ' + colorClass : '') }, String(num)));
      stat.appendChild(mkEl('span', { className: 'label' }, label));
      countsDiv.appendChild(stat);
    }
    addCount(counts.contacts_created || 0, 'Created', 'green');
    addCount(counts.contacts_updated || 0, 'Updated', 'yellow');
    addCount(counts.contacts_skipped || 0, 'Skipped', '');
    addCount(counts.companies_created || 0, 'New Cos', 'green');
    addCount(counts.companies_linked || 0, 'Linked Cos', 'yellow');
    inner.appendChild(countsDiv);

    var btns = mkEl('div', { style: 'display:flex;gap:10px;justify-content:center;flex-wrap:wrap;' });
    var enrichLink = mkEl('a', { className: 'btn btn-success', href: 'enrich.html?batch_name=' + encodeURIComponent(data.batch_name || '') + '&import_job_id=' + encodeURIComponent(data.job_id || '') }, 'Enrich Contacts');
    btns.appendChild(enrichLink);
    var aLink = mkEl('a', { className: 'btn btn-primary', href: 'contacts.html' }, 'View Contacts');
    btns.appendChild(aLink);
    var resetBtn = mkEl('button', { className: 'btn btn-ghost' }, 'Import Another');
    resetBtn.addEventListener('click', function() { resetWizard(); });
    btns.appendChild(resetBtn);
    inner.appendChild(btns);

    // Import Details section
    var detailSection = mkEl('div', { style: 'text-align:left;margin-top:24px;' });
    var detailTitle = mkEl('div', { className: 'card-title' }, 'Import Details');
    detailSection.appendChild(detailTitle);

    var tabBar = mkEl('div', { className: 'detail-tabs' });
    var detailBody = mkEl('div', { id: 'detail_body' });
    var detailState = { filter: 'all', page: 1 };

    var tabDefs = [
      { key: 'all', label: 'All' },
      { key: 'created', label: 'Created', count: counts.contacts_created },
      { key: 'skipped', label: 'Skipped', count: counts.contacts_skipped },
      { key: 'updated', label: 'Updated', count: counts.contacts_updated },
      { key: 'conflicts', label: 'Conflicts' },
    ];

    tabDefs.forEach(function(t) {
      var tab = mkEl('div', { className: 'detail-tab' + (t.key === 'all' ? ' active' : '') });
      tab.textContent = t.label;
      tab.setAttribute('data-filter', t.key);
      if (t.count !== undefined) {
        var badge = mkEl('span', { className: 'tab-count' }, String(t.count));
        tab.appendChild(badge);
      }
      tab.addEventListener('click', function() {
        tabBar.querySelectorAll('.detail-tab').forEach(function(el) { el.classList.remove('active'); });
        tab.classList.add('active');
        detailState.filter = t.key;
        detailState.page = 1;
        loadDetailRows(data.job_id, detailState, detailBody);
      });
      tabBar.appendChild(tab);
    });

    detailSection.appendChild(tabBar);
    detailSection.appendChild(detailBody);
    inner.appendChild(detailSection);

    panel.appendChild(inner);
    panel.scrollIntoView({ behavior: 'smooth' });

    loadDetailRows(data.job_id, detailState, detailBody);
  }

  function loadDetailRows(jobId, state, container) {
    clearChildren(container);
    var spinner = mkEl('div', { className: 'spinner-overlay', style: 'padding:16px;' });
    spinner.appendChild(mkEl('div', { className: 'loading-sm' }));
    spinner.appendChild(mkEl('span', {}, 'Loading details...'));
    container.appendChild(spinner);

    apiFetch(API_BASE + '/imports/' + jobId + '/results?filter=' + state.filter + '&page=' + state.page)
      .then(function(data) {
        clearChildren(container);
        if (!data.rows || !data.rows.length) {
          container.appendChild(mkEl('div', { style: 'padding:16px;color:var(--text-dim);font-size:0.85rem;' }, 'No rows match this filter.'));
          if (data.summary && data.summary.total_conflicts !== undefined) {
            var cTab = document.querySelector('.detail-tab[data-filter="conflicts"]');
            if (cTab && !cTab.querySelector('.tab-count')) {
              cTab.appendChild(mkEl('span', { className: 'tab-count' }, String(data.summary.total_conflicts)));
            }
          }
          return;
        }

        if (data.summary && data.summary.total_conflicts !== undefined) {
          var cTab = document.querySelector('.detail-tab[data-filter="conflicts"]');
          if (cTab && !cTab.querySelector('.tab-count')) {
            cTab.appendChild(mkEl('span', { className: 'tab-count' }, String(data.summary.total_conflicts)));
          }
        }

        var scroll = mkEl('div', { className: 'detail-scroll' });
        var table = mkEl('table', { className: 'detail-table' });
        var thead = document.createElement('thead');
        var headTr = document.createElement('tr');

        var columns = state.filter === 'conflicts'
          ? ['Row', 'Contact', 'Company', 'Field', 'Existing', 'Incoming']
          : ['Row', 'Action', 'Contact', 'Company', 'Detail'];

        columns.forEach(function(h) {
          headTr.appendChild(mkEl('th', {}, h));
        });
        thead.appendChild(headTr);
        table.appendChild(thead);

        var tbody = document.createElement('tbody');

        if (state.filter === 'conflicts') {
          data.rows.forEach(function(r) {
            (r.conflicts || []).forEach(function(c) {
              var tr = document.createElement('tr');
              tr.appendChild(mkEl('td', {}, String(r.row_idx + 1)));
              tr.appendChild(mkEl('td', {}, r.contact_name || ''));
              tr.appendChild(mkEl('td', {}, r.company_name || ''));
              tr.appendChild(mkEl('td', { style: 'font-weight:600;' }, c.field));
              tr.appendChild(mkEl('td', { style: 'color:var(--error);' }, c.existing));
              tr.appendChild(mkEl('td', { style: 'color:var(--success);' }, c.incoming));
              tbody.appendChild(tr);
            });
          });
        } else {
          data.rows.forEach(function(r) {
            var tr = document.createElement('tr');
            tr.appendChild(mkEl('td', {}, String(r.row_idx + 1)));

            var actionBadge = mkEl('span', { className: 'dedup-badge' });
            if (r.action === 'created') { actionBadge.className = 'dedup-badge new'; actionBadge.textContent = 'Created'; }
            else if (r.action === 'skipped') { actionBadge.className = 'dedup-badge duplicate'; actionBadge.textContent = 'Skipped'; }
            else if (r.action === 'updated') { actionBadge.className = 'dedup-badge existing'; actionBadge.textContent = 'Updated'; }
            else { actionBadge.className = 'dedup-badge duplicate'; actionBadge.textContent = r.action || 'Error'; }
            var actionTd = document.createElement('td');
            actionTd.appendChild(actionBadge);
            tr.appendChild(actionTd);

            tr.appendChild(mkEl('td', {}, r.contact_name || ''));
            tr.appendChild(mkEl('td', {}, r.company_name || ''));

            var detailTd = document.createElement('td');
            if (r.action === 'skipped') {
              detailTd.textContent = 'Match: ' + (r.match_type || '') + (r.matched_contact_name ? ' (' + r.matched_contact_name + ')' : '');
            } else if (r.action === 'updated') {
              var parts = [];
              if (r.fields_updated && r.fields_updated.length) parts.push('Updated: ' + r.fields_updated.join(', '));
              if (r.conflicts && r.conflicts.length) parts.push(r.conflicts.length + ' conflict(s)');
              detailTd.textContent = parts.join(' | ');
            } else if (r.action === 'error') {
              detailTd.textContent = r.reason || 'Error';
              detailTd.style.color = 'var(--error)';
            }
            tr.appendChild(detailTd);

            tbody.appendChild(tr);
          });
        }

        table.appendChild(tbody);
        scroll.appendChild(table);
        container.appendChild(scroll);

        if (data.total > data.per_page) {
          var totalPages = Math.ceil(data.total / data.per_page);
          var pagBar = mkEl('div', { style: 'display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px;' });
          if (state.page > 1) {
            var prevBtn = mkEl('button', { className: 'btn btn-ghost btn-sm' }, 'Previous');
            prevBtn.addEventListener('click', function() { state.page--; loadDetailRows(jobId, state, container); });
            pagBar.appendChild(prevBtn);
          }
          pagBar.appendChild(mkEl('span', { style: 'font-size:0.78rem;color:var(--text-muted);' },
            'Page ' + state.page + ' of ' + totalPages + ' (' + data.total + ' rows)'));
          if (state.page < totalPages) {
            var nextBtn = mkEl('button', { className: 'btn btn-ghost btn-sm' }, 'Next');
            nextBtn.addEventListener('click', function() { state.page++; loadDetailRows(jobId, state, container); });
            pagBar.appendChild(nextBtn);
          }
          container.appendChild(pagBar);
        }
      })
      .catch(function(err) {
        clearChildren(container);
        container.appendChild(mkEl('div', { style: 'padding:16px;color:var(--error);font-size:0.85rem;' }, 'Failed to load details: ' + err.message));
      });
  }

  // ---- Google OAuth ----

  function loadConnections() {
    apiFetch(API_BASE + '/oauth/connections').then(function(data) {
      var conns = data.connections || [];
      var noEl = document.getElementById('google_no_connection');
      var connEl = document.getElementById('google_connected');

      var activeConn = null;
      for (var i = 0; i < conns.length; i++) {
        if (conns[i].status === 'active') { activeConn = conns[i]; break; }
      }

      if (!activeConn) {
        noEl.style.display = '';
        connEl.style.display = 'none';
        activeConnectionId = null;
        return;
      }

      activeConnectionId = activeConn.id;
      noEl.style.display = 'none';
      connEl.style.display = '';

      var row = document.getElementById('google_connection_row');
      clearChildren(row);

      var dot = mkEl('span', { className: 'connected-dot' });
      row.appendChild(dot);

      var email = mkEl('span', { className: 'connected-email' }, activeConn.provider_email);
      row.appendChild(email);

      var actions = mkEl('div', { className: 'connected-actions' });
      var disconnectBtn = mkEl('button', { className: 'btn btn-ghost btn-sm' }, 'Disconnect');
      disconnectBtn.addEventListener('click', function() { disconnectAccount(activeConn.id); });
      actions.appendChild(disconnectBtn);
      row.appendChild(actions);
    }).catch(function(err) {
      toast('Failed to load connections: ' + err.message, 'error');
    });
  }

  window.connectGoogle = function() {
    var returnUrl = window.location.href;
    apiFetch(API_BASE + '/oauth/google/auth-url?scopes=both&return_url=' + encodeURIComponent(returnUrl))
      .then(function(data) {
        window.location.href = data.auth_url;
      })
      .catch(function(err) {
        toast('Failed to start OAuth: ' + err.message, 'error');
      });
  };

  function disconnectAccount(id) {
    if (!confirm('Disconnect this Google account?')) return;
    var h = authHeaders();
    h['Content-Type'] = 'application/json';
    fetch(API_BASE + '/oauth/connections/' + encodeURIComponent(id), {
      method: 'DELETE',
      headers: h
    }).then(function(resp) {
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return resp.json();
    }).then(function() {
      toast('Account disconnected', 'success');
      activeConnectionId = null;
      loadConnections();
    }).catch(function(err) {
      toast('Disconnect failed: ' + err.message, 'error');
    });
  }

  // ---- Google source checkboxes ----

  window.updateGoogleSources = function() {
    var chkContacts = document.getElementById('chk_contacts');
    var chkGmail = document.getElementById('chk_gmail');
    document.getElementById('lbl_contacts').classList.toggle('checked', chkContacts.checked);
    document.getElementById('lbl_gmail').classList.toggle('checked', chkGmail.checked);
    document.getElementById('gmail_scan_config').style.display = chkGmail.checked ? '' : 'none';
  };

  // ---- Google fetch / scan ----

  window.fetchGoogleData = function() {
    if (!activeConnectionId) {
      toast('No Google account connected', 'error');
      return;
    }

    var chkContacts = document.getElementById('chk_contacts');
    var chkGmail = document.getElementById('chk_gmail');

    if (!chkContacts.checked && !chkGmail.checked) {
      toast('Select at least one source', 'error');
      return;
    }

    // Auto-generate batch name if empty
    var nameInput = document.getElementById('batch_name');
    if (!nameInput.value) {
      nameInput.value = 'google-import-' + new Date().toISOString().slice(0, 10);
    }

    if (chkContacts.checked) {
      fetchGoogleContacts(chkGmail.checked);
    } else if (chkGmail.checked) {
      startGmailScan();
    }
  };

  function fetchGoogleContacts(alsoScanGmail) {
    var spinner = document.getElementById('google_spinner');
    document.getElementById('google_spinner_text').textContent = 'Fetching contacts from Google...';
    spinner.style.display = '';
    document.getElementById('btn_google_fetch').disabled = true;

    var h = authHeaders();
    h['Content-Type'] = 'application/json';

    fetch(API_BASE + '/gmail/contacts/fetch', {
      method: 'POST',
      headers: h,
      body: JSON.stringify({ connection_id: activeConnectionId })
    })
    .then(function(resp) { return resp.json().then(function(d) { return { ok: resp.ok, data: d }; }); })
    .then(function(result) {
      spinner.style.display = 'none';
      if (!result.ok) {
        toast(result.data.error || 'Fetch failed', 'error');
        document.getElementById('btn_google_fetch').disabled = false;
        return;
      }
      currentJobId = result.data.job_id;
      toast('Found ' + result.data.total_contacts + ' contacts', 'success');

      if (alsoScanGmail) {
        // Start Gmail scan in background — contacts job stays as currentJobId
        startGmailScan(true);
      } else {
        runGooglePreview();
      }
    })
    .catch(function(err) {
      spinner.style.display = 'none';
      document.getElementById('btn_google_fetch').disabled = false;
      toast('Fetch failed: ' + err.message, 'error');
    });
  }

  function startGmailScan(hasContactsJob) {
    var spinner = document.getElementById('google_spinner');
    document.getElementById('google_spinner_text').textContent = 'Starting Gmail scan...';
    spinner.style.display = '';
    document.getElementById('btn_google_fetch').disabled = true;

    var dateRange = document.getElementById('scan_date_range').value;
    var excludeDomains = document.getElementById('scan_exclude_domains').value;

    var h = authHeaders();
    h['Content-Type'] = 'application/json';

    fetch(API_BASE + '/gmail/scan/start', {
      method: 'POST',
      headers: h,
      body: JSON.stringify({
        connection_id: activeConnectionId,
        date_range: parseInt(dateRange) || null,
        exclude_domains: excludeDomains ? excludeDomains.split(',').map(function(s) { return s.trim(); }) : [],
        max_messages: 5000
      })
    })
    .then(function(resp) { return resp.json().then(function(d) { return { ok: resp.ok, data: d }; }); })
    .then(function(result) {
      spinner.style.display = 'none';
      if (!result.ok) {
        toast(result.data.error || 'Scan start failed', 'error');
        document.getElementById('btn_google_fetch').disabled = false;
        if (hasContactsJob) runGooglePreview();
        return;
      }
      if (!hasContactsJob) {
        // Gmail-only mode: scan job is the primary job
        currentJobId = result.data.job_id;
      }
      scanJobId = result.data.job_id;
      goToStep(3);
      pollScanProgress(hasContactsJob);
    })
    .catch(function(err) {
      spinner.style.display = 'none';
      document.getElementById('btn_google_fetch').disabled = false;
      toast('Scan failed: ' + err.message, 'error');
      if (hasContactsJob) runGooglePreview();
    });
  }

  function pollScanProgress(hasContactsJob) {
    var progressEl = document.getElementById('scan_progress');
    progressEl.style.display = '';
    var pollId = scanJobId || currentJobId;

    scanPollTimer = setInterval(function() {
      apiFetch(API_BASE + '/gmail/scan/' + pollId + '/status')
        .then(function(data) {
          var progress = data.scan_progress || {};
          var bar = document.getElementById('scan_progress_bar');
          var phase = document.getElementById('scan_progress_phase');
          var count = document.getElementById('scan_progress_count');

          var pct = progress.percent || 0;
          bar.style.width = pct + '%';
          phase.textContent = (progress.phase || 'scanning').replace(/_/g, ' ');
          count.textContent = (progress.contacts_found || 0) + ' contacts found';

          if (data.status === 'extracted' || data.status === 'error') {
            clearInterval(scanPollTimer);
            scanPollTimer = null;
            progressEl.style.display = 'none';
            if (data.status === 'error') {
              toast('Gmail scan failed: ' + (data.error || 'unknown error'), 'error');
              // If we also fetched contacts, preview those instead
              if (hasContactsJob) {
                runGooglePreview();
              }
            } else {
              var found = progress.contacts_found || 0;
              if (found > 0 && !hasContactsJob) {
                // Gmail-only: preview the scan results
                toast('Scan complete! Found ' + found + ' contacts', 'success');
                currentJobId = pollId;
                runGooglePreview();
              } else if (hasContactsJob) {
                // Both sources: preview contacts job (currentJobId already set)
                toast('Scan complete. Previewing contacts.', 'success');
                runGooglePreview();
              } else {
                toast('Gmail scan found 0 contacts', 'info');
              }
            }
          }
        })
        .catch(function() {});
    }, 3000);
  }

  function runGooglePreview() {
    goToStep(3);
    var spinner = document.getElementById('preview_spinner');
    spinner.style.display = '';

    var h = authHeaders();
    h['Content-Type'] = 'application/json';

    fetch(API_BASE + '/gmail/contacts/' + currentJobId + '/preview', {
      method: 'POST',
      headers: h,
      body: '{}'
    })
    .then(function(resp) { return resp.json().then(function(d) { return { ok: resp.ok, data: d }; }); })
    .then(function(result) {
      spinner.style.display = 'none';
      if (!result.ok) {
        toast(result.data.error || 'Preview failed', 'error');
        return;
      }
      renderPreview(result.data);
    })
    .catch(function(err) {
      spinner.style.display = 'none';
      toast('Preview failed: ' + err.message, 'error');
    });
  }

  // ---- Load owners ----

  function loadOwners() {
    apiFetch(API_BASE + '/batches').then(function(data) {
      owners = data.owners || [];
      var sel = document.getElementById('owner_select');
      clearChildren(sel);
      sel.appendChild(mkEl('option', { value: '' }, 'No owner'));
      owners.forEach(function(o) {
        sel.appendChild(mkEl('option', { value: o.id }, o.name));
      });
      customFieldDefs = data.custom_fields || [];
    }).catch(function() {});
  }

  // ---- Past imports ----

  function loadPastImports() {
    apiFetch(API_BASE + '/imports').then(function(data) {
      var list = document.getElementById('past_imports');
      clearChildren(list);
      var imports = data.imports || [];
      if (!imports.length) {
        list.appendChild(mkEl('div', { style: 'color:var(--text-dim);font-size:0.85rem;padding:8px 0;' }, 'No previous imports'));
        return;
      }
      imports.forEach(function(job) {
        var row = mkEl('div', { className: 'import-row' });
        row.appendChild(mkEl('span', { className: 'filename' }, job.filename));
        row.appendChild(mkEl('span', { className: 'meta' }, (job.total_rows || 0) + ' rows'));

        var date = job.created_at ? new Date(job.created_at).toLocaleDateString() : '';
        row.appendChild(mkEl('span', { className: 'meta' }, date));

        var statusClass = job.status === 'completed' ? 'completed' :
                          job.status === 'error' ? 'error' :
                          (job.status === 'mapped' || job.status === 'previewed') ? 'mapped' : 'uploaded';
        row.appendChild(mkEl('span', { className: 'status-pill ' + statusClass }, job.status));

        if (job.status === 'completed') {
          row.appendChild(mkEl('span', { className: 'meta' },
            (job.contacts_created || 0) + ' created, ' + (job.contacts_skipped || 0) + ' skipped'));
        }
        if (job.status === 'uploaded' || job.status === 'mapped' || job.status === 'previewed') {
          var resumeBtn = mkEl('button', { className: 'btn-resume' }, 'Resume');
          resumeBtn.addEventListener('click', (function(jobId) {
            return function() { resumeImport(jobId); };
          })(job.id));
          row.appendChild(resumeBtn);
        }
        list.appendChild(row);
      });
    }).catch(function() {
      var list = document.getElementById('past_imports');
      clearChildren(list);
      list.appendChild(mkEl('div', { style: 'color:var(--text-dim);font-size:0.85rem;' }, 'Could not load import history'));
    });
  }

  // ---- Resume past import ----

  function resumeImport(jobId) {
    toast('Loading import...', 'info');
    apiFetch(API_BASE + '/imports/' + jobId + '/status').then(function(data) {
      if (!data.column_mapping || !data.column_mapping.mappings) {
        toast('This import has no mapping data to resume', 'error');
        return;
      }
      currentJobId = data.id;
      currentMapping = data.column_mapping;
      importSource = 'csv';
      setImportSource('csv');
      renderMapping({
        mapping: data.column_mapping,
        sample_rows: data.sample_rows || [],
        total_rows: data.total_rows,
      });
      goToStep(2);
      toast('Resumed import of ' + data.filename + ' (' + data.total_rows + ' rows)', 'success');
    }).catch(function(err) {
      toast('Failed to resume: ' + err.message, 'error');
    });
  }

  // ---- Re-analyze with AI ----

  window.remapWithAI = function() {
    if (!currentJobId) return;
    var btn = document.getElementById('btn_remap');
    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    apiFetch(API_BASE + '/imports/' + currentJobId + '/remap', {
      method: 'POST',
      headers: Object.assign(authHeaders(), { 'Content-Type': 'application/json' }),
      body: '{}',
    }).then(function(data) {
      btn.disabled = false;
      btn.textContent = 'Re-analyze with AI';
      currentMapping = data.mapping;
      renderMapping(data);
      toast('AI re-analysis complete', 'success');
    }).catch(function(err) {
      btn.disabled = false;
      btn.textContent = 'Re-analyze with AI';
      toast('Re-analysis failed: ' + err.message, 'error');
    });
  };

  // ---- Handle OAuth callback ----

  function handleOAuthCallback() {
    var params = new URLSearchParams(window.location.search);
    if (params.get('connected') === 'true') {
      // Came back from OAuth — switch to Google tab and load connections
      setImportSource('google');
      toast('Google account connected', 'success');
      // Clean URL
      var clean = window.location.pathname + window.location.hash;
      window.history.replaceState({}, '', clean);
    }
  }

  // ---- Init ----

  function initImport() {
    setupDropZone();
    setupDedupRadio();
    loadOwners();
    loadPastImports();
    handleOAuthCallback();
  }

  function init() {
    LeadgenAuth.init(initImport);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
</body>
</html>
