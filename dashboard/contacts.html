<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contacts â€” Leadgen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0D0F14;
  --surface: #14171E;
  --surface-alt: #1A1E28;
  --border: rgba(110,44,139,0.15);
  --border-solid: #231D30;
  --text: #E8EAF0;
  --text-muted: #8B92A0;
  --text-dim: #5A6170;
  --accent: #6E2C8B;
  --accent-hover: #8B47A8;
  --accent-cyan: #00B8CF;
  --success: #34D399;
  --error: #F87171;
  --warning: #FBBF24;
  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
  --font-title: 'Lexend Deca', -apple-system, sans-serif;
  --font-body: 'Work Sans', -apple-system, sans-serif;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, #4A1D5E, #6E2C8B 40%, #00B8CF);
  z-index: 100;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(110,44,139,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(110,44,139,.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: -1;
}

.container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

h1 { font-family: var(--font-title); font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; letter-spacing: -0.01em; }

.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
}

.card-title {
  font-family: var(--font-title);
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--text-muted);
  margin-bottom: 16px;
}

select, input[type="text"] {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 12px;
  color: var(--text);
  font-size: 0.9rem;
  width: 100%;
  font-family: inherit;
  transition: border-color var(--transition);
}
select:focus, input[type="text"]:focus { outline: none; border-color: var(--accent); }
select option { background: var(--bg); color: var(--text); }

textarea {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 8px 12px;
  color: var(--text);
  font-size: 0.9rem;
  width: 100%;
  font-family: inherit;
  resize: vertical;
  min-height: 60px;
}
textarea:focus { outline: none; border-color: var(--accent); }

.form-row { margin-bottom: 14px; }
.form-row > label:first-child { display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

.filter-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; align-items: end; }
@media (max-width: 900px) { .filter-grid { grid-template-columns: 1fr 1fr; } }

.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 20px; border: none; border-radius: 6px;
  font-size: 0.9rem; font-weight: 600; cursor: pointer;
  transition: background var(--transition), opacity var(--transition);
}
.btn-primary { background: linear-gradient(135deg, #6E2C8B, #4A1D5E); color: #fff; }
.btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, #8B47A8, #6E2C8B); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-sm { padding: 6px 14px; font-size: 0.8rem; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover:not(:disabled) { background: #3aa372; }
.btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
.btn-ghost:hover:not(:disabled) { background: var(--surface-alt); color: var(--text); }

/* Top nav */
.top-nav {
  display: flex; align-items: center; gap: 8px;
  padding: 14px 0; margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
}
.top-nav__brand { display: flex; align-items: center; gap: 10px; }
.top-nav__title { font-family: var(--font-title); font-size: 1.05rem; font-weight: 700; color: var(--text); letter-spacing: -0.01em; }
.top-nav__links { display: flex; gap: 2px; margin-left: 24px; }
.top-nav__link {
  color: var(--text-muted); text-decoration: none;
  font-family: var(--font-body); font-size: 0.85rem; font-weight: 500;
  padding: 6px 14px; border-radius: 6px;
  transition: color 0.2s, background 0.2s;
}
.top-nav__link:hover { color: var(--text); background: rgba(110,44,139,0.08); }
.top-nav__link.active { color: var(--accent-cyan); font-weight: 600; background: rgba(0,184,207,0.08); }

/* Table */
.data-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.data-table th {
  text-align: left; padding: 10px 12px;
  font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  cursor: pointer; user-select: none; white-space: nowrap;
}
.data-table th:hover { color: var(--text); }
.data-table th .sort-arrow { font-size: 0.65rem; margin-left: 4px; }
.data-table td {
  padding: 10px 12px; border-bottom: 1px solid rgba(35,29,48,0.3);
  max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.data-table tr { cursor: pointer; transition: background 0.15s; }
.data-table tbody tr:hover { background: var(--surface-alt); }

/* Badges */
.icp-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
}
.icp-badge.strong-fit { background: rgba(52,211,153,0.15); color: var(--success); }
.icp-badge.moderate-fit { background: rgba(251,191,36,0.15); color: var(--warning); }
.icp-badge.weak-fit { background: rgba(248,113,113,0.15); color: var(--error); }
.icp-badge.unknown { background: rgba(139,146,160,0.15); color: var(--text-muted); }

.msg-status-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
}
.msg-status-badge.approved { background: rgba(52,211,153,0.15); color: var(--success); }
.msg-status-badge.pending-review { background: rgba(251,191,36,0.15); color: var(--warning); }
.msg-status-badge.sent { background: rgba(0,184,207,0.15); color: var(--accent-cyan); }
.msg-status-badge.not-started { background: rgba(139,146,160,0.15); color: var(--text-muted); }
.msg-status-badge.default { background: rgba(139,146,160,0.15); color: var(--text-muted); }

/* Scroll container */
.table-scroll {
  max-height: calc(100vh - 280px);
  overflow-y: auto;
  overflow-x: auto;
}
.data-table thead { position: sticky; top: 0; z-index: 1; background: var(--surface); }
.scroll-status { padding: 12px 16px; font-size: 0.82rem; color: var(--text-muted); display: flex; align-items: center; justify-content: space-between; }
.scroll-status .count { font-weight: 500; }
.scroll-sentinel { height: 1px; }
.scroll-loader { text-align: center; padding: 16px 0; }
.scroll-end { text-align: center; padding: 12px 0; font-size: 0.8rem; color: var(--text-dim); }

/* Modal */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.7); z-index: 200;
  justify-content: center; align-items: flex-start;
  padding: 40px 16px; overflow-y: auto;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); width: 100%; max-width: 800px;
  max-height: calc(100vh - 80px); overflow-y: auto;
}
.modal-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 24px; border-bottom: 1px solid var(--border);
  position: sticky; top: 0; background: var(--surface); z-index: 1;
}
.modal-header h2 { font-family: var(--font-title); font-size: 1.1rem; font-weight: 600; }
.modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 4px 8px; }
.modal-close:hover { color: var(--text); }
.modal-body { padding: 24px; }

.detail-section { margin-bottom: 24px; }
.detail-section-title {
  font-family: var(--font-title); font-size: 0.78rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-muted); margin-bottom: 12px;
}

.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.detail-field label { display: block; font-size: 0.72rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 2px; }
.detail-field .value { font-size: 0.88rem; color: var(--text); word-break: break-word; }
.detail-field .value.empty { color: var(--text-dim); font-style: italic; }
.detail-field.full { grid-column: 1 / -1; }

/* Enrichment text */
.enrich-block { margin-bottom: 12px; }
.enrich-block label { display: block; font-size: 0.72rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px; }
.enrich-block .enrich-text { font-size: 0.84rem; color: var(--text); white-space: pre-wrap; line-height: 1.5; }

/* Mini table for messages */
.mini-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.mini-table th {
  text-align: left; padding: 6px 8px;
  font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
  color: var(--text-muted); border-bottom: 1px solid var(--border);
}
.mini-table td { padding: 6px 8px; border-bottom: 1px solid rgba(35,29,48,0.3); }

/* Toast */
.toast-container { position: fixed; top: 16px; right: 16px; z-index: 300; display: flex; flex-direction: column; gap: 8px; }
.toast { padding: 12px 18px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; color: #fff; opacity: 0; transform: translateX(40px); transition: opacity 0.3s, transform 0.3s; max-width: 360px; }
.toast.show { opacity: 1; transform: translateX(0); }
.toast.success { background: var(--success); }
.toast.error { background: var(--error); }
.toast.info { background: var(--accent-cyan); }

.empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); font-size: 0.95rem; }
.empty-state .big { font-size: 2rem; margin-bottom: 8px; }

.loading-sm { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; }
@keyframes spin { to { transform: rotate(360deg); } }

.link-btn { color: var(--accent-cyan); background: none; border: none; cursor: pointer; font-size: inherit; font-family: inherit; text-decoration: underline; padding: 0; }
.link-btn:hover { color: var(--text); }
</style>
</head>
<body>

<div class="container">
  <nav class="top-nav">
    <div class="top-nav__brand">
      <img src="visionvolve-icon-color.svg" alt="VisionVolve" class="top-nav__logo" style="height:26px;width:auto;">
      <span class="top-nav__title">Leadgen</span>
    </div>
    <div class="top-nav__links">
      <a href="index.html" class="top-nav__link">Pipeline</a>
      <a href="companies.html" class="top-nav__link">Companies</a>
      <a href="contacts.html" class="top-nav__link active">Contacts</a>
      <a href="messages.html" class="top-nav__link">Messages</a>
      <a href="import.html" class="top-nav__link" data-min-role="editor">Import</a>
      <a href="admin.html" class="top-nav__link" data-min-role="admin">Admin</a>
    </div>
    <span class="auth-user">
      <span id="auth_user_name"></span>
      <button class="auth-logout" onclick="LeadgenAuth.logout()">Logout</button>
    </span>
  </nav>

  <h1>Contacts</h1>

  <!-- Filters -->
  <div class="card">
    <div class="card-title">Filters</div>
    <div class="filter-grid">
      <div class="form-row">
        <label for="filter_search">Search</label>
        <input type="text" id="filter_search" placeholder="Name, email or title...">
      </div>
      <div class="form-row">
        <label for="filter_batch">Batch</label>
        <select id="filter_batch"><option value="">All</option></select>
      </div>
      <div class="form-row">
        <label for="filter_owner">Owner</label>
        <select id="filter_owner"><option value="">All</option></select>
      </div>
      <div class="form-row">
        <label for="filter_icp">ICP Fit</label>
        <select id="filter_icp">
          <option value="">All</option>
          <option value="strong_fit">Strong Fit</option>
          <option value="moderate_fit">Moderate Fit</option>
          <option value="weak_fit">Weak Fit</option>
          <option value="unknown">Unknown</option>
        </select>
      </div>
      <div class="form-row">
        <label for="filter_msg_status">Message Status</label>
        <select id="filter_msg_status">
          <option value="">All</option>
          <option value="not_started">Not Started</option>
          <option value="generating">Generating</option>
          <option value="pending_review">Pending Review</option>
          <option value="approved">Approved</option>
          <option value="sent">Sent</option>
          <option value="replied">Replied</option>
          <option value="no_channel">No Channel</option>
          <option value="generation_failed">Failed</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card" style="padding:0; overflow:hidden;">
    <div class="scroll-status" id="scroll_status"></div>
    <div class="table-scroll" id="scroll_container">
      <table class="data-table">
        <thead>
          <tr>
            <th data-sort="full_name">Name <span class="sort-arrow"></span></th>
            <th data-sort="job_title">Title <span class="sort-arrow"></span></th>
            <th>Company</th>
            <th data-sort="email_address">Email <span class="sort-arrow"></span></th>
            <th data-sort="contact_score">Score <span class="sort-arrow"></span></th>
            <th data-sort="icp_fit">ICP Fit <span class="sort-arrow"></span></th>
            <th data-sort="message_status">Msg Status <span class="sort-arrow"></span></th>
            <th>Owner</th>
            <th>Batch</th>
          </tr>
        </thead>
        <tbody id="table_body">
          <tr><td colspan="9" class="empty-state">Loading...</td></tr>
        </tbody>
      </table>
      <div class="scroll-sentinel" id="scroll_sentinel"></div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="modal_overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal_title">Contact Detail</h2>
      <button class="modal-close" id="modal_close">&times;</button>
    </div>
    <div class="modal-body" id="modal_body"></div>
  </div>
</div>

<div class="toast-container" id="toast_container"></div>

<script src="auth.js"></script>
<script>
(function() {
  'use strict';

  var API_BASE = 'https://leadgen.visionvolve.com/api';

  var state = {
    page: 1,
    pageSize: 50,
    sort: 'full_name',
    sortDir: 'asc',
    total: 0,
    items: [],
    isLoading: false,
    hasMore: true
  };

  var $ = function(sel) { return document.querySelector(sel); };

  function apiHeaders() {
    return {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + (LeadgenAuth.getToken ? LeadgenAuth.getToken() : (localStorage.getItem('lg_access_token') || '')),
      'X-Namespace': (LeadgenAuth.getNamespace ? LeadgenAuth.getNamespace() : '') || 'visionvolve'
    };
  }

  function apiFetch(url, opts) {
    var options = Object.assign({}, opts, { headers: Object.assign({}, apiHeaders(), (opts && opts.headers) || {}) });
    return fetch(url, options).then(function(resp) {
      if (resp.status === 401) throw new Error('Authentication failed');
      if (!resp.ok) return resp.text().then(function(t) { throw new Error('HTTP ' + resp.status + ': ' + t); });
      return resp.json();
    });
  }

  function save(k, v) { try { localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v)); } catch(e) {} }
  function load(k, fb) { try { var r = localStorage.getItem(k); if (r === null) return fb; if (typeof fb === 'string') return r; return JSON.parse(r); } catch(e) { return fb; } }

  function showToast(msg, type) {
    var c = $('#toast_container');
    var t = document.createElement('div');
    t.className = 'toast ' + (type || 'info');
    t.textContent = msg;
    c.appendChild(t);
    requestAnimationFrame(function() { t.classList.add('show'); });
    setTimeout(function() { t.classList.remove('show'); setTimeout(function() { t.remove(); }, 300); }, 4000);
  }

  function el(tag, attrs, children) {
    var e = document.createElement(tag);
    if (attrs) {
      Object.keys(attrs).forEach(function(k) {
        if (k === 'className') e.className = attrs[k];
        else if (k === 'style' && typeof attrs[k] === 'object') Object.assign(e.style, attrs[k]);
        else if (k.indexOf('on') === 0) e.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
        else e.setAttribute(k, attrs[k]);
      });
    }
    if (children) {
      (Array.isArray(children) ? children : [children]).forEach(function(c) {
        if (c == null) return;
        if (typeof c === 'string') e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      });
    }
    return e;
  }

  // ---- Badge helpers ----
  function icpClass(v) {
    if (!v) return 'unknown';
    return v.toLowerCase().replace(/[ _]+/g, '-');
  }

  function msgStatusClass(v) {
    if (!v) return 'default';
    return v.toLowerCase().replace(/[ _]+/g, '-');
  }

  // ---- Load filter options ----
  function loadFilterOptions() {
    apiFetch(API_BASE + '/batches').then(function(data) {
      var batchSel = $('#filter_batch');
      (data.batches || []).forEach(function(b) {
        var opt = document.createElement('option');
        opt.value = b.name; opt.textContent = b.name;
        batchSel.appendChild(opt);
      });
      var ownerSel = $('#filter_owner');
      (data.owners || []).forEach(function(o) {
        var opt = document.createElement('option');
        opt.value = o.name; opt.textContent = o.name;
        ownerSel.appendChild(opt);
      });
      // Restore
      $('#filter_search').value = load('ct_filter_search', '');
      $('#filter_batch').value = load('ct_filter_batch', '');
      $('#filter_owner').value = load('ct_filter_owner', '');
      $('#filter_icp').value = load('ct_filter_icp', '');
      $('#filter_msg_status').value = load('ct_filter_msg_status', '');
      resetAndLoad();
    }).catch(function(err) {
      showToast('Error loading filters: ' + err.message, 'error');
      resetAndLoad();
    });
  }

  // ---- Virtual scroll ----
  var ROW_HEIGHT = 41;
  var BUFFER = 20;
  var visibleRange = { start: 0, end: 0 };
  var rafPending = false;

  function updateScrollStatus() {
    var el_ = $('#scroll_status');
    if (state.total === 0 && !state.isLoading) {
      el_.textContent = '';
      return;
    }
    var loaded = state.items.length;
    el_.innerHTML = '<span class="count">Loaded ' + loaded.toLocaleString() + ' of ' + state.total.toLocaleString() + ' contacts</span>';
  }

  function createRow(c) {
    var tr = el('tr', { onClick: function() { openDetail(c.id); } });
    tr.appendChild(el('td', null, c.full_name || '-'));
    tr.appendChild(el('td', null, c.job_title || '-'));
    tr.appendChild(el('td', null, c.company_name || '-'));
    tr.appendChild(el('td', null, c.email_address || '-'));
    tr.appendChild(el('td', null, c.contact_score != null ? String(c.contact_score) : '-'));

    var icpTd = el('td');
    if (c.icp_fit) {
      icpTd.appendChild(el('span', { className: 'icp-badge ' + icpClass(c.icp_fit) }, c.icp_fit));
    } else {
      icpTd.textContent = '-';
    }
    tr.appendChild(icpTd);

    var msgTd = el('td');
    if (c.message_status) {
      msgTd.appendChild(el('span', { className: 'msg-status-badge ' + msgStatusClass(c.message_status) }, c.message_status));
    } else {
      msgTd.textContent = '-';
    }
    tr.appendChild(msgTd);

    tr.appendChild(el('td', null, c.owner_name || '-'));
    tr.appendChild(el('td', null, c.batch_name || '-'));
    return tr;
  }

  function spacerRow(height) {
    var tr = document.createElement('tr');
    tr.style.height = height + 'px';
    var td = document.createElement('td');
    td.colSpan = 9;
    td.style.padding = '0';
    td.style.border = 'none';
    td.style.lineHeight = '0';
    tr.appendChild(td);
    return tr;
  }

  function renderWindow() {
    if (state.items.length === 0) return;
    var container = $('#scroll_container');
    var scrollTop = container.scrollTop;
    var viewportH = container.clientHeight;

    var start = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - BUFFER);
    var end = Math.min(state.items.length, Math.ceil((scrollTop + viewportH) / ROW_HEIGHT) + BUFFER);

    if (start === visibleRange.start && end === visibleRange.end) return;
    visibleRange = { start: start, end: end };

    var tbody = $('#table_body');
    tbody.textContent = '';

    if (start > 0) tbody.appendChild(spacerRow(start * ROW_HEIGHT));

    for (var i = start; i < end; i++) {
      tbody.appendChild(createRow(state.items[i]));
    }

    if (end < state.items.length) tbody.appendChild(spacerRow((state.items.length - end) * ROW_HEIGHT));
  }

  function onScroll() {
    if (!rafPending) {
      rafPending = true;
      requestAnimationFrame(function() {
        rafPending = false;
        renderWindow();
      });
    }
  }

  // ---- Fetch contacts (append to state.items) ----
  function loadMore() {
    if (state.isLoading || !state.hasMore) return;
    state.isLoading = true;

    var params = [];
    params.push('page=' + state.page);
    params.push('page_size=' + state.pageSize);
    params.push('sort=' + encodeURIComponent(state.sort));
    params.push('sort_dir=' + encodeURIComponent(state.sortDir));

    var search = $('#filter_search').value.trim();
    if (search) params.push('search=' + encodeURIComponent(search));
    var batch = $('#filter_batch').value;
    if (batch) params.push('batch_name=' + encodeURIComponent(batch));
    var owner = $('#filter_owner').value;
    if (owner) params.push('owner_name=' + encodeURIComponent(owner));
    var icp = $('#filter_icp').value;
    if (icp) params.push('icp_fit=' + encodeURIComponent(icp));
    var msgStatus = $('#filter_msg_status').value;
    if (msgStatus) params.push('message_status=' + encodeURIComponent(msgStatus));

    save('ct_filter_search', search);
    save('ct_filter_batch', batch);
    save('ct_filter_owner', owner);
    save('ct_filter_icp', icp);
    save('ct_filter_msg_status', msgStatus);

    var sentinel = $('#scroll_sentinel');
    if (state.page === 1) {
      $('#table_body').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:24px;"><span class="loading-sm"></span> Loading...</td></tr>';
    } else {
      sentinel.innerHTML = '<div class="scroll-loader"><span class="loading-sm"></span></div>';
    }

    apiFetch(API_BASE + '/contacts?' + params.join('&')).then(function(data) {
      state.total = data.total;

      if (data.contacts.length === 0 && state.page === 1) {
        $('#table_body').innerHTML = '<tr><td colspan="9" class="empty-state"><div class="big">&#128100;</div>No contacts match your filters.</td></tr>';
        state.hasMore = false;
      } else {
        state.items = state.items.concat(data.contacts);
        state.page++;
        state.hasMore = state.items.length < data.total;
        visibleRange = { start: 0, end: 0 };
        renderWindow();
      }

      updateScrollStatus();
      sentinel.innerHTML = state.hasMore ? '' : (state.items.length > 0 ? '<div class="scroll-end">All contacts loaded</div>' : '');
      state.isLoading = false;
    }).catch(function(err) {
      if (state.page === 1) {
        $('#table_body').innerHTML = '<tr><td colspan="9" class="empty-state">Error: ' + err.message + '</td></tr>';
      }
      sentinel.innerHTML = '';
      state.isLoading = false;
    });
  }

  function resetAndLoad() {
    state.page = 1;
    state.items = [];
    state.hasMore = true;
    visibleRange = { start: 0, end: 0 };
    $('#table_body').textContent = '';
    $('#scroll_container').scrollTop = 0;
    loadMore();
  }

  // ---- Sorting ----
  function setupSorting() {
    var ths = document.querySelectorAll('.data-table th[data-sort]');
    ths.forEach(function(th) {
      th.addEventListener('click', function() {
        var col = th.getAttribute('data-sort');
        if (state.sort === col) {
          state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sort = col;
          state.sortDir = 'asc';
        }
        updateSortArrows();
        resetAndLoad();
      });
    });
  }

  function updateSortArrows() {
    var ths = document.querySelectorAll('.data-table th[data-sort]');
    ths.forEach(function(th) {
      var arrow = th.querySelector('.sort-arrow');
      var col = th.getAttribute('data-sort');
      if (col === state.sort) {
        arrow.textContent = state.sortDir === 'asc' ? '\u25B2' : '\u25BC';
      } else {
        arrow.textContent = '';
      }
    });
  }

  // ---- Detail modal ----
  function openDetail(contactId) {
    var body = $('#modal_body');
    body.innerHTML = '<div style="text-align:center;padding:40px;"><span class="loading-sm"></span> Loading...</div>';
    showModal();

    apiFetch(API_BASE + '/contacts/' + contactId).then(function(c) {
      $('#modal_title').textContent = c.full_name || 'Contact Detail';
      renderDetail(c);
    }).catch(function(err) {
      body.innerHTML = '<div class="empty-state">Error loading contact: ' + err.message + '</div>';
    });
  }

  function renderDetail(c) {
    var body = $('#modal_body');
    body.textContent = '';

    // Header
    var header = el('div', { className: 'detail-section' });
    var hg = el('div', { className: 'detail-grid' });
    hg.appendChild(field('Full Name', c.full_name));
    hg.appendChild(field('Job Title', c.job_title));
    if (c.linkedin_url) {
      hg.appendChild(fieldLink('LinkedIn', c.linkedin_url));
    }
    if (c.profile_photo_url) {
      hg.appendChild(field('Photo', c.profile_photo_url));
    }
    header.appendChild(hg);
    body.appendChild(header);

    // Company link
    if (c.company) {
      var coSec = section('Company');
      var coLink = el('button', { className: 'link-btn', onClick: function() {
        var ns = LeadgenAuth.getNamespace ? LeadgenAuth.getNamespace() : '';
        var prefix = ns ? '/' + ns + '/' : '';
        window.location.href = prefix + 'companies?open=' + c.company.id;
      }}, c.company.name + (c.company.domain ? ' (' + c.company.domain + ')' : ''));
      coSec.appendChild(coLink);
      if (c.company.status || c.company.tier) {
        var meta = el('div', { style: { marginTop: '6px', fontSize: '0.82rem', color: 'var(--text-muted)' } });
        if (c.company.status) meta.appendChild(document.createTextNode('Status: ' + c.company.status));
        if (c.company.tier) meta.appendChild(document.createTextNode(' | Tier: ' + c.company.tier));
        coSec.appendChild(meta);
      }
      body.appendChild(coSec);
    }

    // Contact info
    var info = section('Contact Info');
    var ig = el('div', { className: 'detail-grid' });
    ig.appendChild(field('Email', c.email_address));
    ig.appendChild(field('Phone', c.phone_number));
    ig.appendChild(field('City', c.location_city));
    ig.appendChild(field('Country', c.location_country));
    info.appendChild(ig);
    body.appendChild(info);

    // Classification (with editable fields)
    var classif = section('Classification');
    var cg = el('div', { className: 'detail-grid' });
    cg.appendChild(editableSelect('Seniority', 'seniority_level', c.seniority_level, ['', 'C-Level', 'VP', 'Director', 'Manager', 'Individual Contributor', 'Founder', 'Other']));
    cg.appendChild(editableSelect('Department', 'department', c.department, ['', 'Executive', 'Engineering', 'Product', 'Sales', 'Marketing', 'Customer Success', 'Finance', 'HR', 'Operations', 'Other']));
    cg.appendChild(editableSelect('ICP Fit', 'icp_fit', c.icp_fit, ['', 'Strong Fit', 'Moderate Fit', 'Weak Fit', 'Unknown']));
    cg.appendChild(editableSelect('Relationship', 'relationship_status', c.relationship_status, ['', 'Prospect', 'Active', 'Dormant', 'Former', 'Partner', 'Internal']));
    cg.appendChild(editableSelect('Source', 'contact_source', c.contact_source, ['', 'Inbound', 'Outbound', 'Referral', 'Event', 'Social', 'Other']));
    cg.appendChild(editableSelect('Language', 'language', c.language, ['', 'English', 'German', 'Dutch', 'Czech']));
    cg.appendChild(field('Message Status', c.message_status));
    classif.appendChild(cg);
    body.appendChild(classif);

    // Scores
    var scores = section('Scores');
    var sg = el('div', { className: 'detail-grid' });
    sg.appendChild(field('Contact Score', c.contact_score));
    sg.appendChild(field('AI Champion', c.ai_champion ? 'Yes (Score: ' + (c.ai_champion_score || '-') + ')' : 'No'));
    sg.appendChild(field('Authority Score', c.authority_score));
    sg.appendChild(field('Enrichment Cost', c.enrichment_cost_usd != null ? '$' + c.enrichment_cost_usd.toFixed(4) : null));
    scores.appendChild(sg);
    body.appendChild(scores);

    // Enrichment
    if (c.enrichment) {
      var enrich = section('Person Enrichment');
      var fields = ['person_summary', 'linkedin_profile_summary', 'relationship_synthesis'];
      fields.forEach(function(f) {
        if (c.enrichment[f]) {
          var block = el('div', { className: 'enrich-block' });
          block.appendChild(el('label', null, f.replace(/_/g, ' ')));
          block.appendChild(el('div', { className: 'enrich-text' }, c.enrichment[f]));
          enrich.appendChild(block);
        }
      });
      if (c.enrichment.enriched_at) {
        enrich.appendChild(el('div', { style: { fontSize: '0.75rem', color: 'var(--text-dim)', marginTop: '8px' } },
          'Enriched: ' + new Date(c.enrichment.enriched_at).toLocaleDateString() +
          (c.enrichment.enrichment_cost_usd != null ? ' | Cost: $' + c.enrichment.enrichment_cost_usd.toFixed(4) : '')));
      }
      body.appendChild(enrich);
    }

    // Notes (editable)
    var notesSec = section('Notes');
    var ng = el('div', { className: 'detail-grid' });
    ng.appendChild(fieldText('Notes', 'notes', c.notes));
    notesSec.appendChild(ng);
    body.appendChild(notesSec);

    // Save button
    var saveRow = el('div', { style: { display: 'flex', gap: '8px', marginBottom: '24px' } });
    var saveBtn = el('button', { className: 'btn btn-sm btn-success', id: 'save_contact_btn', onClick: function() { saveContact(c.id); } }, 'Save Changes');
    var saveStatus = el('span', { id: 'save_status', style: { alignSelf: 'center', fontSize: '0.82rem', color: 'var(--text-muted)' } });
    saveRow.appendChild(saveBtn);
    saveRow.appendChild(saveStatus);
    body.appendChild(saveRow);

    // Messages mini-table
    if (c.messages && c.messages.length > 0) {
      var msgSec = section('Messages (' + c.messages.length + ')');
      var table = el('table', { className: 'mini-table' });
      var thead = el('thead');
      var hrow = el('tr');
      ['Channel', 'Step', 'Variant', 'Subject', 'Status'].forEach(function(h) { hrow.appendChild(el('th', null, h)); });
      thead.appendChild(hrow);
      table.appendChild(thead);
      var mtbody = el('tbody');
      c.messages.forEach(function(m) {
        var tr = el('tr');
        tr.appendChild(el('td', null, m.channel || '-'));
        tr.appendChild(el('td', null, String(m.sequence_step || 1)));
        tr.appendChild(el('td', null, m.variant || '-'));
        tr.appendChild(el('td', null, m.subject || '-'));
        tr.appendChild(el('td', null, m.status || '-'));
        mtbody.appendChild(tr);
      });
      table.appendChild(mtbody);
      msgSec.appendChild(table);
      body.appendChild(msgSec);
    }

    // Status flags
    var flags = section('Status Flags');
    var fg = el('div', { className: 'detail-grid' });
    fg.appendChild(field('Processed', c.processed_enrich ? 'Yes' : 'No'));
    fg.appendChild(field('Email Lookup', c.email_lookup ? 'Yes' : 'No'));
    fg.appendChild(field('Duplicity Check', c.duplicity_check ? 'Yes' : 'No'));
    fg.appendChild(field('Duplicity Conflict', c.duplicity_conflict ? 'Yes' : 'No'));
    if (c.duplicity_detail) fg.appendChild(fieldFull('Duplicity Detail', c.duplicity_detail));
    if (c.error) fg.appendChild(fieldFull('Error', c.error));
    flags.appendChild(fg);
    body.appendChild(flags);

    // Timestamps
    var meta = el('div', { style: { fontSize: '0.75rem', color: 'var(--text-dim)', borderTop: '1px solid var(--border)', paddingTop: '12px', marginTop: '8px' } });
    if (c.created_at) meta.appendChild(el('div', null, 'Created: ' + new Date(c.created_at).toLocaleString()));
    if (c.updated_at) meta.appendChild(el('div', null, 'Updated: ' + new Date(c.updated_at).toLocaleString()));
    body.appendChild(meta);
  }

  // ---- Helpers ----
  function field(label, value) {
    var div = el('div', { className: 'detail-field' });
    div.appendChild(el('label', null, label));
    div.appendChild(el('div', { className: 'value' + (value == null || value === '' ? ' empty' : '') }, value != null && value !== '' ? String(value) : '-'));
    return div;
  }

  function fieldFull(label, value) {
    var div = el('div', { className: 'detail-field full' });
    div.appendChild(el('label', null, label));
    div.appendChild(el('div', { className: 'value' }, value || '-'));
    return div;
  }

  function fieldLink(label, url) {
    var div = el('div', { className: 'detail-field' });
    div.appendChild(el('label', null, label));
    var a = el('a', { href: url, target: '_blank', style: { color: 'var(--accent-cyan)', fontSize: '0.88rem' } }, 'Profile');
    div.appendChild(a);
    return div;
  }

  function fieldText(label, name, value) {
    var div = el('div', { className: 'detail-field full' });
    div.appendChild(el('label', null, label));
    var ta = el('textarea', { 'data-field': name });
    ta.value = value || '';
    div.appendChild(ta);
    return div;
  }

  function editableSelect(label, name, value, options) {
    var div = el('div', { className: 'detail-field' });
    div.appendChild(el('label', null, label));
    var sel = el('select', { 'data-field': name });
    options.forEach(function(o) {
      var opt = el('option', { value: o }, o || '(none)');
      if (o === value) opt.selected = true;
      sel.appendChild(opt);
    });
    div.appendChild(sel);
    return div;
  }

  function section(title) {
    var div = el('div', { className: 'detail-section' });
    div.appendChild(el('div', { className: 'detail-section-title' }, title));
    return div;
  }

  // ---- Save contact ----
  function saveContact(contactId) {
    var fields = {};
    var selects = document.querySelectorAll('#modal_body select[data-field]');
    selects.forEach(function(sel) {
      var name = sel.getAttribute('data-field');
      fields[name] = sel.value || null;
    });
    var textareas = document.querySelectorAll('#modal_body textarea[data-field]');
    textareas.forEach(function(ta) {
      var name = ta.getAttribute('data-field');
      fields[name] = ta.value || null;
    });

    // Reverse map display values to DB enums
    var reverseMap = {
      seniority_level: { 'C-Level': 'c_level', 'VP': 'vp', 'Director': 'director', 'Manager': 'manager', 'Individual Contributor': 'individual_contributor', 'Founder': 'founder', 'Other': 'other' },
      department: { 'Executive': 'executive', 'Engineering': 'engineering', 'Product': 'product', 'Sales': 'sales', 'Marketing': 'marketing', 'Customer Success': 'customer_success', 'Finance': 'finance', 'HR': 'hr', 'Operations': 'operations', 'Other': 'other' },
      icp_fit: { 'Strong Fit': 'strong_fit', 'Moderate Fit': 'moderate_fit', 'Weak Fit': 'weak_fit', 'Unknown': 'unknown' },
      relationship_status: { 'Prospect': 'prospect', 'Active': 'active', 'Dormant': 'dormant', 'Former': 'former', 'Partner': 'partner', 'Internal': 'internal' },
      contact_source: { 'Inbound': 'inbound', 'Outbound': 'outbound', 'Referral': 'referral', 'Event': 'event', 'Social': 'social', 'Other': 'other' },
      language: { 'English': 'en', 'German': 'de', 'Dutch': 'nl', 'Czech': 'cs' }
    };

    Object.keys(reverseMap).forEach(function(k) {
      if (fields[k] && reverseMap[k][fields[k]]) {
        fields[k] = reverseMap[k][fields[k]];
      }
    });

    var statusEl = $('#save_status');
    statusEl.textContent = 'Saving...';
    var btn = $('#save_contact_btn');
    btn.disabled = true;

    apiFetch(API_BASE + '/contacts/' + contactId, {
      method: 'PATCH',
      body: JSON.stringify(fields)
    }).then(function() {
      statusEl.textContent = '';
      showToast('Contact updated', 'success');
      resetAndLoad();
    }).catch(function(err) {
      statusEl.textContent = '';
      showToast('Error: ' + err.message, 'error');
    }).finally(function() {
      btn.disabled = false;
    });
  }

  // ---- Modal ----
  function showModal() { $('#modal_overlay').classList.add('open'); }
  function hideModal() { $('#modal_overlay').classList.remove('open'); }

  // ---- Filter handlers ----
  function setupFilters() {
    var debounceTimer;
    $('#filter_search').addEventListener('input', function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(function() { resetAndLoad(); }, 400);
    });
    ['filter_batch', 'filter_owner', 'filter_icp', 'filter_msg_status'].forEach(function(id) {
      $('#' + id).addEventListener('change', function() { resetAndLoad(); });
    });
  }

  // ---- Init ----
  function initContacts() {
    setupSorting();
    updateSortArrows();
    setupFilters();
    loadFilterOptions();

    $('#modal_close').addEventListener('click', hideModal);
    $('#modal_overlay').addEventListener('click', function(e) {
      if (e.target === $('#modal_overlay')) hideModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') hideModal();
    });

    // Virtual scroll + infinite load
    var scrollContainer = $('#scroll_container');
    var sentinel = $('#scroll_sentinel');
    scrollContainer.addEventListener('scroll', onScroll);
    var observer = new IntersectionObserver(function(entries) {
      if (entries[0].isIntersecting && !state.isLoading && state.hasMore) {
        loadMore();
      }
    }, { root: scrollContainer, rootMargin: '200px' });
    observer.observe(sentinel);

    // Auto-open from query param
    var params = new URLSearchParams(window.location.search);
    var openId = params.get('open');
    if (openId) {
      setTimeout(function() { openDetail(openId); }, 500);
    }
  }

  function init() {
    LeadgenAuth.init(initContacts);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
</body>
</html>
