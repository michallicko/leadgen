<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enrich Pipeline — Leadgen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="nav.css">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0D0F14;
  --surface: #14171E;
  --surface-alt: #1A1E28;
  --border: rgba(110,44,139,0.15);
  --border-solid: #231D30;
  --text: #E8EAF0;
  --text-muted: #8B92A0;
  --text-dim: #5A6170;
  --accent: #6E2C8B;
  --accent-hover: #8B47A8;
  --accent-cyan: #00B8CF;
  --success: #34D399;
  --error: #F87171;
  --warning: #FBBF24;
  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
  --font-title: 'Lexend Deca', -apple-system, sans-serif;
  --font-body: 'Work Sans', -apple-system, sans-serif;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, #4A1D5E, #6E2C8B 40%, #00B8CF);
  z-index: 100;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(110,44,139,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(110,44,139,.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: -1;
}

/* Layout */
.container { max-width: 960px; margin: 0 auto; padding: 32px 16px; }
h1 { font-family: var(--font-title); font-size: 1.3rem; font-weight: 600; margin-bottom: 6px; letter-spacing: -0.01em; }
.subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 24px; }

/* Card */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
}
.card-title {
  font-family: var(--font-title); font-size: 0.85rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.03em;
  color: var(--text-muted); margin-bottom: 12px;
}

/* Buttons */
.btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 6px; padding: 10px 20px; border-radius: var(--radius);
  font-family: var(--font-body); font-size: 0.85rem; font-weight: 600;
  cursor: pointer; border: none; transition: var(--transition); text-decoration: none;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-success { background: var(--success); color: #0D0F14; }
.btn-success:hover { filter: brightness(1.1); }
.btn-success:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-ghost { background: transparent; border: 1px solid var(--border-solid); color: var(--text-muted); }
.btn-ghost:hover { border-color: var(--accent); color: var(--text); }
.btn-error { background: var(--error); color: #0D0F14; }
.btn-error:hover { filter: brightness(1.1); }
.btn-error:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-sm { padding: 6px 14px; font-size: 0.78rem; }

/* Form */
.form-row { margin-bottom: 14px; }
.form-row label { display: block; font-size: 0.78rem; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; }
.form-row select, .form-row input[type="text"] {
  width: 100%; padding: 8px 12px; background: var(--bg);
  border: 1px solid var(--border-solid); border-radius: var(--radius);
  color: var(--text); font-family: var(--font-body); font-size: 0.85rem;
}
.form-row select:focus, .form-row input:focus { outline: none; border-color: var(--accent); }

/* Filter bar */
.filter-bar { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
.filter-bar .form-row { margin-bottom: 0; flex: 1; min-width: 140px; }

/* Tier chips */
.tier-chips { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
.tier-chip {
  display: inline-flex; align-items: center; padding: 4px 10px;
  border-radius: 10px; font-size: 0.72rem; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border-solid);
  background: transparent; color: var(--text-dim);
  transition: var(--transition); user-select: none;
}
.tier-chip input { display: none; }
.tier-chip.active { background: rgba(52,211,153,0.12); color: var(--success); border-color: rgba(52,211,153,0.3); }

/* Toggle switch */
.toggle { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; cursor: pointer; inset: 0;
  background: var(--surface); border: 1px solid var(--border-solid);
  border-radius: 10px; transition: var(--transition);
}
.toggle-slider::before {
  content: ''; position: absolute; height: 14px; width: 14px;
  left: 2px; bottom: 2px; background: var(--text-dim);
  border-radius: 50%; transition: var(--transition);
}
.toggle input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
.toggle input:checked + .toggle-slider::before { background: #fff; transform: translateX(16px); }
.toggle input:disabled + .toggle-slider { opacity: 0.3; cursor: not-allowed; }

/* Callout */
.callout {
  padding: 12px 16px; background: rgba(0,184,207,0.06);
  border: 1px solid rgba(0,184,207,0.15); border-radius: var(--radius);
  font-size: 0.82rem; color: var(--text-muted); margin-bottom: 16px;
}

/* Hidden */
.hidden { display: none !important; }

/* Spinner */
.loading-sm {
  width: 20px; height: 20px;
  border: 2px solid var(--border-solid);
  border-top-color: var(--accent-cyan);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block; vertical-align: middle; margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== DAG CONTROLS ===== */
.dag-controls {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px; background: var(--surface);
  border: 1px solid var(--border); border-radius: var(--radius-lg);
  margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
}
.dag-controls__info { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.dag-controls__info-item { font-size: 0.82rem; color: var(--text-muted); }
.dag-controls__info-item strong { color: var(--text); font-weight: 600; }
.dag-controls__cost { font-family: var(--font-title); font-size: 1.1rem; font-weight: 700; color: var(--accent-cyan); }
.dag-controls__actions { display: flex; gap: 8px; align-items: center; }

/* ===== DAG VERTICAL LAYOUT ===== */
.dag-wrapper {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 32px 24px;
  margin-bottom: 16px;
}

.dag-container {
  position: relative;
}

.dag-rows {
  display: flex;
  flex-direction: column;
  gap: 48px;
  align-items: center;
  position: relative;
  z-index: 2;
}

.dag-row {
  display: flex;
  gap: 16px;
  justify-content: center;
  flex-wrap: wrap;
}

/* SVG edge layer */
.dag-edges {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 1;
  pointer-events: none;
}

/* ===== DAG NODE ===== */
.dag-node {
  width: 180px;
  max-width: 200px;
  background: var(--surface-alt);
  border: 1px solid var(--border-solid);
  border-radius: var(--radius);
  padding: 10px 12px;
  transition: border-color 0.3s, box-shadow 0.3s, opacity 0.3s;
  position: relative;
}

.dag-node__header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}

.dag-node__icon {
  width: 28px; height: 28px;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-weight: 700;
  flex-shrink: 0;
}

.dag-node__name {
  font-family: var(--font-title);
  font-size: 0.7rem;
  font-weight: 600;
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.dag-node__badge {
  display: inline-block;
  padding: 1px 5px;
  border-radius: 4px;
  font-size: 0.58rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.dag-node__stats {
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.dag-node__fields {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  margin-top: 6px;
}

.dag-node__field-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 3px;
  font-size: 0.6rem;
  font-weight: 500;
  background: rgba(255,255,255,0.04);
  color: var(--text-dim);
  border: 1px solid rgba(255,255,255,0.06);
}

.dag-node__progress { margin-top: 6px; }

.dag-node__bar-wrap {
  height: 4px;
  background: rgba(255,255,255,0.06);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 4px;
}

.dag-node__bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
  width: 0%;
}

.dag-node__counts {
  display: flex;
  justify-content: space-between;
  font-size: 0.68rem;
  color: var(--text-dim);
}

.dag-node__counts .cost { color: var(--accent-cyan); }

/* Node soft dep badges */
.dag-node__soft-deps {
  display: flex;
  flex-direction: column;
  gap: 3px;
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid var(--border);
}

.soft-dep-badge {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.65rem;
  color: var(--text-dim);
  cursor: pointer;
  user-select: none;
}

.soft-dep-badge__dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  transition: var(--transition);
}

.soft-dep-badge.active .soft-dep-badge__dot { background: var(--accent-cyan); }
.soft-dep-badge:not(.active) .soft-dep-badge__dot { background: var(--text-dim); opacity: 0.4; }
.soft-dep-badge:not(.active) { text-decoration: line-through; opacity: 0.5; }

.dag-node__status-icon {
  position: absolute;
  top: -6px; right: -6px;
  width: 18px; height: 18px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.6rem; font-weight: 700;
  z-index: 3;
}

/* ===== NODE STATES ===== */
.dag-node[data-state="disabled"] { opacity: 0.25; pointer-events: none; }
.dag-node[data-state="pending"] { border-style: dashed; border-color: var(--text-dim); }
.dag-node[data-state="eligible"] { border-color: var(--accent); box-shadow: 0 0 12px -4px rgba(110,44,139,0.3); }
.dag-node[data-state="running"] { border-color: var(--accent-cyan); box-shadow: 0 0 16px -4px rgba(0,184,207,0.4); animation: nodeGlow 2s ease-in-out infinite; }
.dag-node[data-state="completed"] { border-color: var(--success); box-shadow: 0 0 12px -4px rgba(52,211,153,0.3); }
.dag-node[data-state="failed"] { border-color: var(--error); box-shadow: 0 0 12px -4px rgba(248,113,113,0.3); }

.dag-node[data-state="completed"] .dag-node__status-icon { background: var(--success); color: #0D0F14; }
.dag-node[data-state="failed"] .dag-node__status-icon { background: var(--error); color: #fff; }
.dag-node[data-state="running"] .dag-node__status-icon { background: var(--accent-cyan); color: #0D0F14; }

@keyframes nodeGlow {
  0%, 100% { box-shadow: 0 0 16px -4px rgba(0,184,207,0.4); }
  50% { box-shadow: 0 0 24px -2px rgba(0,184,207,0.6); }
}

/* Barberpole progress */
.dag-node[data-state="running"] .dag-node__bar-fill {
  background-image: linear-gradient(
    -45deg,
    rgba(255,255,255,0.15) 25%, transparent 25%,
    transparent 50%, rgba(255,255,255,0.15) 50%,
    rgba(255,255,255,0.15) 75%, transparent 75%
  );
  background-size: 12px 12px;
  animation: barberpole 0.6s linear infinite;
}

@keyframes barberpole { to { background-position: 12px 0; } }

/* ===== EDGE STATES ===== */
.dag-edge { fill: none; stroke-width: 1.5; transition: stroke 0.3s, opacity 0.3s; }
.dag-edge--inactive { stroke: var(--border-solid); stroke-dasharray: 4 4; opacity: 0.4; }
.dag-edge--pending { stroke: var(--text-dim); stroke-dasharray: 6 4; opacity: 0.5; }
.dag-edge--active { stroke: var(--accent-cyan); stroke-dasharray: 8 12; stroke-width: 2; animation: flowDash 0.8s linear infinite; }
.dag-edge--completed { stroke: var(--success); stroke-width: 2; opacity: 0.8; }
.dag-edge--failed { stroke: var(--error); stroke-dasharray: 4 4; opacity: 0.6; }
.dag-edge--soft { stroke-dasharray: 3 6; opacity: 0.4; }
.dag-edge--soft.dag-edge--active { stroke-dasharray: 3 6; opacity: 0.7; }

@keyframes flowDash { to { stroke-dashoffset: -20; } }

/* Status pills */
.pill {
  display: inline-block; padding: 2px 8px;
  border-radius: 10px; font-size: 0.7rem;
  font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.03em;
}
.pill-pending { background: rgba(90,97,112,0.2); color: var(--text-dim); }
.pill-running { background: rgba(0,184,207,0.15); color: var(--accent-cyan); }
.pill-completed { background: rgba(52,211,153,0.15); color: var(--success); }
.pill-failed { background: rgba(248,113,113,0.15); color: var(--error); }
.pill-stopped { background: rgba(251,191,36,0.15); color: var(--warning); }

/* Completion panel */
.completion-panel {
  text-align: center;
  padding: 24px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-top: 16px;
}

/* DAG summary row */
.dag-summary { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; }
.dag-summary__item { display: flex; align-items: center; gap: 6px; font-size: 0.78rem; color: var(--text-muted); }
.dag-summary__dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* Responsive */
@media (max-width: 768px) {
  .dag-rows { gap: 32px; }
  .dag-row { flex-direction: column; align-items: center; }
  .dag-edges { display: none; }
  .dag-node { max-width: 280px; width: 100%; }
  .dag-controls { flex-direction: column; text-align: center; }
  .dag-controls__actions { justify-content: center; }
  .filter-bar { flex-direction: column; }
}

@media (max-width: 640px) { .container { padding: 16px 8px; } }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
</style>
</head>
<body data-pillar="radar" data-page="enrich">

<div id="app-nav"></div>

<div class="container">
  <h1>Enrichment Pipeline</h1>
  <div class="subtitle" id="page_subtitle">Configure and run the DAG enrichment pipeline.</div>

  <!-- Filters (always visible) -->
  <div class="card">
    <div class="card-title">Filters</div>
    <div id="import_callout" class="callout hidden"></div>
    <div class="filter-bar">
      <div class="form-row" style="min-width:160px;">
        <label for="batch_select">Batch</label>
        <select id="batch_select"><option value="">Loading...</option></select>
      </div>
      <div class="form-row" style="min-width:130px;">
        <label for="owner_select">Owner</label>
        <select id="owner_select"><option value="">All owners</option></select>
      </div>
      <div class="form-row" style="min-width:180px;">
        <label>Tier Filter</label>
        <div class="tier-chips" id="tier_chips">
          <label class="tier-chip active"><input type="checkbox" name="tier" value="Tier 1" checked> T1</label>
          <label class="tier-chip active"><input type="checkbox" name="tier" value="Tier 2" checked> T2</label>
          <label class="tier-chip active"><input type="checkbox" name="tier" value="Tier 3" checked> T3</label>
          <label class="tier-chip"><input type="checkbox" name="tier" value="Tier 4"> T4</label>
          <label class="tier-chip"><input type="checkbox" name="tier" value="Tier 5"> T5</label>
        </div>
      </div>
    </div>
  </div>

  <!-- DAG Controls -->
  <div class="dag-controls" id="dag_controls">
    <div class="dag-controls__info">
      <span class="dag-controls__info-item" id="dag_batch_info"></span>
      <span class="dag-controls__info-item">Est: <strong class="dag-controls__cost" id="dag_total_cost">$0.00</strong></span>
      <span class="dag-controls__info-item" id="dag_pipeline_status"></span>
    </div>
    <div class="dag-controls__actions">
      <button class="btn btn-success" id="btn_run" disabled>Run Enabled</button>
      <button class="btn btn-error btn-sm hidden" id="btn_stop_dag">Stop All</button>
    </div>
  </div>

  <!-- DAG Visualization -->
  <div class="dag-wrapper">
    <div class="dag-container" id="dag_container">
      <svg class="dag-edges" id="dag_edges"></svg>
      <div class="dag-rows" id="dag_rows"></div>
    </div>
  </div>

  <div class="dag-summary" id="dag_summary"></div>

  <div id="completion_panel" class="completion-panel hidden">
    <div id="completion_icon" style="font-size:2rem;margin-bottom:8px;"></div>
    <div id="completion_title" style="font-family:var(--font-title);font-size:1.1rem;font-weight:600;margin-bottom:6px;"></div>
    <div id="completion_detail" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;"></div>
    <div id="completion_actions" style="display:flex;gap:10px;justify-content:center;"></div>
  </div>
</div>

<script src="nav.js"></script>
<script src="auth.js"></script>
<script>
(function() {
  'use strict';

  var API_BASE = 'https://leadgen.visionvolve.com/api';
  var POLL_INTERVAL = 5000;
  var pollTimer = null;
  var currentPipelineRunId = null;
  var dagMode = 'configure'; // 'configure' | 'running' | 'completed'

  // --- Stage definitions for vertical DAG ---
  var DAG_STAGES = {
    l1:              { row: 0, icon: 'CP', color: '#00B8CF', bg: 'rgba(0,184,207,0.12)',    name: 'Company Profile',    available: true },
    l2:              { row: 1, icon: 'DR', color: '#8B47A8', bg: 'rgba(139,71,168,0.12)',    name: 'Deep Research',      available: true },
    signals:         { row: 1, icon: 'SS', color: '#F59E0B', bg: 'rgba(245,158,11,0.12)',    name: 'Strategic Signals',  available: false },
    registry:        { row: 1, icon: 'LR', color: '#3B82F6', bg: 'rgba(59,130,246,0.12)',    name: 'Legal & Registry',   available: true },
    news:            { row: 1, icon: 'NP', color: '#EC4899', bg: 'rgba(236,72,153,0.12)',    name: 'News & PR',          available: false },
    person:          { row: 2, icon: 'RE', color: '#34D399', bg: 'rgba(52,211,153,0.12)',    name: 'Role & Employment',  available: true },
    social:          { row: 2, icon: 'SO', color: '#A78BFA', bg: 'rgba(167,139,250,0.12)',   name: 'Social & Online',    available: false },
    career:          { row: 2, icon: 'CH', color: '#FB923C', bg: 'rgba(251,146,60,0.12)',    name: 'Career History',     available: false },
    contact_details: { row: 2, icon: 'CD', color: '#38BDF8', bg: 'rgba(56,189,248,0.12)',    name: 'Contact Details',    available: false },
    qc:              { row: 3, icon: 'QC', color: '#8B92A0', bg: 'rgba(139,146,160,0.12)',   name: 'Quality Check',      available: false }
  };

  var STAGE_ORDER = ['l1', 'l2', 'signals', 'registry', 'news', 'person', 'social', 'career', 'contact_details', 'qc'];

  var HARD_DEPS = {
    l1: [], l2: ['l1'], signals: ['l1'], registry: ['l1'], news: ['l1'],
    person: ['l1'], social: ['l1'], career: ['l1'], contact_details: ['l1'], qc: []
  };
  var SOFT_DEPS = {
    l1: [], l2: [], signals: [], registry: [], news: [],
    person: ['l2', 'signals'], social: ['l2', 'signals'], career: ['l2'], contact_details: [], qc: []
  };

  // State
  var enabledStages = {};
  var softDepsConfig = { person: true, social: true, career: true };
  var estimateData = null;
  var batchList = [];
  var stageStatus = {};

  // --- Utilities ---
  function $(sel) { return document.querySelector(sel); }
  function $$(sel) { return Array.prototype.slice.call(document.querySelectorAll(sel)); }

  function mkEl(tag, attrs, text) {
    var el = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(function(k) {
      if (k === 'className') el.className = attrs[k];
      else if (k === 'style' && typeof attrs[k] === 'string') el.setAttribute('style', attrs[k]);
      else el.setAttribute(k, attrs[k]);
    });
    if (text !== undefined) el.textContent = text;
    return el;
  }

  function mkSvg(tag, attrs) {
    var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    if (attrs) Object.keys(attrs).forEach(function(k) { el.setAttribute(k, attrs[k]); });
    return el;
  }

  function clearChildren(el) { while (el.firstChild) el.removeChild(el.firstChild); }

  function apiHeaders() {
    return {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + (LeadgenAuth.getToken ? LeadgenAuth.getToken() : ''),
      'X-Namespace': (LeadgenAuth.getNamespace ? LeadgenAuth.getNamespace() : '') || 'visionvolve'
    };
  }

  function apiFetch(url, opts) {
    var options = Object.assign({}, opts || {});
    options.headers = Object.assign({}, apiHeaders(), options.headers || {});
    return fetch(url, options).then(function(resp) {
      if (resp.status === 401) { LeadgenAuth.logout(); throw new Error('Auth expired'); }
      if (!resp.ok) return resp.json().then(function(d) { throw new Error(d.error || 'HTTP ' + resp.status); });
      return resp.json();
    });
  }

  function fmt$(val) { return '$' + (val || 0).toFixed(2); }

  function getParam(name) {
    var params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
  }

  function getTiers() {
    return $$('input[name="tier"]:checked').map(function(cb) { return cb.value; });
  }

  // --- Load batches and owners ---
  function loadBatchesAndOwners() {
    apiFetch(API_BASE + '/batches').then(function(data) {
      batchList = data.batches || data || [];
      var sel = $('#batch_select');
      clearChildren(sel);
      sel.appendChild(mkEl('option', { value: '' }, 'Select batch...'));
      batchList.forEach(function(b) {
        sel.appendChild(mkEl('option', { value: b.name }, b.name));
      });

      var urlBatch = getParam('batch_name');
      if (urlBatch) sel.value = urlBatch;

      var ownerSel = $('#owner_select');
      var uniqueOwners = {};
      batchList.forEach(function(b) {
        if (b.owners) {
          b.owners.forEach(function(o) { uniqueOwners[o.name] = o; });
        }
      });
      Object.values(uniqueOwners).forEach(function(o) {
        ownerSel.appendChild(mkEl('option', { value: o.name }, o.name));
      });

      var urlOwner = getParam('owner_name');
      if (urlOwner) ownerSel.value = urlOwner;

      var importJobId = getParam('import_job_id');
      if (importJobId && urlBatch) {
        var callout = $('#import_callout');
        callout.textContent = 'Enriching contacts imported into batch "' + urlBatch + '"';
        callout.classList.remove('hidden');
      }

      // Fetch estimate immediately if batch is selected
      if (sel.value) {
        fetchEstimate(function(data) { buildDAG(data); });
      } else {
        buildDAG(null);
      }
    }).catch(function(err) {
      console.error('Failed to load batches:', err);
    });
  }

  // --- Estimate ---
  function fetchEstimate(callback) {
    var batch = $('#batch_select').value;
    if (!batch) {
      estimateData = null;
      if (callback) callback(null);
      return;
    }

    var owner = $('#owner_select').value;
    var tiers = getTiers();
    var availableStages = STAGE_ORDER.filter(function(s) { return DAG_STAGES[s].available; });

    apiFetch(API_BASE + '/enrich/estimate', {
      method: 'POST',
      body: JSON.stringify({
        batch_name: batch,
        owner_name: owner || undefined,
        tier_filter: tiers,
        stages: availableStages
      })
    }).then(function(data) {
      estimateData = data;
      if (callback) callback(data);
      else updateDAGFromEstimate(data);
    }).catch(function(err) {
      console.error('Estimate failed:', err);
    });
  }

  // --- DAG building ---
  function buildDAG(data) {
    var container = $('#dag_rows');
    clearChildren(container);

    // Reset state
    enabledStages = {};
    stageStatus = {};

    updateBatchInfo();

    // Group stages by row
    var rows = {};
    STAGE_ORDER.forEach(function(code) {
      var stage = DAG_STAGES[code];
      var row = stage.row;
      if (!rows[row]) rows[row] = [];
      rows[row].push(code);
    });

    // Build rows
    var rowKeys = Object.keys(rows).sort(function(a, b) { return Number(a) - Number(b); });
    rowKeys.forEach(function(rowIdx) {
      var rowEl = mkEl('div', { className: 'dag-row' });
      rowEl.setAttribute('data-row', rowIdx);

      rows[rowIdx].forEach(function(code) {
        var stage = DAG_STAGES[code];
        var info = (data && data.stages && data.stages[code]) || {};
        var eligible = info.eligible_count || 0;
        var isAvailable = stage.available;
        var hasEligible = eligible > 0 && isAvailable;

        enabledStages[code] = hasEligible;

        var nodeEl = buildNode(code, stage, info, isAvailable);
        rowEl.appendChild(nodeEl);
      });

      container.appendChild(rowEl);
    });

    updateTotalCost();
    requestAnimationFrame(function() {
      requestAnimationFrame(function() { drawEdges(); });
    });
  }

  function buildNode(code, stage, info, isAvailable) {
    var eligible = (info && info.eligible_count) || 0;
    var hasEligible = eligible > 0 && isAvailable;
    var fields = (info && info.fields) || [];

    var nodeEl = mkEl('div', { className: 'dag-node' });
    nodeEl.setAttribute('data-stage', code);
    nodeEl.setAttribute('data-state', !isAvailable ? 'disabled' : (hasEligible ? 'eligible' : 'pending'));

    // Status icon (hidden until running/completed/failed)
    var statusIcon = mkEl('div', { className: 'dag-node__status-icon hidden' });
    nodeEl.appendChild(statusIcon);

    // Header: icon + name + toggle
    var header = mkEl('div', { className: 'dag-node__header' });

    var iconEl = mkEl('div', { className: 'dag-node__icon', style: 'background:' + stage.bg + ';color:' + stage.color + ';' }, stage.icon);
    header.appendChild(iconEl);

    var nameEl = mkEl('div', { className: 'dag-node__name' }, stage.name);
    header.appendChild(nameEl);

    if (!isAvailable) {
      header.appendChild(mkEl('span', { className: 'dag-node__badge', style: 'background:rgba(90,97,112,0.2);color:var(--text-dim);' }, 'Soon'));
    }

    // Toggle
    var toggle = mkEl('label', { className: 'toggle' });
    var input = mkEl('input', { type: 'checkbox' });
    input.checked = hasEligible;
    input.disabled = !isAvailable;
    input.setAttribute('data-toggle', code);
    input.addEventListener('change', function() {
      enabledStages[code] = this.checked;
      updateNodeState(code);
      updateTotalCost();
      drawEdges();
    });
    toggle.appendChild(input);
    toggle.appendChild(mkEl('span', { className: 'toggle-slider' }));
    header.appendChild(toggle);

    nodeEl.appendChild(header);

    // Stats line
    var statsEl = mkEl('div', { className: 'dag-node__stats' });
    statsEl.setAttribute('data-stats', code);
    if (isAvailable) {
      var statText = eligible + ' eligible';
      if (info && info.estimated_cost > 0) {
        statText += ' \u00B7 ' + fmt$(info.estimated_cost);
      } else if (info && info.cost_per_item === 0) {
        statText += ' \u00B7 free';
      }
      statsEl.textContent = statText;
    } else {
      statsEl.textContent = 'Coming soon';
    }
    nodeEl.appendChild(statsEl);

    // Field tags
    if (fields.length > 0) {
      var fieldsEl = mkEl('div', { className: 'dag-node__fields' });
      fieldsEl.setAttribute('data-fields', code);
      fields.forEach(function(f) {
        fieldsEl.appendChild(mkEl('span', { className: 'dag-node__field-tag' }, f));
      });
      nodeEl.appendChild(fieldsEl);
    }

    // Progress (hidden in configure mode)
    var progressEl = mkEl('div', { className: 'dag-node__progress hidden' });
    progressEl.setAttribute('data-progress', code);

    var barWrap = mkEl('div', { className: 'dag-node__bar-wrap' });
    var barFill = mkEl('div', { className: 'dag-node__bar-fill', style: 'background:' + stage.color + ';' });
    barFill.setAttribute('data-bar', code);
    barWrap.appendChild(barFill);
    progressEl.appendChild(barWrap);

    var countsEl = mkEl('div', { className: 'dag-node__counts' });
    var doneEl = mkEl('span', {}, '0/0');
    doneEl.setAttribute('data-done', code);
    countsEl.appendChild(doneEl);
    var costEl = mkEl('span', { className: 'cost' }, '$0.00');
    costEl.setAttribute('data-node-cost', code);
    countsEl.appendChild(costEl);
    progressEl.appendChild(countsEl);

    nodeEl.appendChild(progressEl);

    // Soft dependency badges (only for person, generate)
    var softDeps = SOFT_DEPS[code] || [];
    if (softDeps.length > 0) {
      var sdContainer = mkEl('div', { className: 'dag-node__soft-deps' });
      softDeps.forEach(function(dep) {
        var depStage = DAG_STAGES[dep];
        var badgeEl = mkEl('div', { className: 'soft-dep-badge' + (softDepsConfig[code] !== false ? ' active' : '') });
        badgeEl.setAttribute('data-soft-dep', code + ':' + dep);

        badgeEl.appendChild(mkEl('span', { className: 'soft-dep-badge__dot' }));
        badgeEl.appendChild(mkEl('span', {}, 'Wait for ' + (depStage ? depStage.name.split(' ')[0] : dep)));

        badgeEl.addEventListener('click', function() {
          if (dagMode !== 'configure') return;
          var isActive = badgeEl.classList.contains('active');
          badgeEl.classList.toggle('active', !isActive);
          var allBadges = $$('[data-soft-dep^="' + code + ':"]');
          var anyActive = allBadges.some(function(b) { return b.classList.contains('active'); });
          softDepsConfig[code] = anyActive;
          drawEdges();
        });
        sdContainer.appendChild(badgeEl);
      });
      nodeEl.appendChild(sdContainer);
    }

    return nodeEl;
  }

  function updateDAGFromEstimate(data) {
    if (!data || !data.stages) return;

    updateBatchInfo();

    STAGE_ORDER.forEach(function(code) {
      var stage = DAG_STAGES[code];
      if (!stage.available) return;

      var info = data.stages[code] || {};
      var eligible = info.eligible_count || 0;
      var hasEligible = eligible > 0;

      // Update toggle
      var toggleInput = document.querySelector('[data-toggle="' + code + '"]');
      if (toggleInput && dagMode === 'configure') {
        toggleInput.checked = hasEligible;
        enabledStages[code] = hasEligible;
      }

      // Update stats
      var statsEl = document.querySelector('[data-stats="' + code + '"]');
      if (statsEl && dagMode === 'configure') {
        var statText = eligible + ' eligible';
        if (info.estimated_cost > 0) {
          statText += ' \u00B7 ' + fmt$(info.estimated_cost);
        } else if (info.cost_per_item === 0) {
          statText += ' \u00B7 free';
        }
        statsEl.textContent = statText;
      }

      // Update field tags
      var fieldsEl = document.querySelector('[data-fields="' + code + '"]');
      if (fieldsEl && info.fields && info.fields.length > 0) {
        clearChildren(fieldsEl);
        info.fields.forEach(function(f) {
          fieldsEl.appendChild(mkEl('span', { className: 'dag-node__field-tag' }, f));
        });
      }

      // Update state
      if (dagMode === 'configure') {
        updateNodeState(code);
      }
    });

    updateTotalCost();
    drawEdges();
  }

  function updateBatchInfo() {
    var batchInfoEl = $('#dag_batch_info');
    clearChildren(batchInfoEl);
    var batch = $('#batch_select').value;
    var owner = $('#owner_select').value;
    if (batch) {
      var batchStrong = mkEl('strong', {}, batch);
      batchInfoEl.appendChild(batchStrong);
      if (owner) {
        batchInfoEl.appendChild(document.createTextNode(' \u00B7 ' + owner));
      }
    } else {
      batchInfoEl.textContent = 'Select a batch';
    }
  }

  function updateNodeState(code) {
    var nodeEl = document.querySelector('[data-stage="' + code + '"]');
    if (!nodeEl) return;
    var stage = DAG_STAGES[code];

    if (!stage.available) {
      nodeEl.setAttribute('data-state', 'disabled');
      return;
    }

    if (dagMode === 'configure') {
      if (!enabledStages[code]) {
        nodeEl.setAttribute('data-state', 'disabled');
      } else {
        var info = estimateData && estimateData.stages && estimateData.stages[code];
        var eligible = info ? (info.eligible_count || 0) : 0;
        nodeEl.setAttribute('data-state', eligible > 0 ? 'eligible' : 'pending');
      }
    }
  }

  function updateTotalCost() {
    if (!estimateData) {
      $('#dag_total_cost').textContent = '$0.00';
      $('#btn_run').disabled = true;
      return;
    }
    var total = 0;
    STAGE_ORDER.forEach(function(code) {
      if (!enabledStages[code]) return;
      var info = estimateData.stages && estimateData.stages[code];
      if (info) total += (info.estimated_cost || 0);
    });
    $('#dag_total_cost').textContent = fmt$(total);

    var anyEnabled = Object.keys(enabledStages).some(function(s) { return enabledStages[s]; });
    $('#btn_run').disabled = !anyEnabled || dagMode !== 'configure';
  }

  // --- Vertical edge rendering ---
  function drawEdges() {
    var svg = $('#dag_edges');
    clearChildren(svg);

    var container = $('#dag_container');
    var containerRect = container.getBoundingClientRect();

    svg.setAttribute('width', String(container.scrollWidth));
    svg.setAttribute('height', String(container.scrollHeight));

    STAGE_ORDER.forEach(function(code) {
      var hardDeps = HARD_DEPS[code] || [];
      var softDeps = SOFT_DEPS[code] || [];

      hardDeps.forEach(function(dep) {
        drawEdge(svg, dep, code, 'hard', containerRect);
      });

      softDeps.forEach(function(dep) {
        var isEnabled = softDepsConfig[code] !== false;
        drawEdge(svg, dep, code, isEnabled ? 'soft-active' : 'soft', containerRect);
      });
    });
  }

  function drawEdge(svg, fromCode, toCode, type, containerRect) {
    var fromNode = document.querySelector('[data-stage="' + fromCode + '"]');
    var toNode = document.querySelector('[data-stage="' + toCode + '"]');
    if (!fromNode || !toNode) return;

    var fromEnabled = enabledStages[fromCode];
    var toEnabled = enabledStages[toCode];
    if (!fromEnabled && !toEnabled) return;

    var fromRect = fromNode.getBoundingClientRect();
    var toRect = toNode.getBoundingClientRect();

    // Vertical layout: bottom-center of source → top-center of target
    var x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
    var y1 = fromRect.bottom - containerRect.top;
    var x2 = toRect.left + toRect.width / 2 - containerRect.left;
    var y2 = toRect.top - containerRect.top;

    var dy = Math.max((y2 - y1) * 0.4, 15);
    var d = 'M' + x1 + ',' + y1 + ' C' + x1 + ',' + (y1 + dy) + ' ' + x2 + ',' + (y2 - dy) + ' ' + x2 + ',' + y2;

    var path = mkSvg('path', { d: d });
    path.setAttribute('data-from', fromCode);
    path.setAttribute('data-to', toCode);

    var edgeClass = 'dag-edge';
    if (dagMode === 'running' || dagMode === 'completed') {
      var fromStatus = stageStatus[fromCode];
      var fromState = fromStatus ? fromStatus.status : 'pending';

      if (fromState === 'completed') {
        edgeClass += ' dag-edge--completed';
      } else if (fromState === 'running') {
        edgeClass += ' dag-edge--active';
      } else if (fromState === 'failed') {
        edgeClass += ' dag-edge--failed';
      } else {
        edgeClass += ' dag-edge--pending';
      }
    } else {
      if (!fromEnabled || !toEnabled) {
        edgeClass += ' dag-edge--inactive';
      } else {
        edgeClass += ' dag-edge--pending';
      }
    }

    if (type === 'soft' || type === 'soft-active') {
      edgeClass += ' dag-edge--soft';
    }

    path.setAttribute('class', edgeClass);
    svg.appendChild(path);
  }

  // --- Run pipeline ---
  function startDagPipeline() {
    var batch = $('#batch_select').value;
    var owner = $('#owner_select').value;
    var tiers = getTiers();

    var stages = STAGE_ORDER.filter(function(s) {
      return enabledStages[s] && DAG_STAGES[s].available;
    });

    if (stages.length === 0) {
      alert('No stages enabled');
      return;
    }

    var body = {
      batch_name: batch,
      stages: stages,
      soft_deps: softDepsConfig
    };
    if (owner) body.owner = owner;
    if (tiers.length > 0) body.tier_filter = tiers;

    $('#btn_run').disabled = true;
    $('#btn_run').textContent = 'Starting...';

    apiFetch(API_BASE + '/pipeline/dag-run', {
      method: 'POST',
      body: JSON.stringify(body)
    }).then(function(data) {
      currentPipelineRunId = data.pipeline_run_id;
      dagMode = 'running';

      $('#btn_run').classList.add('hidden');
      $('#btn_stop_dag').classList.remove('hidden');

      $$('[data-toggle]').forEach(function(input) { input.disabled = true; });

      STAGE_ORDER.forEach(function(code) {
        var progressEl = document.querySelector('[data-progress="' + code + '"]');
        var statsEl = document.querySelector('[data-stats="' + code + '"]');
        var fieldsEl = document.querySelector('[data-fields="' + code + '"]');
        if (progressEl && enabledStages[code]) progressEl.classList.remove('hidden');
        if (statsEl && enabledStages[code]) statsEl.classList.add('hidden');
        if (fieldsEl && enabledStages[code]) fieldsEl.classList.add('hidden');

        if (!enabledStages[code]) {
          var nodeEl = document.querySelector('[data-stage="' + code + '"]');
          if (nodeEl) nodeEl.setAttribute('data-state', 'disabled');
        }
      });

      startPolling();
    }).catch(function(err) {
      alert('Failed to start pipeline: ' + err.message);
      $('#btn_run').disabled = false;
      $('#btn_run').textContent = 'Run Enabled';
    });
  }

  function stopDagPipeline() {
    if (!currentPipelineRunId) return;

    apiFetch(API_BASE + '/pipeline/dag-stop', {
      method: 'POST',
      body: JSON.stringify({ pipeline_run_id: currentPipelineRunId })
    }).then(function() {
      $('#btn_stop_dag').disabled = true;
      $('#btn_stop_dag').textContent = 'Stopping...';
    }).catch(function(err) {
      alert('Failed to stop: ' + err.message);
    });
  }

  // --- Polling ---
  function startPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(pollDagStatus, POLL_INTERVAL);
    pollDagStatus();
  }

  function pollDagStatus() {
    var batch = $('#batch_select').value;
    if (!batch) return;

    apiFetch(API_BASE + '/pipeline/dag-status?batch_name=' + encodeURIComponent(batch))
      .then(function(data) {
        updateFromPoll(data);
        checkDagCompletion(data);
      }).catch(function() {});
  }

  function updateFromPoll(data) {
    var stages = data.stages || {};
    var pipeline = data.pipeline || {};
    var totalCost = 0;

    stageStatus = stages;

    Object.keys(stages).forEach(function(code) {
      var s = stages[code];
      if (!s) return;

      var nodeEl = document.querySelector('[data-stage="' + code + '"]');
      if (!nodeEl) return;

      var statusIconEl = nodeEl.querySelector('.dag-node__status-icon');
      var barEl = document.querySelector('[data-bar="' + code + '"]');
      var doneEl = document.querySelector('[data-done="' + code + '"]');
      var costEl = document.querySelector('[data-node-cost="' + code + '"]');

      var done = s.done || 0;
      var total = s.total || 0;
      var failed = s.failed || 0;

      var state = s.status || 'pending';
      if (state === 'stopping') state = 'running';
      nodeEl.setAttribute('data-state', state);

      if (state === 'completed') {
        statusIconEl.textContent = '\u2713';
        statusIconEl.classList.remove('hidden');
      } else if (state === 'failed') {
        statusIconEl.textContent = '\u2717';
        statusIconEl.classList.remove('hidden');
      } else if (state === 'running') {
        statusIconEl.textContent = '\u2022';
        statusIconEl.classList.remove('hidden');
      } else {
        statusIconEl.classList.add('hidden');
      }

      if (barEl && total > 0) {
        barEl.style.width = Math.round(done / total * 100) + '%';
      }

      if (doneEl) {
        var countText = done + '/' + total;
        if (failed > 0) countText += ' (' + failed + ' failed)';
        doneEl.textContent = countText;
      }

      if (costEl) costEl.textContent = fmt$(s.cost || 0);

      totalCost += (s.cost || 0);
    });

    $('#dag_total_cost').textContent = fmt$(totalCost);

    // Update pipeline status badge
    var statusEl = $('#dag_pipeline_status');
    clearChildren(statusEl);
    if (pipeline.status) {
      var pill = mkEl('span', { className: 'pill pill-' + pipeline.status }, pipeline.status.toUpperCase());
      statusEl.appendChild(pill);
    }

    drawEdges();
    updateDagSummary(stages);
  }

  function updateDagSummary(stages) {
    var summaryEl = $('#dag_summary');
    clearChildren(summaryEl);

    var completed = 0, running = 0, pending = 0, failed = 0;
    var totalDone = 0, totalItems = 0;

    Object.keys(stages).forEach(function(code) {
      var s = stages[code];
      if (!s) return;
      if (s.status === 'completed') completed++;
      else if (s.status === 'running') running++;
      else if (s.status === 'failed') failed++;
      else pending++;
      totalDone += (s.done || 0);
      totalItems += (s.total || 0);
    });

    var items = [
      { label: completed + ' completed', color: 'var(--success)' },
      { label: running + ' running', color: 'var(--accent-cyan)' },
      { label: pending + ' pending', color: 'var(--text-dim)' }
    ];
    if (failed > 0) items.push({ label: failed + ' failed', color: 'var(--error)' });
    items.push({ label: totalDone + '/' + totalItems + ' entities', color: 'var(--text-muted)' });

    items.forEach(function(item) {
      var el = mkEl('div', { className: 'dag-summary__item' });
      el.appendChild(mkEl('span', { className: 'dag-summary__dot', style: 'background:' + item.color }));
      el.appendChild(mkEl('span', {}, item.label));
      summaryEl.appendChild(el);
    });
  }

  function checkDagCompletion(data) {
    var pipeline = data.pipeline;
    if (!pipeline) return;

    if (pipeline.status === 'completed' || pipeline.status === 'failed' || pipeline.status === 'stopped') {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      dagMode = 'completed';
      showDagCompletion(pipeline, data.stages);
    }
  }

  function showDagCompletion(pipeline, stages) {
    var panel = $('#completion_panel');
    panel.classList.remove('hidden');

    $('#btn_stop_dag').classList.add('hidden');

    var isSuccess = pipeline.status === 'completed';
    var isStopped = pipeline.status === 'stopped';

    $('#completion_icon').textContent = isSuccess ? '\u2713' : (isStopped ? '\u23F8' : '\u2717');
    $('#completion_icon').style.color = isSuccess ? 'var(--success)' : (isStopped ? 'var(--warning)' : 'var(--error)');
    $('#completion_title').textContent = isSuccess ? 'Pipeline Complete' : (isStopped ? 'Pipeline Stopped' : 'Pipeline Failed');

    var totalDone = 0, totalFailed = 0;
    Object.keys(stages).forEach(function(s) {
      if (stages[s].done) totalDone += stages[s].done;
      if (stages[s].failed) totalFailed += stages[s].failed;
    });

    var detail = totalDone + ' items processed';
    if (totalFailed > 0) detail += ', ' + totalFailed + ' failed';
    detail += ' \u00B7 Total cost: ' + fmt$(pipeline.cost || 0);
    $('#completion_detail').textContent = detail;

    var actions = $('#completion_actions');
    clearChildren(actions);

    var rerunBtn = mkEl('button', { className: 'btn btn-success' }, 'Configure New Run');
    rerunBtn.addEventListener('click', function() {
      panel.classList.add('hidden');
      dagMode = 'configure';
      currentPipelineRunId = null;
      stageStatus = {};
      clearChildren($('#dag_summary'));
      clearChildren($('#dag_pipeline_status'));
      fetchEstimate(function(data) {
        buildDAG(data);
        $('#btn_run').classList.remove('hidden');
        $('#btn_run').disabled = false;
        $('#btn_run').textContent = 'Run Enabled';
        $$('[data-toggle]').forEach(function(input) { input.disabled = !DAG_STAGES[input.getAttribute('data-toggle')].available; });
      });
    });
    actions.appendChild(rerunBtn);

    actions.appendChild(mkEl('a', { className: 'btn btn-primary', href: 'companies.html' }, 'View Companies'));
    actions.appendChild(mkEl('a', { className: 'btn btn-ghost', href: 'contacts.html' }, 'View Contacts'));
  }

  // --- Event bindings ---
  function bindEvents() {
    var filterDebounce;
    function onFilterChange() {
      clearTimeout(filterDebounce);
      filterDebounce = setTimeout(function() {
        if (dagMode !== 'configure') return;
        var batch = $('#batch_select').value;
        if (batch) {
          fetchEstimate(null);
        } else {
          estimateData = null;
          buildDAG(null);
        }
        updateBatchInfo();
      }, 200);
    }

    $('#batch_select').addEventListener('change', function() {
      if (dagMode !== 'configure') return;
      var batch = this.value;
      if (batch) {
        fetchEstimate(function(data) { buildDAG(data); });
      } else {
        estimateData = null;
        buildDAG(null);
      }
    });

    $('#owner_select').addEventListener('change', onFilterChange);

    $$('.tier-chip').forEach(function(chip) {
      var cb = chip.querySelector('input');
      chip.addEventListener('click', function(e) {
        if (e.target.tagName === 'INPUT') return;
        cb.checked = !cb.checked;
        chip.classList.toggle('active', cb.checked);
        onFilterChange();
      });
      cb.addEventListener('change', function() {
        chip.classList.toggle('active', cb.checked);
        onFilterChange();
      });
    });

    $('#btn_run').addEventListener('click', startDagPipeline);
    $('#btn_stop_dag').addEventListener('click', stopDagPipeline);

    var resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(drawEdges, 100);
    });
  }

  // --- Init ---
  function onPageReady() {
    loadBatchesAndOwners();
    bindEvents();
  }

  function init() {
    LeadgenAuth.init(onPageReady);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
