<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enrich Contacts — Leadgen</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0D0F14;
  --surface: #14171E;
  --surface-alt: #1A1E28;
  --border: rgba(110,44,139,0.15);
  --border-solid: #231D30;
  --text: #E8EAF0;
  --text-muted: #8B92A0;
  --text-dim: #5A6170;
  --accent: #6E2C8B;
  --accent-hover: #8B47A8;
  --accent-cyan: #00B8CF;
  --success: #34D399;
  --error: #F87171;
  --warning: #FBBF24;
  --radius: 8px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
  --font-title: 'Lexend Deca', -apple-system, sans-serif;
  --font-body: 'Work Sans', -apple-system, sans-serif;
  --l1-color: #00B8CF;
  --l2-color: #8B47A8;
  --person-color: #34D399;
  --generate-color: #FBBF24;
  --ares-color: #3B82F6;
}

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, #4A1D5E, #6E2C8B 40%, #00B8CF);
  z-index: 100;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(110,44,139,.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(110,44,139,.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: -1;
}

/* Nav */
.top-nav {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 24px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}
.top-nav__brand { display: flex; align-items: center; gap: 10px; }
.top-nav__title { font-family: var(--font-title); font-size: 1.05rem; font-weight: 700; letter-spacing: -0.01em; color: var(--text); }
.top-nav__links { display: flex; gap: 2px; margin-left: 24px; }
.top-nav__link {
  color: var(--text-muted);
  text-decoration: none;
  font-family: var(--font-body);
  font-size: 0.82rem;
  font-weight: 500;
  padding: 6px 14px;
  border-radius: 6px;
  transition: var(--transition);
}
.top-nav__link:hover { color: var(--text); background: rgba(110,44,139,0.08); }
.top-nav__link.active { color: var(--accent-cyan); font-weight: 600; background: rgba(0,184,207,0.08); }
.auth-user { margin-left: auto; display: flex; align-items: center; gap: 10px; font-size: 0.82rem; color: var(--text-muted); }
.auth-logout { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
.auth-logout:hover { border-color: var(--error); color: var(--error); }

/* Layout */
.container { max-width: 920px; margin: 0 auto; padding: 32px 16px; }
h1 { font-family: var(--font-title); font-size: 1.3rem; font-weight: 600; margin-bottom: 6px; letter-spacing: -0.01em; }
.subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 24px; }

/* Steps indicator */
.steps {
  display: flex;
  gap: 0;
  margin-bottom: 32px;
}
.step-item {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  padding: 10px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  font-size: 0.82rem;
  color: var(--text-dim);
  cursor: default;
}
.step-item:first-child { border-radius: var(--radius) 0 0 var(--radius); }
.step-item:last-child { border-radius: 0 var(--radius) var(--radius) 0; }
.step-item:not(:last-child) { border-right: none; }
.step-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--surface-alt);
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-dim);
  flex-shrink: 0;
}
.step-item.active { color: var(--text); border-color: var(--accent); }
.step-item.active .step-num { background: var(--accent); color: #fff; }
.step-item.done { color: var(--success); border-color: rgba(52,211,153,0.2); }
.step-item.done .step-num { background: var(--success); color: #0D0F14; }

/* Card */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 16px;
}
.card-title {
  font-family: var(--font-title);
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: var(--text-muted);
  margin-bottom: 12px;
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 20px;
  border-radius: var(--radius);
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: var(--transition);
  text-decoration: none;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-success { background: var(--success); color: #0D0F14; }
.btn-success:hover { filter: brightness(1.1); }
.btn-success:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-ghost { background: transparent; border: 1px solid var(--border-solid); color: var(--text-muted); }
.btn-ghost:hover { border-color: var(--accent); color: var(--text); }
.btn-error { background: var(--error); color: #0D0F14; }
.btn-error:hover { filter: brightness(1.1); }
.btn-error:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-sm { padding: 6px 14px; font-size: 0.78rem; }

/* Form */
.form-row { margin-bottom: 14px; }
.form-row label { display: block; font-size: 0.78rem; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; }
.form-row select, .form-row input[type="text"] {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg);
  border: 1px solid var(--border-solid);
  border-radius: var(--radius);
  color: var(--text);
  font-family: var(--font-body);
  font-size: 0.85rem;
}
.form-row select:focus, .form-row input:focus { outline: none; border-color: var(--accent); }

/* Filter bar */
.filter-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: flex-end;
}
.filter-bar .form-row { margin-bottom: 0; flex: 1; min-width: 140px; }

/* Tier chips */
.tier-chips { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
.tier-chip {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 0.72rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border-solid);
  background: transparent;
  color: var(--text-dim);
  transition: var(--transition);
  user-select: none;
}
.tier-chip input { display: none; }
.tier-chip.active { background: rgba(52,211,153,0.12); color: var(--success); border-color: rgba(52,211,153,0.3); }

/* Status chips (multi-select) */
.status-chips { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
.status-chip {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 0.72rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border-solid);
  background: transparent;
  color: var(--text-dim);
  transition: var(--transition);
  user-select: none;
}
.status-chip input { display: none; }
.status-chip.active { background: rgba(0,184,207,0.12); color: var(--accent-cyan); border-color: rgba(0,184,207,0.3); }

/* Status breakdown grid */
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 8px;
  margin-top: 12px;
}
.status-cell {
  padding: 10px 12px;
  background: var(--surface-alt);
  border-radius: var(--radius);
  text-align: center;
}
.status-cell__value { font-family: var(--font-title); font-weight: 700; font-size: 1.1rem; }
.status-cell__label { font-size: 0.68rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.04em; margin-top: 2px; }
.status-cell--new .status-cell__value { color: var(--text); }
.status-cell--passed .status-cell__value { color: var(--success); }
.status-cell--review .status-cell__value { color: var(--warning); }
.status-cell--failed .status-cell__value { color: var(--error); }
.status-cell--enriched .status-cell__value { color: var(--accent-cyan); }

/* Package cards (Step 2) */
.pkg-cards { display: grid; gap: 14px; }
.pkg-card {
  display: grid;
  grid-template-columns: 44px 1fr auto;
  gap: 14px;
  padding: 16px 18px;
  background: var(--surface-alt);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  transition: var(--transition);
}
.pkg-card.disabled { opacity: 0.35; pointer-events: none; }
.pkg-card__icon {
  width: 44px; height: 44px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  font-weight: 700;
  flex-shrink: 0;
  align-self: start;
  margin-top: 2px;
}
.pkg-card__body { min-width: 0; }
.pkg-card__header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.pkg-card__name { font-family: var(--font-title); font-size: 0.92rem; font-weight: 600; }
.pkg-card__badge {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 4px;
  font-size: 0.62rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.pkg-card__desc { font-size: 0.78rem; color: var(--text-muted); line-height: 1.45; margin-bottom: 8px; }
.pkg-card__fields { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 6px; }
.pkg-field {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 4px;
  font-size: 0.65rem;
  font-weight: 500;
  background: rgba(255,255,255,0.04);
  color: var(--text-dim);
  border: 1px solid rgba(255,255,255,0.06);
}
.pkg-card__usecase { font-size: 0.72rem; color: var(--text-dim); font-style: italic; }
.pkg-card__right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; min-width: 90px; }
.pkg-card__cost { font-family: var(--font-title); font-size: 1rem; font-weight: 700; color: var(--accent-cyan); }
.pkg-card__cost-label { font-size: 0.68rem; color: var(--text-dim); }
.pkg-card__eligible { font-size: 0.78rem; color: var(--text-muted); text-align: right; }

/* Toggle switch */
.toggle {
  position: relative;
  width: 36px;
  height: 20px;
  flex-shrink: 0;
}
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background: var(--surface);
  border: 1px solid var(--border-solid);
  border-radius: 10px;
  transition: var(--transition);
}
.toggle-slider::before {
  content: '';
  position: absolute;
  height: 14px; width: 14px;
  left: 2px; bottom: 2px;
  background: var(--text-dim);
  border-radius: 50%;
  transition: var(--transition);
}
.toggle input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
.toggle input:checked + .toggle-slider::before { background: #fff; transform: translateX(16px); }
.toggle input:disabled + .toggle-slider { opacity: 0.3; cursor: not-allowed; }

/* Cost bar */
.cost-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: var(--surface);
  border: 1px solid var(--accent);
  border-radius: var(--radius);
  margin-top: 20px;
}
.cost-total { font-family: var(--font-title); font-size: 1.15rem; font-weight: 700; color: var(--accent-cyan); }
.cost-label { font-size: 0.82rem; color: var(--text-muted); }

/* Progress bars */
.progress-stage {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.progress-stage:last-child { border-bottom: none; }
.progress-stage__name { width: 80px; font-size: 0.82rem; font-weight: 600; flex-shrink: 0; }
.progress-bar-wrap {
  flex: 1;
  height: 8px;
  background: var(--surface-alt);
  border-radius: 4px;
  overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
  background: var(--accent-cyan);
}
.progress-stage__count { width: 60px; text-align: right; font-size: 0.78rem; color: var(--text-muted); }
.progress-stage__cost { width: 70px; text-align: right; font-size: 0.78rem; color: var(--accent-cyan); }
.progress-stage__status { width: 70px; text-align: right; }

/* Status pills */
.pill {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
.pill-pending { background: rgba(90,97,112,0.2); color: var(--text-dim); }
.pill-running { background: rgba(0,184,207,0.15); color: var(--accent-cyan); }
.pill-completed { background: rgba(52,211,153,0.15); color: var(--success); }
.pill-failed { background: rgba(248,113,113,0.15); color: var(--error); }
.pill-stopped { background: rgba(251,191,36,0.15); color: var(--warning); }
.pill-idle { background: rgba(90,97,112,0.1); color: var(--text-dim); }

/* Callout */
.callout {
  padding: 12px 16px;
  background: rgba(0,184,207,0.06);
  border: 1px solid rgba(0,184,207,0.15);
  border-radius: var(--radius);
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 16px;
}

/* Progress counters */
.progress-counters { display: flex; gap: 10px; width: 130px; flex-shrink: 0; }
.progress-counter { font-size: 0.72rem; font-weight: 600; display: flex; align-items: center; gap: 3px; }
.counter-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
.counter-dot.green { background: var(--success); }
.counter-dot.red { background: var(--error); }
.counter-dot.amber { background: var(--warning); }

.progress-stage__eta { width: 90px; text-align: right; font-size: 0.72rem; color: var(--text-dim); font-style: italic; }

/* Completion badge */
.completion-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 8px; border-radius: 10px; font-size: 0.72rem; font-weight: 600; cursor: pointer;
}
.completion-badge--ok { background: rgba(52,211,153,0.15); color: var(--success); cursor: default; }
.completion-badge--review { background: rgba(251,191,36,0.15); color: var(--warning); }
.completion-badge--review:hover { background: rgba(251,191,36,0.25); }

/* Review list */
.review-list { margin-top: 12px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.review-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-bottom: 1px solid var(--border); font-size: 0.82rem; }
.review-item:last-child { border-bottom: none; }
.review-item__name { font-weight: 600; min-width: 140px; }
.review-item__domain { color: var(--text-dim); min-width: 120px; }
.review-item__flags { flex: 1; display: flex; gap: 4px; flex-wrap: wrap; }
.review-flag { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; background: rgba(251,191,36,0.1); color: var(--warning); }
.review-flag--error { background: rgba(248,113,113,0.1); color: var(--error); }
.review-item__actions { display: flex; gap: 4px; flex-shrink: 0; }
.review-item__actions .btn { padding: 3px 10px; font-size: 0.72rem; }

/* Hidden */
.hidden { display: none !important; }

/* Spinner */
.loading-sm {
  width: 20px; height: 20px;
  border: 2px solid var(--border-solid);
  border-top-color: var(--accent-cyan);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive */
@media (max-width: 640px) {
  .steps { flex-direction: column; }
  .filter-bar { flex-direction: column; }
  .pkg-card { grid-template-columns: 1fr; }
  .cost-bar { flex-direction: column; gap: 8px; text-align: center; }
}
</style>
</head>
<body>

<nav class="top-nav">
  <div class="top-nav__brand">
    <img src="visionvolve-icon-color.svg" alt="VisionVolve" class="top-nav__logo" style="height:26px;width:auto;">
    <span class="top-nav__title">Leadgen</span>
  </div>
  <div class="top-nav__links">
    <a href="index.html" class="top-nav__link">Pipeline</a>
    <a href="companies.html" class="top-nav__link">Companies</a>
    <a href="contacts.html" class="top-nav__link">Contacts</a>
    <a href="messages.html" class="top-nav__link">Messages</a>
    <a href="import.html" class="top-nav__link" data-min-role="editor">Import</a>
    <a href="enrich.html" class="top-nav__link active" data-min-role="editor">Enrich</a>
    <a href="llm-costs.html" class="top-nav__link" data-min-role="admin">LLM Costs</a>
    <a href="admin.html" class="top-nav__link" data-min-role="admin">Admin</a>
  </div>
  <span class="auth-user">
    <span id="auth_user_name"></span>
    <button class="auth-logout" onclick="LeadgenAuth.logout()">Logout</button>
  </span>
</nav>

<div class="container">
  <h1>Enrich Contacts</h1>
  <div class="subtitle" id="page_subtitle">Select contacts to enrich, choose enrichment packages, and run.</div>

  <!-- Steps indicator -->
  <div class="steps">
    <div class="step-item active" id="step_ind_1"><span class="step-num">1</span> Select &amp; Filter</div>
    <div class="step-item" id="step_ind_2"><span class="step-num">2</span> Choose Packages</div>
    <div class="step-item" id="step_ind_3"><span class="step-num">3</span> Processing</div>
  </div>

  <!-- STEP 1: Select & Filter -->
  <div id="step_1">
    <div class="card">
      <div class="card-title">Filters</div>

      <div id="import_callout" class="callout hidden"></div>

      <div class="filter-bar">
        <div class="form-row" style="min-width:160px;">
          <label for="batch_select">Batch</label>
          <select id="batch_select"><option value="">Loading...</option></select>
        </div>
        <div class="form-row" style="min-width:130px;">
          <label for="owner_select">Owner</label>
          <select id="owner_select"><option value="">All owners</option></select>
        </div>
        <div class="form-row" style="min-width:100px;">
          <label for="status_select">Company Status</label>
          <select id="status_select">
            <option value="">All statuses</option>
            <option value="new" selected>New</option>
            <option value="triage_passed">Triage Passed</option>
            <option value="needs_review">Needs Review</option>
            <option value="enriched_l2">Enriched L2</option>
            <option value="enrichment_failed">Failed</option>
          </select>
        </div>
        <div class="form-row" style="min-width:180px;">
          <label>Tier Filter</label>
          <div class="tier-chips" id="tier_chips">
            <label class="tier-chip active"><input type="checkbox" name="tier" value="Tier 1" checked> T1</label>
            <label class="tier-chip active"><input type="checkbox" name="tier" value="Tier 2" checked> T2</label>
            <label class="tier-chip active"><input type="checkbox" name="tier" value="Tier 3" checked> T3</label>
            <label class="tier-chip"><input type="checkbox" name="tier" value="Tier 4"> T4</label>
            <label class="tier-chip"><input type="checkbox" name="tier" value="Tier 5"> T5</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Status breakdown -->
    <div id="status_breakdown" class="card hidden">
      <div class="card-title">Company Status Breakdown</div>
      <div class="status-grid" id="status_grid"></div>
      <div id="selection_summary" style="margin-top:12px;font-size:0.82rem;color:var(--text-muted);"></div>
    </div>

    <div style="margin-top:16px;display:flex;gap:10px;">
      <button class="btn btn-primary" id="btn_configure" disabled>Choose Enrichment Packages</button>
    </div>
  </div>

  <!-- STEP 2: Choose Packages -->
  <div id="step_2" class="hidden">
    <div class="card">
      <div class="card-title">Enrichment Packages</div>
      <div style="font-size:0.78rem;color:var(--text-dim);margin-bottom:16px;">Toggle packages on/off. Each package enriches different data fields. Costs shown are estimates based on eligible count.</div>
      <div class="pkg-cards" id="pkg_cards"></div>
    </div>

    <div class="cost-bar" id="cost_bar">
      <div>
        <div class="cost-label">Total estimated cost</div>
        <div class="cost-total" id="total_cost">$0.00</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn btn-ghost btn-sm" id="btn_sample">Run Sample (10)</button>
        <button class="btn btn-success" id="btn_start">Start Enrichment</button>
        <button class="btn btn-ghost btn-sm" id="btn_back_1">Back</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Processing -->
  <div id="step_3" class="hidden">
    <div class="card">
      <div class="card-title">Progress</div>
      <div id="progress_stages"></div>
    </div>

    <div class="cost-bar">
      <div>
        <div class="cost-label">Total cost so far</div>
        <div class="cost-total" id="running_cost">$0.00</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="btn btn-error btn-sm" id="btn_stop">Stop</button>
      </div>
    </div>

    <!-- Completion panel (hidden until done) -->
    <div id="completion_panel" class="card hidden" style="margin-top:16px;text-align:center;">
      <div id="completion_icon" style="font-size:2rem;margin-bottom:8px;"></div>
      <div id="completion_title" style="font-family:var(--font-title);font-size:1.1rem;font-weight:600;margin-bottom:6px;"></div>
      <div id="completion_detail" style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px;"></div>
      <div id="completion_actions" style="display:flex;gap:10px;justify-content:center;"></div>
    </div>
  </div>
</div>

<script src="auth.js"></script>
<script>
(function() {
  'use strict';

  var API_BASE = 'https://leadgen.visionvolve.com/api';
  var POLL_INTERVAL = 5000;
  var pollTimer = null;
  var currentPipelineRunId = null;
  var isSampleRun = false;

  // --- Package definitions ---
  // Progressive value chain: each layer answers a deeper question.
  //   1. WHO are they? (Profile)
  //   2. Are they LEGIT? (Legal)
  //   3. WHAT do they build? (Tech & Product)
  //   4. Is the TIMING right? (Financial & Growth)
  //   5. HOW to position? (Competitive)
  //   6. WHAT to say? (News & Media)
  // Contact packages: WHO to reach, HOW to personalize, WHERE to find them.
  var PACKAGES = {
    // --- Company enrichment (progressive depth) ---
    l1: {
      name: 'Company Profile',
      icon: 'CP',
      color: 'var(--l1-color)',
      bgColor: 'rgba(0,184,207,0.12)',
      desc: 'AI-powered company research via Perplexity. Identifies industry, headcount, what the company does, founding year, HQ location, and website analysis. QC validation flags dubious results for human review. The foundation for all subsequent enrichment.',
      fields: ['Industry', 'Employees', 'Revenue Range', 'B2B Focus', 'HQ Location', 'Founded', 'Summary', 'Tier'],
      usecase: 'Run first on every new batch. Answers: who are they and should we pursue them?',
      comingSoon: false,
      badge: null,
      category: 'company'
    },
    ares: {
      name: 'Czech Registry (ARES)',
      icon: 'CZ',
      color: 'var(--ares-color)',
      bgColor: 'rgba(59,130,246,0.12)',
      desc: 'Czech public business register (ares.gov.cz). Retrieves ICO, DIC, legal form, directors, registered capital, NACE activity codes, and insolvency status. Validates the company is real and solvent.',
      fields: ['ICO', 'DIC', 'Legal Form', 'Directors', 'Capital', 'NACE Codes', 'Insolvency', 'Registered Address'],
      usecase: 'Run on Czech companies after Profile. Answers: are they legitimate and solvent? Zero cost.',
      comingSoon: false,
      badge: 'Free',
      category: 'company'
    },
    brreg: {
      name: 'Norway Registry (BRREG)',
      icon: 'NO',
      color: 'var(--ares-color)',
      bgColor: 'rgba(59,130,246,0.12)',
      desc: 'Norwegian business register (data.brreg.no). Retrieves organisasjonsnummer, legal form, NACE codes, registered capital, bankruptcy and winding-up status.',
      fields: ['Org Nr', 'Legal Form', 'NACE Codes', 'Capital', 'Bankruptcy', 'Address'],
      usecase: 'Run on Norwegian companies. Free government data.',
      comingSoon: false,
      badge: 'Free',
      category: 'company'
    },
    prh: {
      name: 'Finland Registry (PRH)',
      icon: 'FI',
      color: 'var(--ares-color)',
      bgColor: 'rgba(59,130,246,0.12)',
      desc: 'Finnish Patent and Registration Office (avoindata.prh.fi). Retrieves Y-tunnus, company form, TOL/NACE codes, and trade register status.',
      fields: ['Y-tunnus', 'Company Form', 'TOL Codes', 'Trade Register Status', 'Address'],
      usecase: 'Run on Finnish companies. Free government data.',
      comingSoon: false,
      badge: 'Free',
      category: 'company'
    },
    recherche: {
      name: 'France Registry (INSEE)',
      icon: 'FR',
      color: 'var(--ares-color)',
      bgColor: 'rgba(59,130,246,0.12)',
      desc: 'French company register (recherche-entreprises.api.gouv.fr). Retrieves SIREN, nature juridique, NAF codes, directors, and administrative status.',
      fields: ['SIREN', 'Legal Form', 'NAF Codes', 'Directors', 'Status', 'Address'],
      usecase: 'Run on French companies. Free government data.',
      comingSoon: false,
      badge: 'Free',
      category: 'company'
    },
    tech_product: {
      name: 'Tech & Product Intelligence',
      icon: 'TP',
      color: 'var(--l2-color)',
      bgColor: 'rgba(139,71,168,0.12)',
      desc: 'Deep-dive into the company\'s technology stack, product lines, integrations, and pricing model. Analyzes their website, job postings, and public repos to map their technical landscape. Determines ICP fit based on tech overlap.',
      fields: ['Tech Stack', 'Product Lines', 'Integrations', 'Pricing Model', 'Engineering Size', 'Tech Maturity'],
      usecase: 'Run on Tier 1-2 after Profile. Answers: do they use technology we can sell into?',
      comingSoon: true,
      badge: null,
      category: 'company'
    },
    financial_growth: {
      name: 'Financial & Growth Signals',
      icon: 'FG',
      color: '#f59e0b',
      bgColor: 'rgba(245,158,11,0.12)',
      desc: 'Tracks funding rounds, revenue indicators, hiring velocity, office expansion, and M&A activity. Identifies companies actively investing and growing — the ones most likely to buy. Cross-references multiple signal sources for confidence scoring.',
      fields: ['Funding History', 'Revenue Signals', 'Hiring Velocity', 'Office Expansion', 'M&A Activity', 'Growth Score'],
      usecase: 'Run on qualified companies. Answers: is the timing right — are they growing and spending?',
      comingSoon: true,
      badge: null,
      category: 'company'
    },
    competitive: {
      name: 'Competitive Landscape',
      icon: 'CL',
      color: '#ec4899',
      bgColor: 'rgba(236,72,153,0.12)',
      desc: 'Maps direct competitors, market position, key differentiators, and win/loss patterns. Identifies what solutions they already use and where gaps exist. Gives you the ammunition to position against incumbents.',
      fields: ['Competitors', 'Market Position', 'Current Solutions', 'Differentiators', 'Vendor Stack', 'Switch Signals'],
      usecase: 'Run before outreach. Answers: who else are they talking to and how do we position?',
      comingSoon: true,
      badge: null,
      category: 'company'
    },
    news_media: {
      name: 'News & Media',
      icon: 'NM',
      color: '#ef4444',
      bgColor: 'rgba(239,68,68,0.12)',
      desc: 'Scans recent media mentions, press releases, conference appearances, social media presence, and thought leadership. Surfaces timely conversation hooks and sentiment. The freshest layer — run closest to outreach.',
      fields: ['Recent News', 'Press Releases', 'Events & Conferences', 'Social Presence', 'Thought Leadership', 'Sentiment'],
      usecase: 'Run right before outreach. Answers: what can we talk about that feels timely and relevant?',
      comingSoon: true,
      badge: null,
      category: 'company'
    },
    // --- Contact enrichment (who, how, where) ---
    role_employment: {
      name: 'Role & Employment',
      icon: 'RE',
      color: 'var(--person-color)',
      bgColor: 'rgba(52,211,153,0.12)',
      desc: 'Verifies current job title, identifies reporting structure, calculates tenure, and confirms the contact still works at the listed company. The essential check before any outreach — nothing wastes credibility like messaging someone who left 6 months ago.',
      fields: ['Title Verified', 'Department', 'Seniority Level', 'Reporting To', 'Tenure', 'Still Employed'],
      usecase: 'Run first on contacts. Answers: is this the right person, and are they still there?',
      comingSoon: true,
      badge: null,
      category: 'contact'
    },
    social_online: {
      name: 'Social & Online Presence',
      icon: 'SO',
      color: '#8b5cf6',
      bgColor: 'rgba(139,92,246,0.12)',
      desc: 'Analyzes LinkedIn profile, Twitter/X presence, speaking engagements, blog posts, and publications. Identifies topics of interest, professional communities, and engagement patterns. Gives you personalization hooks that go beyond "I saw your company does X."',
      fields: ['LinkedIn Activity', 'Twitter/X', 'Speaking Events', 'Publications', 'Communities', 'Topics of Interest'],
      usecase: 'Run on high-priority contacts. Answers: what do they care about and where are they active?',
      comingSoon: true,
      badge: null,
      category: 'contact'
    },
    career_history: {
      name: 'Career History',
      icon: 'CH',
      color: '#06b6d4',
      bgColor: 'rgba(6,182,212,0.12)',
      desc: 'Maps previous roles, companies, career trajectory, and industry experience. Identifies career patterns — someone who moved from competitor X to target Y likely brought a specific problem with them. Finds shared connections and common ground.',
      fields: ['Previous Roles', 'Past Companies', 'Career Trajectory', 'Industry Experience', 'Shared Connections'],
      usecase: 'Run on decision-makers. Answers: what\'s their background and what pain did they bring?',
      comingSoon: true,
      badge: null,
      category: 'contact'
    },
    contact_details: {
      name: 'Contact Details & Deliverability',
      icon: 'CD',
      color: '#10b981',
      bgColor: 'rgba(16,185,129,0.12)',
      desc: 'Verifies email deliverability (MX + SMTP probe), finds direct phone numbers, validates LinkedIn DM availability, and checks alternative contact methods. Scores overall reachability. The last step before campaign launch — ensures your message actually arrives.',
      fields: ['Email Verified', 'Deliverability Score', 'Direct Phone', 'LinkedIn DM', 'Alternative Email', 'Reachability Score'],
      usecase: 'Run last, before campaign. Answers: can we actually reach them, and through which channel?',
      comingSoon: true,
      badge: null,
      category: 'contact'
    }
  };

  var STAGE_ORDER = ['l1', 'ares', 'brreg', 'prh', 'recherche', 'tech_product', 'financial_growth', 'competitive', 'news_media', 'role_employment', 'social_online', 'career_history', 'contact_details'];

  var estimateData = null;
  var enabledStages = {};
  var batchList = [];
  var ownerList = [];
  var stageStartTimes = {};
  var reviewItems = [];
  var batchStats = null;

  // --- Utilities ---
  function $(sel) { return document.querySelector(sel); }
  function $$(sel) { return Array.prototype.slice.call(document.querySelectorAll(sel)); }

  function mkEl(tag, attrs, text) {
    var el = document.createElement(tag);
    if (attrs) Object.keys(attrs).forEach(function(k) {
      if (k === 'className') el.className = attrs[k];
      else if (k === 'style' && typeof attrs[k] === 'string') el.setAttribute('style', attrs[k]);
      else el.setAttribute(k, attrs[k]);
    });
    if (text !== undefined) el.textContent = text;
    return el;
  }

  function clearChildren(el) { while (el.firstChild) el.removeChild(el.firstChild); }

  function apiHeaders() {
    return {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + (LeadgenAuth.getToken ? LeadgenAuth.getToken() : ''),
      'X-Namespace': (LeadgenAuth.getNamespace ? LeadgenAuth.getNamespace() : '') || 'visionvolve'
    };
  }

  function apiFetch(url, opts) {
    var options = Object.assign({}, opts || {});
    options.headers = Object.assign({}, apiHeaders(), options.headers || {});
    return fetch(url, options).then(function(resp) {
      if (resp.status === 401) { LeadgenAuth.logout(); throw new Error('Auth expired'); }
      if (!resp.ok) return resp.json().then(function(d) { throw new Error(d.error || 'HTTP ' + resp.status); });
      return resp.json();
    });
  }

  function fmt$(val) { return '$' + (val || 0).toFixed(2); }

  function formatDuration(ms) {
    var s = Math.round(ms / 1000);
    if (s < 60) return '~' + s + 's remaining';
    var m = Math.round(s / 60);
    return '~' + m + 'm remaining';
  }

  function getParam(name) {
    var params = new URLSearchParams(window.location.search);
    return params.get(name) || '';
  }

  function getTiers() {
    return $$('input[name="tier"]:checked').map(function(cb) { return cb.value; });
  }

  // --- Step navigation ---
  function goStep(n) {
    [1, 2, 3].forEach(function(i) {
      var el = $('#step_' + i);
      var ind = $('#step_ind_' + i);
      if (i === n) {
        el.classList.remove('hidden');
        ind.classList.add('active');
        ind.classList.remove('done');
      } else if (i < n) {
        el.classList.add('hidden');
        ind.classList.remove('active');
        ind.classList.add('done');
      } else {
        el.classList.add('hidden');
        ind.classList.remove('active', 'done');
      }
    });
  }

  // --- Step 1: Load batches, owners, stats ---
  function loadBatchesAndOwners() {
    apiFetch(API_BASE + '/batches').then(function(data) {
      batchList = data.batches || data || [];
      var sel = $('#batch_select');
      clearChildren(sel);
      sel.appendChild(mkEl('option', { value: '' }, 'Select batch...'));
      batchList.forEach(function(b) {
        sel.appendChild(mkEl('option', { value: b.name }, b.name));
      });

      // Pre-select from URL param
      var urlBatch = getParam('batch_name');
      if (urlBatch) {
        sel.value = urlBatch;
        loadBatchStats();
      }

      // Load owners
      var ownerSel = $('#owner_select');
      var uniqueOwners = {};
      batchList.forEach(function(b) {
        if (b.owners) {
          b.owners.forEach(function(o) { uniqueOwners[o.name] = o; });
        }
      });
      ownerList = Object.values(uniqueOwners);
      ownerList.forEach(function(o) {
        ownerSel.appendChild(mkEl('option', { value: o.name }, o.name));
      });

      var urlOwner = getParam('owner_name');
      if (urlOwner) ownerSel.value = urlOwner;

      checkConfigureEnabled();

      // Show import callout if coming from import
      var importJobId = getParam('import_job_id');
      if (importJobId && urlBatch) {
        var callout = $('#import_callout');
        callout.textContent = 'Enriching contacts imported into batch "' + urlBatch + '"';
        callout.classList.remove('hidden');
      }
    }).catch(function(err) {
      $('#selection_summary').textContent = 'Failed to load batches: ' + err.message;
    });
  }

  function loadBatchStats() {
    var batch = $('#batch_select').value;
    if (!batch) {
      $('#status_breakdown').classList.add('hidden');
      return;
    }

    var tiers = getTiers();
    apiFetch(API_BASE + '/batch-stats', {
      method: 'POST',
      body: JSON.stringify({ batch_name: batch, tier_filter: tiers })
    }).then(function(data) {
      batchStats = data;
      renderStatusBreakdown(data);
      checkConfigureEnabled();
    }).catch(function(err) {
      $('#selection_summary').textContent = 'Failed to load stats: ' + err.message;
    });
  }

  function renderStatusBreakdown(data) {
    var grid = $('#status_grid');
    clearChildren(grid);

    var sc = data.status_counts || {};
    var items = [
      { label: 'New', value: sc['New'] || 0, cls: 'new' },
      { label: 'Triage Passed', value: sc['Triage: Passed'] || 0, cls: 'passed' },
      { label: 'Needs Review', value: sc['Triage: Review'] || 0, cls: 'review' },
      { label: 'Enriched L2', value: sc['Enriched L2'] || 0, cls: 'enriched' },
      { label: 'Failed', value: (sc['Enrichment Failed'] || 0) + (sc['Enrichment L2 Failed'] || 0), cls: 'failed' }
    ];

    items.forEach(function(item) {
      var cell = mkEl('div', { className: 'status-cell status-cell--' + item.cls });
      cell.appendChild(mkEl('div', { className: 'status-cell__value' }, String(item.value)));
      cell.appendChild(mkEl('div', { className: 'status-cell__label' }, item.label));
      grid.appendChild(cell);
    });

    // Summary
    var summary = $('#selection_summary');
    var total = data.companies_total || 0;
    var contacts = data.contacts_total || 0;
    summary.textContent = total + ' companies, ' + contacts + ' contacts in this batch';

    // Tier breakdown if available
    var tierData = data.l2_eligible_by_tier || {};
    var tierKeys = Object.keys(tierData);
    if (tierKeys.length > 0) {
      var tierLine = mkEl('div', { style: 'margin-top:6px;font-size:0.78rem;color:var(--text-dim);' });
      tierLine.textContent = 'Tier breakdown: ' + tierKeys.map(function(t) {
        return t.replace(/ - .*/, '') + ': ' + tierData[t];
      }).join(', ');
      summary.parentNode.appendChild(tierLine);
    }

    $('#status_breakdown').classList.remove('hidden');
  }

  function checkConfigureEnabled() {
    $('#btn_configure').disabled = !$('#batch_select').value;
  }

  // --- Step 2: Fetch estimate and build package cards ---
  function fetchEstimate(callback) {
    var batch = $('#batch_select').value;
    var owner = $('#owner_select').value;
    var tiers = getTiers();

    apiFetch(API_BASE + '/enrich/estimate', {
      method: 'POST',
      body: JSON.stringify({
        batch_name: batch,
        owner_name: owner || undefined,
        tier_filter: tiers,
        stages: STAGE_ORDER.filter(function(s) { return !PACKAGES[s].comingSoon; })
      })
    }).then(function(data) {
      estimateData = data;
      if (callback) callback(data);
    }).catch(function(err) {
      alert('Failed to get estimate: ' + err.message);
    });
  }

  function buildPackageCards(data) {
    var container = $('#pkg_cards');
    clearChildren(container);

    // Reset enabled stages
    enabledStages = {};

    var lastCategory = '';

    STAGE_ORDER.forEach(function(stage) {
      var pkg = PACKAGES[stage];

      // Category header
      if (pkg.category !== lastCategory) {
        lastCategory = pkg.category;
        var catLabel = pkg.category === 'company' ? 'Company Enrichment' : 'Contact Enrichment';
        var catEl = mkEl('div', {
          style: 'font-family:var(--font-title);font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-dim);padding:8px 0 2px;' + (pkg.category === 'contact' ? 'margin-top:8px;border-top:1px solid var(--border);padding-top:16px;' : '')
        }, catLabel);
        container.appendChild(catEl);
      }
      var pkg = PACKAGES[stage];
      var info = data.stages[stage] || {};
      var eligible = info.eligible_count || 0;
      var costPer = info.cost_per_item || 0;
      var isComingSoon = pkg.comingSoon;
      var hasItems = eligible > 0 && !isComingSoon;

      enabledStages[stage] = hasItems;

      var card = mkEl('div', { className: 'pkg-card' + (isComingSoon ? ' disabled' : '') });
      card.setAttribute('data-stage', stage);

      // Icon
      var iconEl = mkEl('div', { className: 'pkg-card__icon' });
      iconEl.style.background = pkg.bgColor;
      iconEl.style.color = pkg.color;
      iconEl.textContent = pkg.icon;

      // Body
      var body = mkEl('div', { className: 'pkg-card__body' });

      // Header: name + badge + toggle
      var header = mkEl('div', { className: 'pkg-card__header' });
      header.appendChild(mkEl('div', { className: 'pkg-card__name' }, pkg.name));
      if (isComingSoon) {
        var badge = mkEl('span', { className: 'pkg-card__badge', style: 'background:rgba(90,97,112,0.2);color:var(--text-dim);' }, 'Coming Soon');
        header.appendChild(badge);
      } else if (pkg.badge) {
        var freeBadge = mkEl('span', { className: 'pkg-card__badge', style: 'background:rgba(52,211,153,0.15);color:var(--success);' }, pkg.badge);
        header.appendChild(freeBadge);
      }
      body.appendChild(header);

      // Description
      body.appendChild(mkEl('div', { className: 'pkg-card__desc' }, pkg.desc));

      // Fields
      var fieldsEl = mkEl('div', { className: 'pkg-card__fields' });
      pkg.fields.forEach(function(f) {
        fieldsEl.appendChild(mkEl('span', { className: 'pkg-field' }, f));
      });
      body.appendChild(fieldsEl);

      // Use case
      body.appendChild(mkEl('div', { className: 'pkg-card__usecase' }, pkg.usecase));

      // Right side: toggle + cost + eligible
      var right = mkEl('div', { className: 'pkg-card__right' });

      var toggle = mkEl('label', { className: 'toggle' });
      var input = mkEl('input', { type: 'checkbox' });
      input.checked = hasItems;
      input.disabled = !hasItems || isComingSoon;
      input.setAttribute('data-stage', stage);
      input.addEventListener('change', function() {
        enabledStages[stage] = this.checked;
        updateTotalCost();
      });
      var slider = mkEl('span', { className: 'toggle-slider' });
      toggle.appendChild(input);
      toggle.appendChild(slider);
      right.appendChild(toggle);

      if (!isComingSoon) {
        var costWrap = mkEl('div', { style: 'text-align:right;' });
        var costVal = mkEl('div', { className: 'pkg-card__cost' }, fmt$(info.estimated_cost || 0));
        costVal.setAttribute('data-stage-cost', stage);
        costWrap.appendChild(costVal);
        if (costPer > 0) {
          costWrap.appendChild(mkEl('div', { className: 'pkg-card__cost-label' }, fmt$(costPer) + '/item'));
        } else {
          costWrap.appendChild(mkEl('div', { className: 'pkg-card__cost-label' }, 'free'));
        }
        right.appendChild(costWrap);

        right.appendChild(mkEl('div', { className: 'pkg-card__eligible' }, eligible + ' eligible'));
      }

      card.appendChild(iconEl);
      card.appendChild(body);
      card.appendChild(right);
      container.appendChild(card);
    });

    updateTotalCost();
  }

  function updateTotalCost() {
    if (!estimateData) return;
    var total = 0;
    STAGE_ORDER.forEach(function(stage) {
      var info = estimateData.stages[stage] || {};
      var stageCost = enabledStages[stage] ? (info.estimated_cost || 0) : 0;
      total += stageCost;
      var el = document.querySelector('[data-stage-cost="' + stage + '"]');
      if (el) el.textContent = enabledStages[stage] ? fmt$(info.estimated_cost || 0) : '$0.00';
    });
    $('#total_cost').textContent = fmt$(total);

    var anyEnabled = Object.keys(enabledStages).some(function(s) { return enabledStages[s]; });
    $('#btn_start').disabled = !anyEnabled;
    $('#btn_sample').disabled = !anyEnabled;
  }

  function getEnabledStages() {
    return STAGE_ORDER.filter(function(s) { return enabledStages[s] && !PACKAGES[s].comingSoon; });
  }

  // --- Step 3: Start pipeline and poll ---
  function startEnrichment(sampleSize) {
    var batch = $('#batch_select').value;
    var owner = $('#owner_select').value;
    var stages = getEnabledStages();
    var tiers = getTiers();
    isSampleRun = !!sampleSize;

    var body = { batch_name: batch, stages: stages };
    if (owner) body.owner_name = owner;
    if (sampleSize) body.sample_size = sampleSize;
    if (tiers.length > 0) body.tier_filter = tiers;

    apiFetch(API_BASE + '/enrich/start', {
      method: 'POST',
      body: JSON.stringify(body)
    }).then(function(data) {
      currentPipelineRunId = data.pipeline_run_id;
      goStep(3);
      buildProgressUI(stages);
      startPolling(batch);
    }).catch(function(err) {
      alert('Failed to start enrichment: ' + err.message);
    });
  }

  function buildProgressUI(stages) {
    var container = $('#progress_stages');
    clearChildren(container);
    stageStartTimes = {};

    stages.forEach(function(stage) {
      var pkg = PACKAGES[stage];
      var row = mkEl('div', { className: 'progress-stage' });
      row.setAttribute('data-progress-stage', stage);

      var nameEl = mkEl('div', { className: 'progress-stage__name' }, pkg.name);
      nameEl.style.color = pkg.color;

      var barWrap = mkEl('div', { className: 'progress-bar-wrap' });
      var barFill = mkEl('div', { className: 'progress-bar-fill' });
      barFill.style.width = '0%';
      barFill.style.background = pkg.color;
      barWrap.appendChild(barFill);

      var countEl = mkEl('div', { className: 'progress-stage__count' }, '0/0');
      countEl.setAttribute('data-count', stage);

      var countersEl = mkEl('div', { className: 'progress-counters' });
      countersEl.setAttribute('data-counters', stage);

      var costEl = mkEl('div', { className: 'progress-stage__cost' }, '$0.00');
      costEl.setAttribute('data-cost', stage);

      var etaEl = mkEl('div', { className: 'progress-stage__eta' }, '');
      etaEl.setAttribute('data-eta', stage);

      var statusEl = mkEl('div', { className: 'progress-stage__status' });
      var pill = mkEl('span', { className: 'pill pill-pending' }, 'PENDING');
      pill.setAttribute('data-pill', stage);
      statusEl.appendChild(pill);

      row.appendChild(nameEl);
      row.appendChild(barWrap);
      row.appendChild(countEl);
      row.appendChild(countersEl);
      row.appendChild(costEl);
      row.appendChild(etaEl);
      row.appendChild(statusEl);
      container.appendChild(row);
    });

    var reviewContainer = mkEl('div', { className: 'hidden', id: 'review_list_container' });
    reviewContainer.setAttribute('style', 'margin-top:12px;');
    container.parentNode.appendChild(reviewContainer);
  }

  function startPolling(batchName) {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(function() { pollStatus(batchName); }, POLL_INTERVAL);
    pollStatus(batchName);
  }

  function pollStatus(batchName) {
    apiFetch(API_BASE + '/pipeline/status?batch_name=' + encodeURIComponent(batchName))
      .then(function(data) {
        updateProgressUI(data);
        checkCompletion(data);
      }).catch(function() {});
  }

  function updateProgressUI(data) {
    var totalCost = 0;
    var stages = data.stages || {};

    Object.keys(stages).forEach(function(stage) {
      var s = stages[stage];
      if (!s || s.status === 'idle' || s.status === 'unavailable') return;

      var countEl = document.querySelector('[data-count="' + stage + '"]');
      var costEl = document.querySelector('[data-cost="' + stage + '"]');
      var pillEl = document.querySelector('[data-pill="' + stage + '"]');
      var rowEl = document.querySelector('[data-progress-stage="' + stage + '"]');
      var barEl = rowEl ? rowEl.querySelector('.progress-bar-fill') : null;
      var countersEl = document.querySelector('[data-counters="' + stage + '"]');
      var etaEl = document.querySelector('[data-eta="' + stage + '"]');

      var done = s.done || 0;
      var total = s.total || 0;
      var failed = s.failed || 0;
      var success = done - failed;

      if (countEl) countEl.textContent = done + '/' + total;
      if (costEl) costEl.textContent = fmt$(s.cost || 0);
      if (barEl && total > 0) barEl.style.width = Math.round(done / total * 100) + '%';

      if (countersEl && done > 0) {
        clearChildren(countersEl);
        if (success > 0) {
          var sc = mkEl('span', { className: 'progress-counter' });
          sc.appendChild(mkEl('span', { className: 'counter-dot green' }));
          sc.appendChild(mkEl('span', {}, String(success)));
          countersEl.appendChild(sc);
        }
        if (failed > 0) {
          var fc = mkEl('span', { className: 'progress-counter' });
          fc.appendChild(mkEl('span', { className: 'counter-dot red' }));
          fc.appendChild(mkEl('span', {}, String(failed)));
          countersEl.appendChild(fc);
        }
      }

      if (etaEl && s.status === 'running' && done > 0 && done < total) {
        if (!stageStartTimes[stage]) stageStartTimes[stage] = Date.now();
        var elapsed = Date.now() - stageStartTimes[stage];
        var avgPerItem = elapsed / done;
        var remaining = (total - done) * avgPerItem;
        etaEl.textContent = formatDuration(remaining);
      } else if (etaEl) {
        etaEl.textContent = (s.status === 'running' && done === 0) ? 'Starting...' : '';
      }

      if (pillEl) {
        var st = s.status || 'pending';
        pillEl.className = 'pill pill-' + st;
        pillEl.textContent = st.toUpperCase();
      }

      totalCost += (s.cost || 0);
    });

    $('#running_cost').textContent = fmt$(totalCost);
  }

  function checkCompletion(data) {
    var pipeline = data.pipeline;
    if (!pipeline) return;

    if (pipeline.status === 'completed' || pipeline.status === 'failed' || pipeline.status === 'stopped') {
      if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      showCompletion(pipeline, data.stages);
    }
  }

  function showCompletion(pipeline, stages) {
    var panel = $('#completion_panel');
    panel.classList.remove('hidden');
    $('#btn_stop').disabled = true;

    var isSuccess = pipeline.status === 'completed';
    var isStopped = pipeline.status === 'stopped';

    $('#completion_icon').textContent = isSuccess ? '\u2713' : (isStopped ? '\u23F8' : '\u2717');
    $('#completion_icon').style.color = isSuccess ? 'var(--success)' : (isStopped ? 'var(--warning)' : 'var(--error)');
    $('#completion_title').textContent = isSuccess ? 'Enrichment Complete' : (isStopped ? 'Enrichment Stopped' : 'Enrichment Failed');

    var totalDone = 0, totalFailed = 0;
    Object.keys(stages).forEach(function(s) {
      if (stages[s].done) totalDone += stages[s].done;
      if (stages[s].failed) totalFailed += stages[s].failed;
    });

    var detail = totalDone + ' items processed';
    if (totalFailed > 0) detail += ', ' + totalFailed + ' failed';
    detail += ' \u00B7 Total cost: ' + fmt$(pipeline.cost || 0);
    $('#completion_detail').textContent = detail;

    var actions = $('#completion_actions');
    clearChildren(actions);

    if (isSampleRun || isStopped) {
      var contBtn = mkEl('button', { className: 'btn btn-success' }, 'Continue with Remaining');
      contBtn.addEventListener('click', function() {
        panel.classList.add('hidden');
        goStep(2);
        fetchEstimate(function(d) { buildPackageCards(d); });
      });
      actions.appendChild(contBtn);
    }

    loadReviewItems();

    actions.appendChild(mkEl('a', { className: 'btn btn-primary', href: 'contacts.html' }, 'View Contacts'));
    actions.appendChild(mkEl('a', { className: 'btn btn-ghost', href: 'companies.html' }, 'View Companies'));
  }

  // --- Review list ---
  function loadReviewItems() {
    var batch = $('#batch_select').value;
    if (!batch) return;

    apiFetch(API_BASE + '/enrich/review?batch_name=' + encodeURIComponent(batch) + '&stage=l1')
      .then(function(data) {
        reviewItems = data.items || [];
        updateReviewBadge();
        if (reviewItems.length > 0) renderReviewList();
      }).catch(function() {});
  }

  function updateReviewBadge() {
    var reviewContainer = document.getElementById('review_list_container');
    if (!reviewContainer) return;

    if (reviewItems.length === 0) {
      reviewContainer.classList.add('hidden');
      var pillEl = document.querySelector('[data-pill="l1"]');
      if (pillEl && pillEl.textContent === 'COMPLETED') {
        var parent = pillEl.parentNode;
        clearChildren(parent);
        parent.appendChild(mkEl('span', { className: 'completion-badge completion-badge--ok' }, '\u2713 Done'));
      }
      return;
    }

    var pillEl = document.querySelector('[data-pill="l1"]');
    if (pillEl) {
      var parent = pillEl.parentNode;
      clearChildren(parent);
      var badge = mkEl('span', { className: 'completion-badge completion-badge--review' });
      badge.textContent = reviewItems.length + ' need review';
      badge.addEventListener('click', function() { reviewContainer.classList.toggle('hidden'); });
      parent.appendChild(badge);
    }
    reviewContainer.classList.remove('hidden');
  }

  function renderReviewList() {
    var container = document.getElementById('review_list_container');
    if (!container) return;
    clearChildren(container);

    container.appendChild(mkEl('div', { className: 'card-title', style: 'margin-bottom:8px;' }, 'Companies Needing Review'));

    var list = mkEl('div', { className: 'review-list' });

    reviewItems.forEach(function(item) {
      var row = mkEl('div', { className: 'review-item' });
      row.setAttribute('data-review-id', item.id);

      row.appendChild(mkEl('div', { className: 'review-item__name' }, item.name));
      row.appendChild(mkEl('div', { className: 'review-item__domain' }, item.domain || '\u2014'));

      var flagsEl = mkEl('div', { className: 'review-item__flags' });
      (item.flags || []).forEach(function(flag) {
        var cls = 'review-flag';
        if (item.status === 'enrichment_failed') cls += ' review-flag--error';
        flagsEl.appendChild(mkEl('span', { className: cls }, flag.replace(/_/g, ' ')));
      });
      row.appendChild(flagsEl);

      var actionsEl = mkEl('div', { className: 'review-item__actions' });
      var retryBtn = mkEl('button', { className: 'btn btn-ghost btn-sm' }, 'Retry');
      retryBtn.addEventListener('click', function() { resolveItem(item.id, 'retry', row); });
      actionsEl.appendChild(retryBtn);

      if (item.status === 'needs_review') {
        var approveBtn = mkEl('button', { className: 'btn btn-success btn-sm' }, 'Approve');
        approveBtn.addEventListener('click', function() { resolveItem(item.id, 'approve', row); });
        actionsEl.appendChild(approveBtn);
      }

      row.appendChild(actionsEl);
      list.appendChild(row);
    });

    container.appendChild(list);
  }

  function resolveItem(companyId, action, rowEl) {
    var buttons = rowEl.querySelectorAll('button');
    buttons.forEach(function(b) { b.disabled = true; });

    apiFetch(API_BASE + '/enrich/resolve', {
      method: 'POST',
      body: JSON.stringify({ company_id: companyId, action: action })
    }).then(function() {
      reviewItems = reviewItems.filter(function(i) { return i.id !== companyId; });
      rowEl.style.opacity = '0.3';
      setTimeout(function() {
        rowEl.parentNode.removeChild(rowEl);
        updateReviewBadge();
      }, 300);
    }).catch(function(err) {
      buttons.forEach(function(b) { b.disabled = false; });
      alert('Failed: ' + err.message);
    });
  }

  function stopPipeline() {
    if (!currentPipelineRunId) return;
    apiFetch(API_BASE + '/pipeline/stop-all', {
      method: 'POST',
      body: JSON.stringify({ pipeline_run_id: currentPipelineRunId })
    }).then(function() {
      $('#btn_stop').disabled = true;
      $('#btn_stop').textContent = 'Stopping...';
    }).catch(function(err) {
      alert('Failed to stop: ' + err.message);
    });
  }

  // --- Event bindings ---
  function bindEvents() {
    $('#batch_select').addEventListener('change', function() {
      loadBatchStats();
      checkConfigureEnabled();
    });
    $('#owner_select').addEventListener('change', loadBatchStats);
    $('#status_select').addEventListener('change', loadBatchStats);

    // Tier chip toggles
    $$('.tier-chip').forEach(function(chip) {
      var cb = chip.querySelector('input');
      chip.addEventListener('click', function(e) {
        if (e.target.tagName === 'INPUT') return;
        cb.checked = !cb.checked;
        chip.classList.toggle('active', cb.checked);
        loadBatchStats();
      });
      cb.addEventListener('change', function() {
        chip.classList.toggle('active', cb.checked);
        loadBatchStats();
      });
    });

    $('#btn_configure').addEventListener('click', function() {
      fetchEstimate(function(data) {
        buildPackageCards(data);
        goStep(2);
      });
    });

    $('#btn_start').addEventListener('click', function() { startEnrichment(); });
    $('#btn_sample').addEventListener('click', function() { startEnrichment(10); });
    $('#btn_back_1').addEventListener('click', function() { goStep(1); });
    $('#btn_stop').addEventListener('click', stopPipeline);
  }

  // --- Init ---
  function onPageReady() {
    loadBatchesAndOwners();
    bindEvents();
  }

  function init() {
    LeadgenAuth.init(onPageReady);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>
