{
  "id": "BL-056",
  "title": "Token Credit System with Per-Namespace Budgets",
  "priority": "Must Have",
  "effort": "L",
  "status": "Spec'd",
  "sprint": "Backlog",
  "depends_on": [
    "BL-055"
  ],
  "spec": "## Token Credit System with Per-Namespace Budgets\n\n### Goal\nMeter all LLM usage per namespace using a unified credit system, with configurable budgets, enforcement modes, and admin visibility.\n\n### Credit Model\n- 1 credit = $0.001 USD of LLM usage\n- Credits computed from actual API cost (already tracked in `llm_usage_log.cost_usd`)\n- Provider-agnostic: works across Anthropic, Perplexity, and future providers\n\n### Data Model\n- `namespace_token_budgets` table: tenant_id (unique), total_budget, used_credits, reserved_credits, reset_period, enforcement_mode\n- `credits_consumed` column added to existing `llm_usage_log`\n- Three enforcement modes: monitor (log only), soft (warn + allow 120% overrun), hard (block at limit)\n\n### Budget Enforcement\n- `check_budget(tenant_id, estimated_credits)` called before every LLM operation\n- `reserve_credits()` for in-flight operations (prevents concurrent overruns)\n- `consume_credits()` after completion (moves reserved -> used)\n- Graceful degradation: complete current item, skip remaining\n\n### API Endpoints\n- `GET /api/admin/tokens` - current budget + usage breakdown (namespace admin)\n- `GET /api/admin/tokens/history` - usage over time (namespace admin)\n- `GET /api/admin/tokens/breakdown` - detailed operation + model breakdown\n- `PUT /api/admin/tokens/budget` - set budget (super admin only)\n- `POST /api/admin/tokens/topup` - add credits (super admin only)\n\n### Admin UI\n- Budget gauge (circular, color-coded by usage %)\n- Usage over time chart (daily/weekly/monthly)\n- Operation breakdown (horizontal bars)\n- Per-user consumption table\n- Persistent warning banner at 80%/100% thresholds\n\n### Acceptance Criteria\n- Given a namespace with 50K credits and 12K used, admin sees 24.7% gauge with operation breakdown\n- Given hard enforcement at 0 credits, chat returns HTTP 429 with clear message\n- Given concurrent enrichment runs, credit reservations prevent budget overruns\n- Given monthly reset, used_credits resets to 0 on the 1st\n- Given no budget configured, all LLM calls proceed without limit",
  "description": "Unified token credit system for metering all LLM usage per namespace. 1 credit = $0.001 USD. Per-namespace budgets with configurable enforcement (monitor/soft/hard). Credit reservation for concurrent operations. Admin dashboard showing usage gauge, time series, operation breakdown, and per-user consumption. Auto-reset on monthly/quarterly schedule. Integrates with existing `LlmUsageLog` infrastructure. Budget checks at all LLM call sites (chat, enrichment, generation, extraction).",
  "created": "2026-02-23",
  "updated": "2026-02-23",
  "theme": "Platform Foundation",
  "spec_file": "docs/specs/token-credit-system.md"
}